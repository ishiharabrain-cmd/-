<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨ªå•çœ‹è­·é€£æºã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .header-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .header-title {
      font-size: 20px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      margin-top: 16px;
    }
    
    .label:first-of-type { margin-top: 0; }
    
    select, input, textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
      line-height: 1.6;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      margin-top: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
      padding: 12px;
      font-size: 15px;
    }
    
    .btn-small {
      padding: 10px 16px;
      font-size: 14px;
      width: auto;
      display: inline-block;
    }
    
    .error {
      margin-top: 12px;
      padding: 12px;
      background: #ffebee;
      border-left: 4px solid #f44336;
      border-radius: 8px;
      color: #c62828;
      font-weight: 600;
      font-size: 14px;
      display: none;
    }
    
    .hidden { display: none !important; }
    
    /* æ‚£è€…ãƒªã‚¹ãƒˆ */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
    }
    
    .tag-info {
      font-weight: bold;
      color: #1976d2;
      font-size: 16px;
    }
    
    .logout-btn {
      color: #f44336;
      cursor: pointer;
      font-size: 14px;
      text-decoration: underline;
    }
    
    .patient-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .patient-card:active {
      transform: scale(0.98);
    }
    
    .patient-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }
    
    .patient-id {
      font-size: 13px;
      color: #999;
      margin-bottom: 6px;
    }
    
    .patient-info {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }
    
    .patient-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 6px;
      margin-top: 6px;
    }
    
    .patient-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    /* æ‚£è€…è©³ç´° */
    .patient-detail-header {
      text-align: center;
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 16px;
    }
    
    .patient-detail-name {
      font-size: 24px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .patient-detail-id {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    
    .detail-section {
      margin-bottom: 20px;
    }
    
    .detail-section-title {
      font-size: 14px;
      font-weight: bold;
      color: #1976d2;
      margin-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }
    
    .detail-row {
      display: flex;
      padding: 6px 0;
      font-size: 13px;
    }
    
    .detail-label {
      width: 100px;
      flex-shrink: 0;
      font-weight: 600;
      color: #666;
    }
    
    .detail-value {
      flex: 1;
      color: #333;
      word-break: break-all;
    }
    
    /* å ±å‘Šç”»é¢ */
    .section-title {
      font-size: 15px;
      font-weight: bold;
      color: #1976d2;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .scenario-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .scenario-btn {
      flex: 1;
      min-width: 90px;
      padding: 10px 8px;
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .scenario-btn.active {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1976d2;
    }
    
    /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
    .image-upload-area {
      border: 2px dashed #e0e0e0;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      margin-bottom: 12px;
    }
    
    .image-upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin: 4px;
    }
    
    .image-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .image-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
    }
    
    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ */
    .voice-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #ff6f00 0%, #ff8f00 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .voice-btn.listening {
      background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 12px;
      border-radius: 8px;
      color: #2e7d32;
      font-weight: 600;
      margin-top: 12px;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ– */
    .login-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .login-tab {
      flex: 1;
      padding: 12px;
      background: #f5f5f5;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
    }
    
    .login-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .login-form {
      display: none;
    }
    
    .login-form.active {
      display: block;
    }
    
    /* æ–‡å­—ã‚µã‚¤ã‚ºåˆ¶å¾¡ */
    body.font-small { font-size: 90%; }
    body.font-medium { font-size: 100%; }
    body.font-large { font-size: 120%; }
    
    .font-size-control {
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 12px;
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .font-size-control button {
      padding: 8px 16px;
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .font-size-control button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    /* è¨˜éŒ²è€…å½¹å‰²é¸æŠï¼ˆç¸¦ä¸¦ã³ï¼‰ */
    .role-selection {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .role-option {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #f5f5f5;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      font-weight: 600;
    }
    
    .role-option input[type="radio"] {
      margin-right: 12px;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .role-option:has(input:checked) {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1976d2;
    }
    
    /* ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .photo-modal.active {
      display: flex;
    }
    
    .photo-modal video,
    .photo-modal img {
      max-width: 90%;
      max-height: 60vh;
      border-radius: 8px;
    }
    
    .photo-controls {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .photo-controls button {
      padding: 12px 24px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* æ™‚é–“ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .time-dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .time-dialog-overlay.active {
      display: flex;
    }
    
    .time-dialog {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .time-dialog h3 {
      margin-bottom: 20px;
      color: #1976d2;
      text-align: center;
    }
    
    .time-input-group {
      margin-bottom: 16px;
    }
    
    .time-input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #555;
    }
    
    .time-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .time-dialog-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .time-dialog-buttons button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .time-dialog-buttons .btn-confirm {
      background: #4caf50;
      color: white;
    }
    
    .time-dialog-buttons .btn-cancel {
      background: #f5f5f5;
      color: #666;
    }
    
    /* ã‚¯ã‚¤ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .quick-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #4caf50;
      color: white;
      padding: 20px 40px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      animation: fadeInOut 2s ease-in-out;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      10%, 90% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- 1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="card">
      <div class="header">
        <div class="header-icon">ğŸ¥</div>
        <div class="header-title">è¨ªå•çœ‹è­·é€£æºã‚·ã‚¹ãƒ†ãƒ </div>
      </div>
      
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ– -->
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchLoginTab('staff')">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•</button>
        <button class="login-tab" onclick="switchLoginTab('patient')">ğŸ‘¤ æ‚£è€…ID</button>
      </div>
      
      <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³ -->
      <div id="staffLoginForm" class="login-form active">
        <label class="label">â‘  ã‚ãªãŸã®ã‚¿ã‚°ã‚’å…¥åŠ›</label>
        <input type="text" id="tagInput" placeholder="ä¾‹: è¨ªå•çœ‹è­·A" autocomplete="off" onkeypress="if(event.key==='Enter'){document.getElementById('passwordInput').focus()}">
        <div style="font-size: 12px; color: #999; margin-top: 4px;">
          â€»æ¼¢å­—ãƒ»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã§æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„
        </div>
        
        <label class="label">â‘¡ ã‚¿ã‚°ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" onkeypress="if(event.key==='Enter'){handleStaffLogin()}">
        
        <button class="btn" id="loginBtn" onclick="handleStaffLogin()">ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      
      <!-- æ‚£è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
      <div id="patientLoginForm" class="login-form">
        <label class="label">â‘  æ‚£è€…ç•ªå·ï¼ˆæ‚£è€…IDï¼‰</label>
        <input type="text" id="patientIdInput" placeholder="ä¾‹: 001" autocomplete="off" onkeypress="if(event.key==='Enter'){document.getElementById('birthdateInput').focus()}">
        <div style="font-size: 12px; color: #999; margin-top: 4px;">
          â€»ã‚«ãƒ«ãƒ†ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ‚£è€…ç•ªå·ã‚’å…¥åŠ›
        </div>
        
        <label class="label">â‘¡ èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
        <input type="password" id="birthdateInput" placeholder="ä¾‹: 1950" inputmode="numeric" maxlength="4" pattern="\d{4}" onkeypress="if(event.key==='Enter'){handlePatientLogin()}">
        <div style="font-size: 12px; color: #999; margin-top: 4px;">
          â€»æŒ‡å®šã•ã‚ŒãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›
        </div>
        
        <button class="btn" id="patientLoginBtn" onclick="handlePatientLogin()">ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      
      <div id="errorBox" class="error"></div>
    </div>
    
    <!-- 2. æ‚£è€…ãƒªã‚¹ãƒˆç”»é¢ -->
    <div id="patientListScreen" class="hidden">
      <div class="font-size-control">
        <button onclick="changeFontSize('small')" id="fontBtnSmall">Aâ»</button>
        <button onclick="changeFontSize('medium')" id="fontBtnMedium" class="active">A</button>
        <button onclick="changeFontSize('large')" id="fontBtnLarge">Aâº</button>
      </div>
      
      <div class="top-bar">
        <div class="tag-info" id="tagInfo">ğŸ‘¤ ã‚¿ã‚°å</div>
        <div class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
      </div>
      
      <div id="patientList"></div>
    </div>
    
    <!-- 3. æ‚£è€…è©³ç´°ç”»é¢ -->
    <div id="patientDetailScreen" class="hidden">
      <div class="font-size-control">
        <button onclick="changeFontSize('small')" id="fontBtnSmall2">Aâ»</button>
        <button onclick="changeFontSize('medium')" id="fontBtnMedium2" class="active">A</button>
        <button onclick="changeFontSize('large')" id="fontBtnLarge2">Aâº</button>
      </div>
      
      <div class="card">
        <div class="patient-detail-header">
          <div class="patient-detail-name" id="detailPatientName">æ‚£è€…å</div>
          <div class="patient-detail-id" id="detailPatientId">ID: 0000</div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
          <div id="detailBasicInfo"></div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">ğŸ¥ åŒ»ç™‚æƒ…å ±</div>
          <div id="detailMedicalInfo"></div>
        </div>
        
        <div class="detail-section">
          <div class="detail-section-title">ğŸ“ å‚™è€ƒ</div>
          <div id="detailNotes"></div>
        </div>
        
        <button class="btn" onclick="openReportFromDetail()">ğŸ“ å ±å‘Šã™ã‚‹</button>
        <button class="btn btn-secondary" id="backToListBtn" onclick="backToPatientList()">â† æ‚£è€…ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</button>
      </div>
    </div>
    
    <!-- 4. å ±å‘Šå…¥åŠ›ç”»é¢ -->
    <div id="reportScreen" class="hidden">
      <div class="font-size-control">
        <button onclick="changeFontSize('small')" id="fontBtnSmall3">Aâ»</button>
        <button onclick="changeFontSize('medium')" id="fontBtnMedium3" class="active">A</button>
        <button onclick="changeFontSize('large')" id="fontBtnLarge3">Aâº</button>
      </div>
      
      <div class="card">
        <div class="patient-detail-header">
          <div class="patient-detail-name" id="reportPatientName">æ‚£è€…å</div>
          <div class="patient-detail-id" id="reportPatientInfo">ID: 0000</div>
        </div>
        
        <!-- AIç”Ÿæˆã®çµŒéã‚µãƒãƒªãƒ¼ -->
        <div id="summaryContainer" style="background: #f0f7ff; border-left: 4px solid #2196F3; padding: 12px; border-radius: 4px; margin: 16px 0;">
          <div style="font-size: 11px; color: #2196F3; font-weight: bold; margin-bottom: 5px;">
            ğŸ“‹ ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§è¦ç´„
          </div>
          <div style="font-size: 10px; color: #999; margin-bottom: 8px;">
            é–“é•ã£ã¦ã„ã‚‹å ´åˆã¯ã”é€£çµ¡ãã ã•ã„ 
            <button onclick="sendCorrectionEmail()" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; margin-left: 4px;">
              âœ‰ï¸ ishihara.brain@gmail.com
            </button>
          </div>
          <div id="patientSummaryDisplay" style="font-size: 14px; color: #444; line-height: 1.5; white-space: pre-wrap;">
            èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>
        
        <!-- éå»ã®è¨˜éŒ²ã‚µãƒãƒªãƒ¼ -->
        <div id="historySummary" style="display:none; margin: 16px 0; padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
          <div style="font-weight: bold; margin-bottom: 8px; color: #2e7d32;">ğŸ“š éå»ã®è¨˜éŒ²</div>
          <div id="historyContent" style="font-size: 13px; line-height: 1.6;"></div>
        </div>
        
        <div id="scenarioSection">
          <div class="section-title">ğŸ“ ã‚·ãƒŠãƒªã‚ªé¸æŠ</div>
          <div class="scenario-group">
            <button class="scenario-btn" onclick="selectScenario(this, 'ç™ºç†±ã‚ã‚Š')">â‘  ç™ºç†±</button>
            <button class="scenario-btn" onclick="selectScenario(this, 'è»¢å€’ãƒ»æ€ªæˆ‘')">â‘¡ è»¢å€’</button>
            <button class="scenario-btn" onclick="selectScenario(this, 'ç‰¹æŒ‡ç¤º')">â‘¢ ç‰¹æŒ‡ç¤º</button>
            <button class="scenario-btn" onclick="selectScenario(this, 'ãã®ä»–')">â‘£ ãã®ä»–</button>
          </div>
        </div>
        
        <!-- ã‚·ãƒŠãƒªã‚ªåˆ¥ãƒã‚§ãƒƒã‚¯é …ç›® -->
        <div id="scenarioChecklist" style="display:none; margin: 16px 0; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
          <div style="font-weight: bold; margin-bottom: 8px; color: #e65100;">ğŸ“‹ ç¢ºèªé …ç›®</div>
          <div id="checklistItems"></div>
        </div>
        
        <!-- ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="tokushijiTemplate" style="display:none; margin: 16px 0; padding: 16px; background: #fce4ec; border-radius: 10px; border-left: 4px solid #e91e63;">
          <div style="font-weight: bold; margin-bottom: 12px; color: #c2185b; font-size: 15px;">ğŸ¥ ç‰¹åˆ¥æŒ‡ç¤ºæ›¸ ä¾é ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
          <div style="font-size: 11px; color: #888; margin-bottom: 12px;">å¿…è¦ãªé …ç›®ã ã‘å…¥åŠ›ã—ã¦ã€Œãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ç©ºæ¬„ã®é …ç›®ã¯çœç•¥ã•ã‚Œã¾ã™ã€‚</div>
          
          <!-- çŠ¶æ³ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">çŠ¶æ³</label>
            <select id="tokuStatus" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px; margin-top:4px;">
              <option value="è¨ªå•ä¸­">è¨ªå•ä¸­</option>
              <option value="è¨ªå•å¾Œ">è¨ªå•å¾Œ</option>
              <option value="é›»è©±é€£çµ¡">é›»è©±é€£çµ¡</option>
            </select>
          </div>
          
          <!-- ç‰¹æŒ‡ç¤ºã®è¦ä»¶ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">ç‰¹æŒ‡ç¤ºã®è¦ä»¶</label>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
              <label style="padding:6px 12px; background:white; border:2px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="tokuReasonJokuso" style="margin-right:4px;" onchange="toggleJokuso()"> è¤¥ç˜¡
              </label>
              <label style="padding:6px 12px; background:white; border:2px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="tokuReasonHatsunetsu" style="margin-right:4px;"> ç™ºç†±
              </label>
              <label style="padding:6px 12px; background:white; border:2px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="tokuReasonDassui" style="margin-right:4px;"> è„±æ°´
              </label>
              <input type="text" id="tokuReasonOther" placeholder="ãã®ä»–" style="padding:6px 10px; border:2px solid #ddd; border-radius:6px; font-size:13px; width:120px;">
            </div>
          </div>
          
          <!-- è¤¥ç˜¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div id="jokusoSection" style="display:none; margin: 12px 0; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="font-weight: bold; margin-bottom: 8px; color: #e91e63; font-size: 13px;">è¤¥ç˜¡æƒ…å ±</div>
            
            <div style="margin-bottom: 8px;">
              <label style="font-size: 12px; color: #555;">éƒ¨ä½</label>
              <input type="text" id="jokusoSite" placeholder="ä¾‹: ä»™éª¨éƒ¨" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
            </div>
            
            <div style="font-weight: bold; font-size: 12px; color: #555; margin-bottom: 4px;">DESIGN-R è©•ä¾¡</div>
            <div style="margin-bottom: 6px;">
              <label style="font-size: 12px; color: #555;">è©•ä¾¡æ—¥</label>
              <input type="text" id="designrDate" placeholder="ä¾‹: 2/15" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom: 8px;">
              <div>
                <label style="font-size:11px; color:#555;">D(æ·±ã•)</label>
                <select id="designD" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="d0">d0</option><option value="d1">d1</option><option value="d2">d2</option>
                  <option value="D3">D3</option><option value="D4">D4</option><option value="D5">D5</option>
                  <option value="DDTI">DDTI</option><option value="DU">DU</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">e(æ»²å‡ºæ¶²)</label>
                <select id="designE" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">e0 (0)</option><option value="1">e1 (1)</option>
                  <option value="3">e3 (3)</option><option value="6">E6 (6)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">s(å¤§ãã•)</label>
                <select id="designS" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">s0 (0)</option><option value="3">s3 (3)</option><option value="6">s6 (6)</option>
                  <option value="8">s8 (8)</option><option value="9">s9 (9)</option><option value="12">s12 (12)</option>
                  <option value="15">S15 (15)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">i(ç‚ç—‡/æ„ŸæŸ“)</label>
                <select id="designI" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">i0 (0)</option><option value="1">i1 (1)</option>
                  <option value="3">I3C (3)</option><option value="3">I3 (3)</option><option value="9">I9 (9)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">g(è‚‰èŠ½çµ„ç¹”)</label>
                <select id="designG" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">g0 (0)</option><option value="1">g1 (1)</option><option value="3">g3 (3)</option>
                  <option value="4">G4 (4)</option><option value="5">G5 (5)</option><option value="6">G6 (6)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">n(å£Šæ­»çµ„ç¹”)</label>
                <select id="designN" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">n0 (0)</option><option value="3">N3 (3)</option><option value="6">N6 (6)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">P(ãƒã‚±ãƒƒãƒˆ)</label>
                <select id="designP" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="calcDesignR()">
                  <option value="0">p0 (0)</option><option value="6">P6 (6)</option><option value="9">P9 (9)</option>
                  <option value="12">P12 (12)</option><option value="24">P24 (24)</option>
                </select>
              </div>
            </div>
            
            <div id="designrResult" style="padding:8px; background:#fff3e0; border-radius:6px; font-size:13px; font-weight:bold; color:#e65100;">
              åˆè¨ˆ: 0ç‚¹ | åˆ¤å®š: çœŸçš®æå‚·ä»¥å†…
            </div>
            <div style="margin-top:4px;">
              <a href="https://www.almediaweb.jp/pressureulcer/maruwakari/part3/04.html" target="_blank" style="font-size:10px; color:#2196f3;">å‚è€ƒ: DESIGN-R 2020 ç‚¹æ•°ã®ä»˜ã‘æ–¹</a>
            </div>
          </div>
          
          <!-- å¤–ç”¨è–¬ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">å¤–ç”¨è–¬</label>
            <div id="ointmentRows" style="margin-top:4px;">
              <div style="display:flex; gap:4px; margin-bottom:4px;">
                <input type="text" class="ointSite" placeholder="éƒ¨ä½" style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                <input type="text" class="ointName" placeholder="è–¬å‰¤å" style="flex:2; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
              </div>
              <div style="display:flex; gap:4px; margin-bottom:4px;">
                <input type="text" class="ointSite" placeholder="éƒ¨ä½" style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                <input type="text" class="ointName" placeholder="è–¬å‰¤å" style="flex:2; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
              </div>
            </div>
          </div>
          
          <!-- å‡¦ç½®å†…å®¹ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">å‡¦ç½®å†…å®¹</label>
            <textarea id="tokuTreatment" placeholder="ä¾‹: ã‚ªãƒ ãƒ„äº¤æ›ã€è¤¥ç˜¡å‡¦ç½®" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; min-height:40px; box-sizing:border-box; font-family:inherit;"></textarea>
          </div>
          
          <!-- WOCãƒŠãƒ¼ã‚¹ -->
          <div style="margin-bottom: 10px;">
            <label style="padding:6px 0; cursor:pointer; font-size:13px;">
              <input type="checkbox" id="tokuWoc" style="margin-right:6px;" onchange="document.getElementById('wocDetail').style.display=this.checked?'block':'none'"> WOCãƒŠãƒ¼ã‚¹ã®ä»‹å…¥ã‚ã‚Š
            </label>
            <div id="wocDetail" style="display:none; margin-top:4px;">
              <input type="text" id="tokuWocDate" placeholder="ä¾‹: 2æœˆ16æ—¥ï¼ˆæœˆï¼‰15æ™‚é ƒ" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
            </div>
          </div>
          
          <!-- æ·»ä»˜ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">æ·»ä»˜</label>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
              <label style="padding:4px 8px; background:white; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-size:12px;">
                <input type="checkbox" id="tokuAttachPhoto" style="margin-right:4px;"> è¤¥ç˜¡å†™çœŸ
              </label>
              <label style="padding:4px 8px; background:white; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-size:12px;">
                <input type="checkbox" id="tokuAttachDesignR" style="margin-right:4px;"> DESIGN-Rè©•ä¾¡
              </label>
              <label style="padding:4px 8px; background:white; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-size:12px;">
                <input type="checkbox" id="tokuAttachInout" style="margin-right:4px;"> inoutè¡¨
              </label>
            </div>
          </div>
          
          <!-- ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ -->
          <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ï¼ˆVSï¼‰</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px;">
              <div>
                <label style="font-size:11px; color:#555;">ä½“æ¸©</label>
                <div style="display:flex; align-items:center;">
                  <input type="text" id="tokuBT" placeholder="36.0" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <span style="margin-left:4px; font-size:12px;">â„ƒ</span>
                </div>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">è¡€åœ§</label>
                <div style="display:flex; align-items:center;">
                  <input type="text" id="tokuBPH" placeholder="120" style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <span style="margin:0 2px;">/</span>
                  <input type="text" id="tokuBPL" placeholder="80" style="width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <span style="margin-left:2px; font-size:11px;">mmHg</span>
                </div>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">è„ˆæ‹</label>
                <div style="display:flex; align-items:center;">
                  <input type="text" id="tokuPulse" placeholder="78" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <select id="tokuPulseType" style="margin-left:4px; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:11px;">
                    <option value="æ•´">æ•´</option><option value="ä¸æ•´">ä¸æ•´</option>
                  </select>
                </div>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">SpO2</label>
                <div style="display:flex; align-items:center;">
                  <input type="text" id="tokuSpO2" placeholder="98" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <span style="margin-left:4px; font-size:12px;">%</span>
                </div>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">å‘¼å¸å›æ•°</label>
                <div style="display:flex; align-items:center;">
                  <input type="text" id="tokuRR" placeholder="20" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                  <span style="margin-left:4px; font-size:12px;">å›</span>
                </div>
              </div>
              <div>
                <label style="font-size:11px; color:#555;">æœ€çµ‚æ’ä¾¿</label>
                <input type="text" id="tokuLastBM" placeholder="ä¾‹: 2/14" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
              </div>
            </div>
          </div>
          
          <!-- çŠ¶æ…‹ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">çŠ¶æ…‹ï¼ˆæ‚£è€…ã®ç™ºè¨€ãƒ»æ§˜å­ï¼‰</label>
            <textarea id="tokuCondition" placeholder="ä¾‹: å–‰ä¹¾ã„ãŸã€‚ãƒ¤ã‚¯ãƒ«ãƒˆä¸‹ã•ã„" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; min-height:40px; box-sizing:border-box; font-family:inherit;"></textarea>
          </div>
          
          <!-- è¡Œã£ãŸå¯¾å¿œ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">è¡Œã£ãŸå¯¾å¿œ</label>
            <textarea id="tokuAction" placeholder="ä¾‹: ã‚ªãƒ ãƒ„äº¤æ›ã€è¤¥ç˜¡å‡¦ç½®" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; min-height:40px; box-sizing:border-box; font-family:inherit;"></textarea>
          </div>
          
          <!-- è¿”é›»é€£çµ¡å…ˆ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">è¿”é›»é€£çµ¡å…ˆé›»è©±ç•ªå·</label>
            <input type="tel" id="tokuPhone" placeholder="ä¾‹: 070-4519-5641" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
          </div>
          
          <!-- æ˜æ—¥ã®è¨ªçœ‹ä»‹å…¥ -->
          <div style="margin-bottom: 10px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">æ˜æ—¥ã®è¨ªçœ‹ä»‹å…¥</label>
            <textarea id="tokuTomorrow" placeholder="ä¾‹: 11æ™‚ã‹ã‚‰æ­¯ç§‘å¾€è¨ºã€15æ™‚é ƒã‹ã‚‰WOCå¾€è¨º" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; min-height:40px; box-sizing:border-box; font-family:inherit;"></textarea>
          </div>
          
          <!-- è–¬å±€ã¸ -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: bold; color: #555;">è–¬å±€ã¸ã®é€£çµ¡</label>
            <textarea id="tokuPharmacy" placeholder="ä¾‹: ãƒ‘ãƒ¼ãƒŸãƒ­ãƒ¼ãƒ«æ®‹ã¯æ²¢å±±ã‚ã‚Šè£œå……ä¸è¦" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:13px; min-height:40px; box-sizing:border-box; font-family:inherit;"></textarea>
          </div>
          
          <!-- ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ãƒœã‚¿ãƒ³ -->
          <button onclick="applyTokushijiTemplate()" style="width:100%; padding:14px; background:linear-gradient(135deg, #e91e63, #f06292); color:white; border:none; border-radius:10px; font-size:15px; font-weight:bold; cursor:pointer; box-shadow:0 2px 8px rgba(233,30,99,0.3);">
            ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ï¼ˆä¿®æ­£å¯èƒ½ï¼‰
          </button>
        </div>
        
        <div class="section-title">ğŸ‘¤ è¨˜éŒ²è€…åï¼ˆå¿…é ˆï¼‰</div>
        <input type="text" id="reporterName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px;">
        
        <div class="section-title">ğŸ‘¤ è¨˜éŒ²è€…ã®å½¹å‰²</div>
        <div class="role-selection">
          <label class="role-option">
            <input type="radio" name="reporterRole" value="nurse" checked onchange="toggleReportMode()">
            <span>ğŸ‘©â€âš•ï¸ çœ‹è­·å¸«ãƒ»ã‚¹ã‚¿ãƒƒãƒ•</span>
          </label>
          <label class="role-option">
            <input type="radio" name="reporterRole" value="doctor" onchange="toggleReportMode()">
            <span>ğŸ‘¨â€âš•ï¸ åŒ»å¸«</span>
          </label>
        </div>
        
        <div id="urgentAlertBox" style="margin: 16px 0; padding: 15px; background: #fff3f3; border: 2px solid #ffcdd2; border-radius: 10px;">
          <label style="display: flex; align-items: center; cursor: pointer; color: #d32f2f; font-weight: bold;">
            <input type="checkbox" id="urgentAlertCheckbox" style="margin-right: 10px; width: 22px; height: 22px;">
            <span id="urgentAlertLabel">ğŸš€ åŒ»å¸«ã¸ä»Šã™ããƒ¡ãƒ¼ãƒ«</span>
          </label>
          <div id="urgentAlertDescription" style="font-size: 11px; color: #666; margin-top: 5px; margin-left: 32px;">
            â€»ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€AIè¦ç´„ã‚’å¾…ãŸãšã«ã“ã®å†…å®¹ãŒç›´æ¥åŒ»å¸«ã®ãƒ¡ãƒ¼ãƒ«ã«å±Šãã¾ã™ã€‚ç·Šæ€¥ã®å ´åˆã¯é›»è©±é€£çµ¡ã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚
          </div>
        </div>
        
        <div class="section-title content-label">âœï¸ å ±å‘Šå†…å®¹</div>
        <textarea id="reportInput" placeholder="ã“ã“ã«å…¥åŠ›...&#10;&#10;ä¾‹: BT37.8â„ƒã€SpO2 96%&#10;ç™ºç†±ã‚ã‚Šé£Ÿæ¬²ä½ä¸‹(1/2)&#10;æ°´åˆ†æ‘‚å–ã¯å¯"></textarea>
        
        <button class="voice-btn" id="voiceBtn" onclick="startVoiceInput()">
          <span id="voiceBtnIcon">ğŸ¤</span>
          <span id="voiceBtnText">éŸ³å£°ã§å…¥åŠ›ï¼ˆPCç”¨ï¼‰</span>
        </button>
        
        <div style="margin: 8px 0; font-size: 11px; color: #666;">
          ğŸ“± ã‚¹ãƒãƒ›ã®æ–¹ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„
        </div>
        
        <div class="section-title" style="margin-top: 20px;">ğŸ™ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜</div>
        <input type="file" id="audioInput" accept="audio/*" style="display:none" onchange="handleAudioSelect(this)">
        <button class="image-btn" onclick="document.getElementById('audioInput').click()">
          ğŸ™ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </button>
        <div id="audioPreview" style="margin-top: 8px;"></div>
        
        <div class="section-title" style="margin-top: 20px;">ğŸ“¸ å†™çœŸã‚’è¿½åŠ </div>
        <div class="image-upload-area">
          <input type="file" id="galleryInput" accept="image/*" multiple style="display:none" onchange="handleImageSelect(this, 'gallery')">
          
          <button class="image-upload-btn" onclick="takePhoto()">
            ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±
          </button>
          <button class="image-upload-btn" onclick="document.getElementById('galleryInput').click()">
            ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ
          </button>
          
          <div style="margin: 12px 0;">
            <label style="display: inline-flex; align-items: center; font-size: 13px; color: #555; cursor: pointer;">
              <input type="checkbox" id="ocrCheckbox" style="margin-right: 6px; width: 16px; height: 16px;">
              ğŸ“ ç”»åƒã®æ–‡å­—ã‚’èª­ã¿å–ã‚‹ï¼ˆå‡¦æ–¹ç®‹ãƒ»ãƒ¡ãƒ¢ãªã©ï¼‰
            </label>
          </div>
          
          <div class="image-preview" id="imagePreview"></div>
        </div>
        
        <button class="btn" id="sendBtn" onclick="handleSendReport()">ğŸ“¤ é€ä¿¡</button>
        
        <div id="successMessage" class="success hidden">
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">
            âœ… å ±å‘Šã‚’å—ã‘å–ã‚Šã¾ã—ãŸ
          </div>
          <div style="font-size: 14px; color: #2e7d32;">
            ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ç¢ºèªã„ãŸã—ã¾ã™ã€‚
          </div>
          <div style="font-size: 11px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">
            âš ï¸ ç·Šæ€¥ã§åŒ»å¸«ã®åˆ¤æ–­ãŒå¿…è¦ãªå ´åˆã¯ã€ãŠé›»è©±ã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚
          </div>
          <button id="backFromSuccessBtn" onclick="backToPatientList()" style="margin-top: 12px; padding: 8px 16px; background: #fff; border: 1px solid #4caf50; border-radius: 6px; color: #4caf50; cursor: pointer; font-size: 14px;">
            â† æ‚£è€…ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
          </button>
        </div>
        
        <button class="btn btn-secondary" onclick="backToDetailFromReport()" style="margin-top: 16px;">
          â† æ‚£è€…è©³ç´°ã«æˆ»ã‚‹
        </button>
      </div>
    </div>
    
  </div>
  
  <script>
    var currentTag = "";
    var currentPatient = null;
    var selectedScenario = "";
    var selectedImages = [];
    var recognition = null;
    var visitStartTime = null;
    var stream = null;
    var capturedImageData = null;
    var timeConfirmCallback = null;
    
    window.onload = function() {
      document.getElementById('tagInput').focus();
      
      // ä¿å­˜ã•ã‚ŒãŸæ–‡å­—ã‚µã‚¤ã‚ºã‚’é©ç”¨
      var savedSize = localStorage.getItem('fontSize') || 'medium';
      applyFontSize(savedSize);
    };
    
    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
    function switchLoginTab(type) {
      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      var tabs = document.querySelectorAll('.login-tab');
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('staffLoginForm').classList.remove('active');
      document.getElementById('patientLoginForm').classList.remove('active');
      
      if (type === 'staff') {
        document.getElementById('staffLoginForm').classList.add('active');
        setTimeout(function() { document.getElementById('tagInput').focus(); }, 100);
      } else {
        document.getElementById('patientLoginForm').classList.add('active');
        setTimeout(function() { document.getElementById('patientIdInput').focus(); }, 100);
      }
      
      hideError();
    }
    
    // æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´
    function changeFontSize(size) {
      applyFontSize(size);
      localStorage.setItem('fontSize', size);
    }
    
    function applyFontSize(size) {
      document.body.className = document.body.className.replace(/font-(small|medium|large)/g, '');
      document.body.classList.add('font-' + size);
      
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.font-size-control button').forEach(function(btn) {
        btn.classList.remove('active');
      });
      
      var btnIds = ['fontBtnSmall', 'fontBtnMedium', 'fontBtnLarge',
                    'fontBtnSmall2', 'fontBtnMedium2', 'fontBtnLarge2',
                    'fontBtnSmall3', 'fontBtnMedium3', 'fontBtnLarge3'];
      
      btnIds.forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn && btn.onclick && btn.onclick.toString().includes("'" + size + "'")) {
          btn.classList.add('active');
        }
      });
    }
    
    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³
    function handleStaffLogin() {
      var tag = document.getElementById('tagInput').value.trim();
      var password = document.getElementById('passwordInput').value;
      
      hideError();
      
      if (!tag) {
        showError("ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      if (!password) {
        showError("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      var btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = "ğŸ” èªè¨¼ä¸­...";
      
      google.script.run
        .withSuccessHandler(onStaffLoginSuccess)
        .withFailureHandler(onLoginFailure)
        .authenticateTag(tag, password);
    }
    
    // æ‚£è€…ãƒ­ã‚°ã‚¤ãƒ³
    function handlePatientLogin() {
      var patientId = document.getElementById('patientIdInput').value.trim();
      var birthdate = document.getElementById('birthdateInput').value.trim();
      
      hideError();
      
      if (!patientId) {
        showError("æ‚£è€…ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      if (!birthdate) {
        showError("èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      // 4æ¡ã®æ•°å­—ãƒã‚§ãƒƒã‚¯
      if (!/^\d{4}$/.test(birthdate)) {
        showError("èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1950ï¼‰");
        return;
      }
      
      // å¹´ã¨ã—ã¦å¦¥å½“ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ1900ã€œ2100ï¼‰
      var year = parseInt(birthdate);
      if (year < 1900 || year > 2100) {
        showError("èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      
      var btn = document.getElementById('patientLoginBtn');
      btn.disabled = true;
      btn.textContent = "ğŸ” èªè¨¼ä¸­...";
      
      google.script.run
        .withSuccessHandler(onPatientLoginSuccess)
        .withFailureHandler(onLoginFailure)
        .authenticatePatient(patientId, birthdate);
    }
    
    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    function onStaffLoginSuccess(res) {
      var btn = document.getElementById('loginBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³";
      
      if (res && res.success) {
        currentTag = res.tag;
        document.getElementById('tagInfo').textContent = 'ğŸ‘¤ ' + currentTag;
        
        showScreen('patientListScreen');
        loadPatientList();
      } else {
        showError(res.msg || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }
    
    // æ‚£è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    function onPatientLoginSuccess(res) {
      console.log("ğŸ” æ‚£è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹:", res);
      
      var btn = document.getElementById('patientLoginBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³";
      
      if (res && res.success && res.patient) {
        console.log("âœ… æ‚£è€…ãƒ‡ãƒ¼ã‚¿:", res.patient);
        
        currentTag = "æ‚£è€…æœ¬äºº";
        currentPatient = {
          id: res.patient.id,
          name: res.patient.name,
          birthdate: res.patient.birthdate || "",
          address: res.patient.address || "",
          phone: res.patient.phone || "",
          doctor: res.patient.doctor || "",
          pharmacy: res.patient.pharmacy || "",
          careLevel: res.patient.careLevel || "",
          note: res.patient.note || ""
        };
        
        console.log("ğŸ“‹ currentPatientè¨­å®šå®Œäº†:", currentPatient);
        
        // ç›´æ¥æ‚£è€…è©³ç´°ç”»é¢ã¸
        document.getElementById('tagInfo').textContent = 'ğŸ‘¤ æ‚£è€…æœ¬äºº';
        
        console.log("ğŸš€ æ‚£è€…è©³ç´°ç”»é¢ã¸é·ç§»: ID=" + currentPatient.id);
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éè¡¨ç¤º
        document.getElementById('loginScreen').classList.add('hidden');
        
        // æ‚£è€…è©³ç´°ç”»é¢ã¸ç›´æ¥é·ç§»
        showPatientDetail(currentPatient.id);
      } else {
        console.error("âŒ èªè¨¼å¤±æ•—ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³:", res);
        showError(res.msg || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }
    
    function onLoginFailure(error) {
      var btn = document.getElementById('loginBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³";
      showError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (error.message || error));
    }
    
    function loadPatientList() {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success && res.patients) {
            var container = document.getElementById('patientList');
            container.innerHTML = '';
            
            if (res.patients.length === 0) {
              container.innerHTML = '<div class="card"><p style="text-align:center;color:#999;">ã“ã®ã‚¿ã‚°ã«æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
              return;
            }
            
            res.patients.forEach(function(p) {
              var card = document.createElement('div');
              card.className = 'patient-card';
              card.onclick = function() { showPatientDetail(p.id); };
              
              var badges = '';
              if (p.careLevel) badges += '<span class="patient-badge">' + p.careLevel + '</span>';
              if (p.hokanSt) badges += '<span class="patient-badge">' + p.hokanSt + '</span>';
              if (p.status) badges += '<span class="patient-badge">' + p.status + '</span>';
              
              card.innerHTML = 
                '<div class="patient-name">' + p.name + '</div>' +
                '<div class="patient-id">ID: ' + p.id + '</div>' +
                '<div class="patient-info">' + 
                (p.address || '') + '<br>' +
                (p.kana || '') +
                '</div>' +
                badges +
                '<div class="patient-actions">' +
                '<button class="btn btn-small" onclick="event.stopPropagation(); openReportScreen(\'' + p.id + '\')">å ±å‘Šã™ã‚‹</button>' +
                '</div>';
              container.appendChild(card);
            });
          }
        })
        .getPatientsByTag(currentTag);
    }
    
    function showPatientDetail(patientId) {
      // é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
      visitStartTime = new Date();
      
      google.script.run
        .withSuccessHandler(function(res) {
          console.log("ğŸ“‹ getPatientDetailæˆåŠŸ:", res);
          if (res && res.success && res.patient) {
            currentPatient = res.patient;
            
            document.getElementById('detailPatientName').textContent = res.patient.name;
            document.getElementById('detailPatientId').textContent = 'ID: ' + res.patient.id;
            
            // åŸºæœ¬æƒ…å ±
            var basicHtml = '';
            if (res.patient.kana) basicHtml += makeDetailRow('ã‚«ãƒŠ', res.patient.kana);
            if (res.patient.dob) basicHtml += makeDetailRow('ç”Ÿå¹´æœˆæ—¥', res.patient.dob);
            if (res.patient.gender) basicHtml += makeDetailRow('æ€§åˆ¥', res.patient.gender);
            if (res.patient.address) basicHtml += makeDetailRow('ä½æ‰€', res.patient.address + (res.patient.addressNote ? ' ' + res.patient.addressNote : ''));
            if (res.patient.tel) basicHtml += makeDetailRow('é›»è©±', res.patient.tel);
            if (res.patient.email) basicHtml += makeDetailRow('ãƒ¡ãƒ¼ãƒ«', res.patient.email);
            document.getElementById('detailBasicInfo').innerHTML = basicHtml || '<p style="color:#999;">æƒ…å ±ãªã—</p>';
            
            // åŒ»ç™‚æƒ…å ±
            var medicalHtml = '';
            if (res.patient.careLevel) medicalHtml += makeDetailRow('è¦ä»‹è­·åº¦', res.patient.careLevel);
            if (res.patient.doctor) medicalHtml += makeDetailRow('ä¸»æ²»åŒ»', res.patient.doctor);
            if (res.patient.careManager) medicalHtml += makeDetailRow('ã‚±ã‚¢ãƒãƒ', res.patient.careManager);
            if (res.patient.hokanSt) medicalHtml += makeDetailRow('è¨ªçœ‹ST', res.patient.hokanSt);
            if (res.patient.shijiType) medicalHtml += makeDetailRow('æŒ‡ç¤ºæ›¸', res.patient.shijiType);
            if (res.patient.pharmacy) medicalHtml += makeDetailRow('è–¬å±€', res.patient.pharmacy);
            if (res.patient.lastVisit) medicalHtml += makeDetailRow('æœ€çµ‚è¨ºç™‚', res.patient.lastVisit);
            document.getElementById('detailMedicalInfo').innerHTML = medicalHtml || '<p style="color:#999;">æƒ…å ±ãªã—</p>';
            
            // å‚™è€ƒ
            var notesHtml = '';
            if (res.patient.note) notesHtml += '<div style="margin-bottom:10px;"><strong>æ‚£è€…å‚™è€ƒ:</strong><br>' + res.patient.note.replace(/\n/g, '<br>') + '</div>';
            if (res.patient.note2) notesHtml += '<div><strong>æ‚£è€…å‚™è€ƒï¼’:</strong><br>' + res.patient.note2.replace(/\n/g, '<br>') + '</div>';
            document.getElementById('detailNotes').innerHTML = notesHtml || '<p style="color:#999;">å‚™è€ƒãªã—</p>';
            
            showScreen('patientDetailScreen');
            
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‚£è€…æœ¬äººãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯å¤‰æ›´
            var backBtn = document.getElementById('backToListBtn');
            if (currentTag === "æ‚£è€…æœ¬äºº") {
              backBtn.textContent = "â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ";
            } else {
              backBtn.textContent = "â† æ‚£è€…ãƒªã‚¹ãƒˆã«æˆ»ã‚‹";
            }
            
            // éå»ã®è¨˜éŒ²ã‚’å–å¾—
            loadPatientHistory(patientId);
          } else {
            console.error("âŒ æ‚£è€…è©³ç´°å–å¾—å¤±æ•—:", res);
            alert("æ‚£è€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (res ? res.msg : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
          }
        })
        .withFailureHandler(function(error) {
          console.error("âŒ getPatientDetailã‚¨ãƒ©ãƒ¼:", error);
          alert("ã‚¨ãƒ©ãƒ¼: " + error.message);
        })
        .getPatientDetail(patientId, currentTag);
    }
    
    // éå»ã®è¨˜éŒ²ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    var allHistoryRecords = []; // å…¨ä»¶ä¿æŒ
    var historyDisplayCount = 5; // åˆæœŸè¡¨ç¤ºä»¶æ•°
    
    function loadPatientHistory(patientId) {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success && res.history) {
            allHistoryRecords = res.history;
            historyDisplayCount = 5; // ãƒªã‚»ãƒƒãƒˆ
            displayHistory(allHistoryRecords, historyDisplayCount);
          }
        })
        .withFailureHandler(function(err) {
          console.log('éå»ã®è¨˜éŒ²å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        })
        .getPatientHistory(patientId);
    }
    
    // ã•ã‚‰ã«è¡¨ç¤º
    function showMoreHistory() {
      historyDisplayCount += 10;
      displayHistory(allHistoryRecords, historyDisplayCount);
    }
    
    // éå»ã®è¨˜éŒ²ã‚’è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    function displayHistory(history, maxShow) {
      var historyDiv = document.getElementById('historySummary');
      var contentDiv = document.getElementById('historyContent');
      
      if (!history || history.length === 0) {
        historyDiv.style.display = 'none';
        return;
      }
      
      var showCount = Math.min(maxShow || 5, history.length);
      var html = '';
      
      // ä»¶æ•°è¡¨ç¤º
      html += '<div style="font-size:12px; color:#666; margin-bottom:8px;">';
      html += 'å…¨ ' + history.length + ' ä»¶';
      if (history.length > showCount) {
        html += 'ï¼ˆ' + showCount + ' ä»¶è¡¨ç¤ºä¸­ï¼‰';
      }
      html += ' | è¨ªå•æ—¥æ™‚ã®æ–°ã—ã„é †';
      html += '</div>';
      
      for (var index = 0; index < showCount; index++) {
        var record = history[index];
        var recordId = 'record_' + index;
        
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼ã¯ç·‘ã€é€šå¸¸è¨˜éŒ²ã¯é’ã®ãƒœãƒ¼ãƒ€ãƒ¼
        var borderColor = record.isDocSummary ? '#4caf50' : '#2196f3';
        
        html += '<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid ' + borderColor + ';">';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        html += '<div style="font-weight: bold; color: #2e7d32; margin-bottom: 4px;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 4px;">';
        html += '<span style="font-size:13px;">ğŸ“… ' + record.date;
        if (record.scenario) html += ' | ğŸ·ï¸ ' + record.scenario;
        html += '</span>';
        
        // ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
        html += '<div style="display:flex; gap:4px; flex-wrap:wrap;">';
        html += '<button onclick="copyRecord(\'' + recordId + '\')" ';
        html += 'style="padding:4px 8px; background:#2196f3; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">';
        html += 'ğŸ“‹ã‚³ãƒ”ãƒ¼</button>';
        
        // ç·¨é›†ãƒ»è¿½è¨˜ãƒ»ä¿®æ­£æ­´ãƒ»å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆreportIdãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if (record.reportId) {
          html += '<button onclick="editRecord(\'' + record.reportId + '\', \'' + recordId + '\')" ';
          html += 'style="padding:4px 8px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">';
          html += 'âœï¸ç·¨é›†</button>';
          
          html += '<button onclick="appendRecord(\'' + record.reportId + '\', \'' + recordId + '\')" ';
          html += 'style="padding:4px 8px; background:#00bcd4; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">';
          html += 'ğŸ“è¿½è¨˜</button>';
          
          html += '<button onclick="showEditHistory(\'' + record.reportId + '\')" ';
          html += 'style="padding:4px 8px; background:#607d8b; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">';
          html += 'ğŸ“œå±¥æ­´</button>';
          
          html += '<button onclick="regenerateRecord(\'' + record.reportId + '\', \'' + recordId + '\')" ';
          html += 'style="padding:4px 8px; background:#9c27b0; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">';
          html += 'ğŸ”„å†ç”Ÿæˆ</button>';
        }
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        // ä¿®æ­£æ¸ˆã¿ãƒãƒƒã‚¸
        if (record.manualEdit) {
          html += '<div style="margin: 4px 0; font-size:10px;">';
          html += '<span style="background:#fff3e0; color:#e65100; padding:2px 6px; border-radius:3px; font-weight:bold;">âœï¸ ä¿®æ­£æ¸ˆã¿';
          if (record.manualEditBy) html += ' (' + record.manualEditBy + ')';
          if (record.manualEditDate) {
            var editDateStr = record.manualEditDate;
            if (editDateStr instanceof Date) {
              editDateStr = editDateStr.toLocaleDateString('ja-JP');
            }
            html += ' ' + editDateStr;
          }
          html += '</span>';
          html += '</div>';
        }
        
        if (record.aiSummary || record.content) {
          html += '<div style="color: #555; font-size: 12px; margin-top: 6px;">';
          html += '<strong>ã€ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§è¦ç´„ã€‘</strong>';
          if (record.reporter) {
            var cleanReporter = record.reporter.replace(/^æ‚£è€…æœ¬äºº_/, '');
            html += ' | è¨ªå•è€…: <strong>' + cleanReporter + '</strong>';
          }
          html += '<br>';
          
          // ã‚³ãƒ”ãƒ¼å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
          html += '<span id="' + recordId + '">';
          var displayText = record.aiSummary || record.content;
          html += displayText.replace(/\n/g, '<br>');
          html += '</span>';
          html += '</div>';
        }
        html += '</div>';
      }
      
      // ã€Œã•ã‚‰ã«è¡¨ç¤ºã€ãƒœã‚¿ãƒ³
      if (history.length > showCount) {
        var remaining = history.length - showCount;
        html += '<div style="text-align:center; margin-top:8px;">';
        html += '<button onclick="showMoreHistory()" ';
        html += 'style="padding:10px 24px; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold;">';
        html += 'ğŸ“‚ ã•ã‚‰ã«è¡¨ç¤ºï¼ˆæ®‹ã‚Š ' + remaining + ' ä»¶ï¼‰</button>';
        html += '</div>';
      }
      
      contentDiv.innerHTML = html;
      historyDiv.style.display = 'block';
    }
    
    function makeDetailRow(label, value) {
      return '<div class="detail-row"><span class="detail-label">' + label + ':</span><span class="detail-value">' + value + '</span></div>';
    }
    
    function openReportFromDetail() {
      showScreen('reportScreen');
      setupReportScreen();
    }
    
    function openReportScreen(patientId) {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success && res.patient) {
            currentPatient = res.patient;
            showScreen('reportScreen');
            setupReportScreen();
          }
        })
        .getPatientDetail(patientId, currentTag);
    }
    
    // å ±å‘Šãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆçœ‹è­·å¸«/åŒ»å¸«ï¼‰
    function toggleReportMode() {
      var isDoctorMode = document.querySelector('input[name="reporterRole"]:checked').value === 'doctor';
      
      // ã‚·ãƒŠãƒªã‚ªé¸æŠã®è¡¨ç¤º/éè¡¨ç¤º
      var scenarioSection = document.getElementById('scenarioSection');
      if (scenarioSection) {
        scenarioSection.style.display = isDoctorMode ? 'none' : 'block';
      }
      
      // ç·Šæ€¥é€šçŸ¥ãƒœãƒƒã‚¯ã‚¹ã®ãƒ©ãƒ™ãƒ«ã¨èª¬æ˜ã‚’åˆ‡ã‚Šæ›¿ãˆ
      var urgentLabel = document.getElementById('urgentAlertLabel');
      var urgentDescription = document.getElementById('urgentAlertDescription');
      
      if (isDoctorMode) {
        urgentLabel.innerHTML = 'ğŸ“‹ è‡ªåˆ†ã¸ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡';
        urgentDescription.textContent = 'â€»ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€æ¬¡å›è¡Œã†ã¹ãã‚¿ã‚¹ã‚¯ï¼ˆç´¹ä»‹çŠ¶ä½œæˆã€å‡¦æ–¹å¤‰æ›´ãªã©ï¼‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¾ã™ã€‚';
      } else {
        urgentLabel.innerHTML = 'ğŸš€ åŒ»å¸«ã¸ä»Šã™ããƒ¡ãƒ¼ãƒ«';
        urgentDescription.textContent = 'â€»ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€AIè¦ç´„ã‚’å¾…ãŸãšã«ã“ã®å†…å®¹ãŒç›´æ¥åŒ»å¸«ã®ãƒ¡ãƒ¼ãƒ«ã«å±Šãã¾ã™ã€‚ç·Šæ€¥ã®å ´åˆã¯é›»è©±é€£çµ¡ã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚';
      }
      
      // ãƒ©ãƒ™ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
      var contentLabel = document.querySelector('.content-label');
      if (contentLabel) {
        contentLabel.textContent = isDoctorMode ? 'âœï¸ è¨ºå¯Ÿå†…å®¹ï¼ˆSOAPå½¢å¼ã§è‡ªå‹•æ•´ç†ã•ã‚Œã¾ã™ï¼‰' : 'âœï¸ å ±å‘Šå†…å®¹';
      }
      
      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
      var reportInput = document.getElementById('reportInput');
      if (reportInput) {
        if (isDoctorMode) {
          reportInput.placeholder = "è¨ºå¯Ÿå†…å®¹ã‚’å…¥åŠ›...\n\nä¾‹: æ‚£è€…ã¯å‰å›ã‹ã‚‰é£Ÿæ¬²ãŒæˆ»ã£ãŸã¨è©±ã™ã€‚ä½“æ¸©36.8â„ƒã€è¡€åœ§128/76ã€SpO2 98%ã€‚å‘¼å¸éŸ³æ¸…ã€æµ®è…«ãªã—ã€‚å…¨ä½“çš„ã«çŠ¶æ…‹ã¯å®‰å®šã—ã¦ã„ã‚‹ã€‚ç¾åœ¨ã®å‡¦æ–¹ã‚’ç¶™ç¶šã—ã€2é€±é–“å¾Œã«å†è¨ºã¨ã™ã‚‹ã€‚";
        } else {
          reportInput.placeholder = "ã“ã“ã«å…¥åŠ›...\n\nä¾‹: BT37.8â„ƒã€SpO2 96%\nç™ºç†±ã‚ã‚Šé£Ÿæ¬²ä½ä¸‹(1/2)\næ°´åˆ†æ‘‚å–ã¯å¯";
        }
      }
    }
    
    function setupReportScreen() {
      document.getElementById('reportPatientName').textContent = currentPatient.name;
      document.getElementById('reportPatientInfo').textContent = 'ID: ' + currentPatient.id + ' / ' + currentPatient.careLevel;
      
      // Summaryã‚·ãƒ¼ãƒˆã‹ã‚‰æŸ”è»Ÿã«ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(res) {
          var summaryDisplay = document.getElementById('patientSummaryDisplay');
          var summaryContainer = document.getElementById('summaryContainer');
          
          if (res && res.success) {
            if (res.isEmpty) {
              // ã‚±ãƒ¼ã‚¹4: ã¾ã ä½•ã‚‚ãªã„
              summaryDisplay.innerHTML = '<span style="color:#999;">ã¾ã ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>è¨ªå•è¨˜éŒ²ãŒè¿½åŠ ã•ã‚Œã‚‹ã¨ã€ã“ã“ã«çµŒéãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>';
            } else if (res.summary) {
              // ã‚±ãƒ¼ã‚¹1,2,3: ä½•ã‚‰ã‹ã®æƒ…å ±ãŒã‚ã‚‹
              summaryDisplay.innerHTML = res.summary.replace(/\n/g, '<br>');
              summaryDisplay.style.color = "#444";
              
              // æœ€è¿‘ã®çµŒéã®ã¿ã®å ´åˆã¯ã€èƒŒæ™¯è‰²ã‚’å¤‰ãˆã¦è¦–è¦šçš„ã«åŒºåˆ¥
              if (res.recentOnly) {
                summaryContainer.style.background = "#fff9e6";
                summaryContainer.style.borderColor = "#ffc107";
              } else {
                summaryContainer.style.background = "#f0f7ff";
                summaryContainer.style.borderColor = "#2196F3";
              }
            } else {
              summaryDisplay.innerHTML = '<span style="color:#999;">ã‚µãƒãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚</span>';
            }
          } else {
            summaryDisplay.innerHTML = '<span style="color:#999;">ã‚µãƒãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>';
          }
        })
        .withFailureHandler(function(err) {
          console.error("ã‚µãƒãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          document.getElementById('patientSummaryDisplay').innerHTML = 
            '<span style="color:#999;">ã‚µãƒãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>';
        })
        .getSummaryForPatient(currentPatient.id);
      
      document.getElementById('reportInput').value = "";
      
      // ä¿®æ­£ï¼šæ‚£è€…æœ¬äººãƒ­ã‚°ã‚¤ãƒ³ã§ã‚ã£ã¦ã‚‚ã€è¨˜éŒ²è€…åã¯è‡ªå‹•å…¥åŠ›ã›ãšç©ºæ¬„ã«ã™ã‚‹
      // ã“ã‚Œã«ã‚ˆã‚Šã€è¨ªå•ã—ãŸã‚¹ã‚¿ãƒƒãƒ•ã‚„å®¶æ—ãŒè‡ªåˆ†ã®åå‰ã‚’éƒ½åº¦å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
      var reporterNameInput = document.getElementById('reporterName');
      
      reporterNameInput.value = ""; // å¸¸ã«ç©ºæ¬„ã«ã™ã‚‹
      reporterNameInput.readOnly = false; // å¸¸ã«ç·¨é›†å¯èƒ½ã«ã™ã‚‹
      reporterNameInput.style.background = ""; // èƒŒæ™¯è‰²ã‚’é€šå¸¸ã«æˆ»ã™
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('urgentAlertCheckbox').checked = false;
      document.getElementById('ocrCheckbox').checked = false;
      
      // çœ‹è­·å¸«ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      document.querySelector('input[name="reporterRole"][value="nurse"]').checked = true;
      toggleReportMode(); // ãƒ©ãƒ™ãƒ«ã‚’åˆæœŸåŒ–
      
      selectedImages = [];
      selectedAudio = null;
      selectedScenario = "";
      document.querySelectorAll('.scenario-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('audioPreview').innerHTML = '';
      document.getElementById('successMessage').classList.add('hidden');
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¨ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’éè¡¨ç¤º
      document.getElementById('scenarioChecklist').style.display = 'none';
      document.getElementById('tokushijiTemplate').style.display = 'none';
      
      // ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('tokuStatus').value = 'è¨ªå•ä¸­';
      document.getElementById('tokuReasonJokuso').checked = false;
      document.getElementById('tokuReasonHatsunetsu').checked = false;
      document.getElementById('tokuReasonDassui').checked = false;
      document.getElementById('tokuReasonOther').value = '';
      document.getElementById('jokusoSection').style.display = 'none';
      document.getElementById('jokusoSite').value = '';
      document.getElementById('designrDate').value = '';
      document.getElementById('designD').value = 'd0';
      document.getElementById('designE').value = '0';
      document.getElementById('designS').value = '0';
      document.getElementById('designI').value = '0';
      document.getElementById('designG').value = '0';
      document.getElementById('designN').value = '0';
      document.getElementById('designP').value = '0';
      document.getElementById('designrResult').textContent = 'åˆè¨ˆ: 0ç‚¹ | åˆ¤å®š: çœŸçš®æå‚·ä»¥å†…';
      document.getElementById('tokuTreatment').value = '';
      document.getElementById('tokuWoc').checked = false;
      document.getElementById('wocDetail').style.display = 'none';
      document.getElementById('tokuWocDate').value = '';
      document.getElementById('tokuAttachPhoto').checked = false;
      document.getElementById('tokuAttachDesignR').checked = false;
      document.getElementById('tokuAttachInout').checked = false;
      document.getElementById('tokuBT').value = '';
      document.getElementById('tokuBPH').value = '';
      document.getElementById('tokuBPL').value = '';
      document.getElementById('tokuPulse').value = '';
      document.getElementById('tokuSpO2').value = '';
      document.getElementById('tokuRR').value = '';
      document.getElementById('tokuLastBM').value = '';
      document.getElementById('tokuCondition').value = '';
      document.getElementById('tokuAction').value = '';
      document.getElementById('tokuPhone').value = '';
      document.getElementById('tokuTomorrow').value = '';
      document.getElementById('tokuPharmacy').value = '';
      
      // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èª¿æ•´
      var backBtn = document.getElementById('backFromSuccessBtn');
      if (currentTag === "æ‚£è€…æœ¬äºº") {
        backBtn.textContent = "â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ";
      } else {
        backBtn.textContent = "â† æ‚£è€…ãƒªã‚¹ãƒˆã«æˆ»ã‚‹";
      }
      
      // éå»ã®è¨˜éŒ²ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      if (currentPatient && currentPatient.id) {
        loadPatientHistory(currentPatient.id);
      }
    }
    
    function backToPatientList() {
      // æ‚£è€…æœ¬äººãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
      if (currentTag === "æ‚£è€…æœ¬äºº") {
        handleLogout();
      } else {
        showScreen('patientListScreen');
      }
    }
    
    function backToDetailFromReport() {
      showScreen('patientDetailScreen');
    }
    
    function handleLogout() {
      currentTag = "";
      currentPatient = null;
      showScreen('loginScreen');
      document.getElementById('passwordInput').value = "";
      document.getElementById('patientIdInput').value = "";
      document.getElementById('birthdateInput').value = "";
    }
    
    function showScreen(screenId) {
      ['loginScreen', 'patientListScreen', 'patientDetailScreen', 'reportScreen'].forEach(function(id) {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }
    
    // ã‚·ãƒŠãƒªã‚ªã”ã¨ã®ãƒã‚§ãƒƒã‚¯é …ç›®å®šç¾©
    var scenarioChecklists = {
      'ç™ºç†±ã‚ã‚Š': [
        'ä½“æ¸©ã‚’æ¸¬å®šï¼ˆBTï¼‰',
        'é…¸ç´ é£½å’Œåº¦ï¼ˆSpO2ï¼‰',
        'å‘¼å¸çŠ¶æ…‹ãƒ»å’³ã®æœ‰ç„¡',
        'é£Ÿäº‹ãƒ»æ°´åˆ†æ‘‚å–é‡',
        'å°¿é‡ãƒ»æ’ä¾¿çŠ¶æ³',
        'æ„è­˜ãƒ¬ãƒ™ãƒ«ï¼ˆã„ã¤ã‚‚ã¨å¤‰ã‚ã‚Šãªã„ã‹ï¼‰'
      ],
      'è»¢å€’ãƒ»æ€ªæˆ‘': [
        'å—å‚·éƒ¨ä½ãƒ»ç¯„å›²',
        'å‡ºè¡€ã®æœ‰ç„¡',
        'è…«è„¹ãƒ»å¤‰å½¢ã®æœ‰ç„¡',
        'ç–¼ç—›ã®ç¨‹åº¦',
        'æ‚£éƒ¨ã®å¯å‹•åŸŸ',
        'è»¢å€’æ™‚ã®çŠ¶æ³ï¼ˆã„ã¤ã€ã©ã“ã§ã€ä½•ã‚’ã—ã¦ã„ãŸæ™‚ã‹ï¼‰'
      ],
      'ç‰¹æŒ‡ç¤º': [], // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§å¯¾å¿œ
      'ãã®ä»–': []
    };

    function selectScenario(btn, scenario) {
      document.querySelectorAll('.scenario-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      selectedScenario = scenario;
      
      // ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¡¨ç¤º/éè¡¨ç¤º
      var tokushijiDiv = document.getElementById('tokushijiTemplate');
      if (scenario === 'ç‰¹æŒ‡ç¤º') {
        tokushijiDiv.style.display = 'block';
        // è‡ªå‹•å…¥åŠ›ã‚’è¨­å®š
        setupTokushijiAutoFill();
      } else {
        tokushijiDiv.style.display = 'none';
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
      showChecklist(scenario);
    }
    
    // ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è‡ªå‹•å…¥åŠ›ã‚’è¨­å®š
    function setupTokushijiAutoFill() {
      // æœ¬æ—¥ã®æ—¥ä»˜ï¼ˆä¾‹: 2/15ï¼ˆæ—¥ï¼‰ï¼‰
      var now = new Date();
      var dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      var dateStr = (now.getMonth() + 1) + '/' + now.getDate() + 'ï¼ˆ' + dayNames[now.getDay()] + 'ï¼‰';
      
      // DESIGN-Rè©•ä¾¡æ—¥ã«ã‚‚æœ¬æ—¥æ—¥ä»˜ã‚’è¨­å®š
      var designrDate = document.getElementById('designrDate');
      if (designrDate && !designrDate.value) {
        designrDate.value = dateStr;
      }
    }
    
    // è¤¥ç˜¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    function toggleJokuso() {
      var checked = document.getElementById('tokuReasonJokuso').checked;
      document.getElementById('jokusoSection').style.display = checked ? 'block' : 'none';
    }
    
    // DESIGN-R è‡ªå‹•è¨ˆç®—
    function calcDesignR() {
      var e = parseInt(document.getElementById('designE').value) || 0;
      var s = parseInt(document.getElementById('designS').value) || 0;
      var i = parseInt(document.getElementById('designI').value) || 0;
      var g = parseInt(document.getElementById('designG').value) || 0;
      var n = parseInt(document.getElementById('designN').value) || 0;
      var p = parseInt(document.getElementById('designP').value) || 0;
      
      var total = e + s + i + g + n + p;
      
      var dVal = document.getElementById('designD').value;
      var beyondDermis = (dVal === 'D3' || dVal === 'D4' || dVal === 'D5');
      var judgment = beyondDermis ? 'çœŸçš®ã‚’è¶…ãˆã‚‹æå‚·' : 'çœŸçš®æå‚·ä»¥å†…';
      
      var resultDiv = document.getElementById('designrResult');
      resultDiv.textContent = 'åˆè¨ˆ: ' + total + 'ç‚¹ | åˆ¤å®š: ' + judgment;
      resultDiv.style.background = beyondDermis ? '#ffebee' : '#fff3e0';
      resultDiv.style.color = beyondDermis ? '#c62828' : '#e65100';
    }
    
    // DESIGN-R è¡¨è¨˜ã‚’ç”Ÿæˆï¼ˆä¾‹: DU-e3s3i0g1n0P0ï¼‰
    function getDesignRNotation() {
      var d = document.getElementById('designD').value;
      
      var eVal = document.getElementById('designE').value;
      var eLabels = {'0':'e0','1':'e1','3':'e3','6':'E6'};
      
      var sVal = document.getElementById('designS').value;
      var sLabels = {'0':'s0','3':'s3','6':'s6','8':'s8','9':'s9','12':'s12','15':'S15'};
      
      var iSelect = document.getElementById('designI');
      var iLabel = iSelect.options[iSelect.selectedIndex].text.split(' ')[0];
      
      var gVal = document.getElementById('designG').value;
      var gLabels = {'0':'g0','1':'g1','3':'g3','4':'G4','5':'G5','6':'G6'};
      
      var nVal = document.getElementById('designN').value;
      var nLabels = {'0':'n0','3':'N3','6':'N6'};
      
      var pVal = document.getElementById('designP').value;
      var pLabels = {'0':'p0','6':'P6','9':'P9','12':'P12','24':'P24'};
      
      return d + '-' + (eLabels[eVal]||'e0') + (sLabels[sVal]||'s0') + iLabel + (gLabels[gVal]||'g0') + (nLabels[nVal]||'n0') + (pLabels[pVal]||'p0');
    }
    
    // ç‰¹æŒ‡ç¤ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ 
    function applyTokushijiTemplate() {
      var now = new Date();
      var dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      var dateStr = (now.getMonth() + 1) + '/' + now.getDate() + 'ï¼ˆ' + dayNames[now.getDay()] + 'ï¼‰';
      
      var patientName = currentPatient ? currentPatient.name : '';
      var reporterName = document.getElementById('reporterName').value.trim();
      var status = document.getElementById('tokuStatus').value;
      
      // è¦ä»¶ã‚’åé›†
      var reasons = [];
      if (document.getElementById('tokuReasonJokuso').checked) reasons.push('è¤¥ç˜¡');
      if (document.getElementById('tokuReasonHatsunetsu').checked) reasons.push('ç™ºç†±');
      if (document.getElementById('tokuReasonDassui').checked) reasons.push('è„±æ°´');
      var otherReason = document.getElementById('tokuReasonOther').value.trim();
      if (otherReason) reasons.push(otherReason);
      
      var text = '';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼
      text += 'ã€' + dateStr + ' ' + patientName + ' æ§˜ã€‘\n';
      text += 'ç”¨ä»¶ï¼šç‰¹æŒ‡ç¤ºå¯¾å¿œã«ã¤ã„ã¦ã€DræŒ‡ç¤ºå¾…ã¡\n';
      text += 'çŠ¶æ³ï¼š' + status + '\n';
      text += 'ã ã‚Œã‹ã‚‰ã®ç›¸è«‡ã‹ï¼š' + currentTag + ' ' + (reporterName || '') + '\n';
      if (reasons.length > 0) {
        text += 'çŠ¶æ³ï¼š' + reasons.join('ã€') + 'ã®ç¶™ç¶šã«ã¤ã„ã¦\n';
        text += 'ç‰¹æŒ‡ç¤ºã®ç¶™ç¶šæŒ‡ç¤ºã‚’é ‚ããŸã„\n';
      }
      text += '\n';
      
      // ç‰¹æŒ‡ç¤ºã®è¦ä»¶
      if (reasons.length > 0) {
        text += 'ç‰¹æŒ‡ç¤ºã®è¦ä»¶ã€' + reasons.join('ã€') + 'ã€‘\n';
      }
      
      // è¤¥ç˜¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      if (document.getElementById('tokuReasonJokuso').checked) {
        var site = document.getElementById('jokusoSite').value.trim();
        var designDate = document.getElementById('designrDate').value.trim();
        
        if (site) {
          text += 'ã€' + site + 'ã®è¤¥ç˜¡ã€‘\n';
        }
        
        var notation = getDesignRNotation();
        var e = parseInt(document.getElementById('designE').value) || 0;
        var s = parseInt(document.getElementById('designS').value) || 0;
        var i = parseInt(document.getElementById('designI').value) || 0;
        var g = parseInt(document.getElementById('designG').value) || 0;
        var n = parseInt(document.getElementById('designN').value) || 0;
        var p = parseInt(document.getElementById('designP').value) || 0;
        var total = e + s + i + g + n + p;
        var dVal = document.getElementById('designD').value;
        var beyondDermis = (dVal === 'D3' || dVal === 'D4' || dVal === 'D5');
        
        text += 'DESIGN-Rè©•ä¾¡ ' + (designDate || '') + 'ï¼ˆ' + notation + 'ï¼‰\n';
        text += 'ï¼ˆåˆè¨ˆ' + total + 'ç‚¹ ' + (beyondDermis ? 'çœŸçš®ã‚’è¶…ãˆã‚‹æå‚·' : 'çœŸçš®æå‚·ä»¥å†…') + 'ï¼‰\n\n';
      }
      
      // å¤–ç”¨è–¬
      var ointSites = document.querySelectorAll('.ointSite');
      var ointNames = document.querySelectorAll('.ointName');
      var hasOintment = false;
      var ointText = '';
      for (var idx = 0; idx < ointSites.length; idx++) {
        var oSite = ointSites[idx].value.trim();
        var oName = ointNames[idx].value.trim();
        if (oSite || oName) {
          if (!hasOintment) {
            ointText += 'ã€å¤–ç”¨è–¬ã€‘\n';
            hasOintment = true;
          }
          ointText += (oSite || 'éƒ¨ä½æœªå…¥åŠ›') + 'ï¼š ' + (oName || '') + '\n';
        }
      }
      if (hasOintment) text += ointText;
      
      // å‡¦ç½®å†…å®¹
      var treatment = document.getElementById('tokuTreatment').value.trim();
      if (treatment) {
        text += 'ã€å‡¦ç½®å†…å®¹ã€‘ ' + treatment + '\n';
      }
      
      text += '\n';
      
      // WOCãƒŠãƒ¼ã‚¹
      if (document.getElementById('tokuWoc').checked) {
        var wocDate = document.getElementById('tokuWocDate').value.trim();
        text += 'æ¬¡å›WOCä»‹å…¥ã¯' + (wocDate || 'æ—¥æ™‚æœªå®š') + '\n\n';
      }
      
      // æ·»ä»˜
      var attachments = [];
      if (document.getElementById('tokuAttachPhoto').checked) attachments.push('è¤¥ç˜¡å†™çœŸ');
      if (document.getElementById('tokuAttachDesignR').checked) attachments.push('DESIGN-Rè©•ä¾¡');
      if (document.getElementById('tokuAttachInout').checked) attachments.push('inoutè¡¨');
      if (attachments.length > 0) {
        text += 'ã€æ·»ä»˜ã€‘' + attachments.join('ã€') + '\n\n';
      }
      
      // ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³
      var bt = document.getElementById('tokuBT').value.trim();
      var bpH = document.getElementById('tokuBPH').value.trim();
      var bpL = document.getElementById('tokuBPL').value.trim();
      var pulse = document.getElementById('tokuPulse').value.trim();
      var pulseType = document.getElementById('tokuPulseType').value;
      var spo2 = document.getElementById('tokuSpO2').value.trim();
      var rr = document.getElementById('tokuRR').value.trim();
      var lastBM = document.getElementById('tokuLastBM').value.trim();
      
      if (bt || bpH || pulse || spo2 || rr) {
        text += 'ã€VSï¼š' + dateStr + 'ã€‘\n';
        if (bt) text += 'ä½“æ¸©ï¼š' + bt + 'â„ƒ\n';
        if (bpH && bpL) text += 'è¡€åœ§ï¼š' + bpH + '/' + bpL + 'mmHg\n';
        if (pulse) text += 'è„ˆæ‹ï¼š' + pulse + 'ï¼ˆ' + pulseType + 'ï¼‰\n';
        if (spo2) text += 'SpO2ï¼š' + spo2 + '%\n';
        if (rr) text += 'å‘¼å¸å›æ•°ï¼š' + rr + 'å›\n';
        if (lastBM) text += 'æœ€çµ‚æ’ä¾¿ï¼š' + lastBM + '\n';
        text += '\n';
      }
      
      // çŠ¶æ…‹
      var condition = document.getElementById('tokuCondition').value.trim();
      if (condition) {
        text += 'ã€çŠ¶æ…‹ã€‘\n' + condition + '\n\n';
      }
      
      // è¡Œã£ãŸå¯¾å¿œ
      var action = document.getElementById('tokuAction').value.trim();
      if (action) {
        text += 'è¡Œã£ãŸå¯¾å¿œï¼š' + action + '\n';
      }
      
      // è¿”é›»é€£çµ¡å…ˆ
      var phone = document.getElementById('tokuPhone').value.trim();
      if (phone) {
        text += 'è¿”é›»é€£çµ¡å…ˆé›»è©±ç•ªå·ï¼š' + phone + '\n';
      }
      
      text += '\n';
      
      // æ˜æ—¥ã®è¨ªçœ‹ä»‹å…¥
      var tomorrow = document.getElementById('tokuTomorrow').value.trim();
      if (tomorrow) {
        text += 'ã€æ˜æ—¥ã®è¨ªçœ‹ä»‹å…¥ã€‘\n' + tomorrow + '\n\n';
      }
      
      // è–¬å±€ã¸
      var pharmacy = document.getElementById('tokuPharmacy').value.trim();
      if (pharmacy) {
        text += 'ã€è–¬å±€ã¸ã€‘\n' + pharmacy + '\n';
      }
      
      // è¨˜éŒ²è€…
      if (reporterName) {
        text += '\nè¨˜éŒ²è€…ï¼š' + reporterName;
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«åæ˜ 
      var textarea = document.getElementById('reportInput');
      var existing = textarea.value.trim();
      if (existing) {
        // æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãç¢ºèª
        if (!confirm('å ±å‘Šå†…å®¹ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§æœ«å°¾ã«è¿½è¨˜ï¼‰')) {
          textarea.value = existing + '\n\n' + text;
        } else {
          textarea.value = text;
        }
      } else {
        textarea.value = text;
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      textarea.focus();
      
      showQuickMessage('ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã«åæ˜ ã—ã¾ã—ãŸï¼ˆä¿®æ­£ã§ãã¾ã™ï¼‰');
    }
    
    function showChecklist(scenario) {
      var checklistDiv = document.getElementById('scenarioChecklist');
      var itemsDiv = document.getElementById('checklistItems');
      var items = scenarioChecklists[scenario] || [];
      
      if (items.length === 0) {
        checklistDiv.style.display = 'none';
        return;
      }
      
      var html = '';
      items.forEach(function(item, index) {
        html += '<div style="margin: 6px 0; padding: 6px; background: white; border-radius: 4px;">';
        html += '<label style="display: flex; align-items: center; cursor: pointer;">';
        html += '<input type="checkbox" style="margin-right: 8px; width: 18px; height: 18px;">';
        html += '<span style="flex: 1;">' + (index + 1) + '. ' + item + '</span>';
        html += '</label>';
        html += '</div>';
      });
      
      itemsDiv.innerHTML = html;
      checklistDiv.style.display = 'block';
    }
    
    function handleImageSelect(input, source) {
      var files = input.files;
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var reader = new FileReader();
        reader.onload = (function(f) {
          return function(e) {
            selectedImages.push(e.target.result);
            updateImagePreview();
          };
        })(file);
        reader.readAsDataURL(file);
      }
      input.value = "";
    }
    
    function updateImagePreview() {
      var preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      selectedImages.forEach(function(imgData, index) {
        var item = document.createElement('div');
        item.className = 'image-preview-item';
        item.innerHTML = 
          '<img src="' + imgData + '">' +
          '<button class="image-remove" onclick="removeImage(' + index + ')">Ã—</button>';
        preview.appendChild(item);
      });
    }
    
    function removeImage(index) {
      selectedImages.splice(index, 1);
      updateImagePreview();
    }
    
    var isRecording = false;
    var lastProcessedIndex = 0; // æœ€å¾Œã«å‡¦ç†ã—ãŸçµæœã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    
    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }
      
      if (isRecording) {
        // åœæ­¢
        recognition.stop();
        isRecording = false;
        lastProcessedIndex = 0; // ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('voiceBtn').classList.remove('listening');
        document.getElementById('voiceBtnIcon').textContent = 'ğŸ¤';
        document.getElementById('voiceBtnText').textContent = 'éŸ³å£°ã§å…¥åŠ›ï¼ˆPCç”¨ï¼‰';
        return;
      }
      
      if (!recognition) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;  // é€£ç¶šéŒ²éŸ³ã‚’æœ‰åŠ¹åŒ–
        recognition.interimResults = false;  // é€”ä¸­çµæœã¯è¡¨ç¤ºã—ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        
        recognition.onresult = function(event) {
          var textarea = document.getElementById('reportInput');
          var finalTranscript = '';
          
          // æœ€å¾Œã«å‡¦ç†ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å‡¦ç†ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
          for (var i = lastProcessedIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              var text = event.results[i][0].transcript;
              finalTranscript += text;
              lastProcessedIndex = i + 1; // æ¬¡å›ã¯ã“ã“ã‹ã‚‰å‡¦ç†
              console.log('[éŸ³å£°èªè­˜] è¿½åŠ : ' + text);
            }
          }
          
          if (finalTranscript) {
            // ç©ºç™½ã¾ãŸã¯æ”¹è¡Œã§åŒºåˆ‡ã£ã¦è¿½åŠ 
            if (textarea.value && !textarea.value.endsWith(' ') && !textarea.value.endsWith('\n')) {
              textarea.value += ' ';
            }
            textarea.value += finalTranscript;
          }
        };
        
        recognition.onerror = function(event) {
          console.error('[éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼]', event.error);
          isRecording = false;
          lastProcessedIndex = 0;
          document.getElementById('voiceBtn').classList.remove('listening');
          document.getElementById('voiceBtnIcon').textContent = 'ğŸ¤';
          document.getElementById('voiceBtnText').textContent = 'éŸ³å£°ã§å…¥åŠ›ï¼ˆPCç”¨ï¼‰';
          if (event.error !== 'no-speech' && event.error !== 'aborted') {
            alert('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error + '\n\nã‚¹ãƒãƒ›ã®æ–¹ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
          }
        };
        
        recognition.onend = function() {
          console.log('[éŸ³å£°èªè­˜] çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã€isRecording=' + isRecording);
          if (isRecording) {
            // è‡ªå‹•çš„ã«å†é–‹ï¼ˆé€£ç¶šéŒ²éŸ³ï¼‰
            try {
              // lastProcessedIndexã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆé€£ç¶šã§è¿½åŠ ã™ã‚‹ãŸã‚ï¼‰
              recognition.start();
              console.log('[éŸ³å£°èªè­˜] å†é–‹ã—ã¾ã—ãŸ');
            } catch (e) {
              console.error('[éŸ³å£°èªè­˜] å†é–‹ã‚¨ãƒ©ãƒ¼:', e);
              isRecording = false;
              lastProcessedIndex = 0;
              document.getElementById('voiceBtn').classList.remove('listening');
              document.getElementById('voiceBtnIcon').textContent = 'ğŸ¤';
              document.getElementById('voiceBtnText').textContent = 'éŸ³å£°ã§å…¥åŠ›ï¼ˆPCç”¨ï¼‰';
            }
          } else {
            lastProcessedIndex = 0; // åœæ­¢æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
          }
        };
      }
      
      isRecording = true;
      document.getElementById('voiceBtn').classList.add('listening');
      document.getElementById('voiceBtnIcon').textContent = 'â¹ï¸';
      document.getElementById('voiceBtnText').textContent = 'åœæ­¢';
      recognition.start();
    }
    
    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
    var selectedAudio = null;
    
    function handleAudioSelect(input) {
      if (input.files && input.files[0]) {
        selectedAudio = input.files[0];
        var audioPreview = document.getElementById('audioPreview');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è¡¨ç¤º
        var fileSize = (selectedAudio.size / 1024 / 1024).toFixed(2);
        audioPreview.innerHTML = '<div style="padding:8px; background:#e3f2fd; border-radius:4px; color:#1976d2;">ğŸ™ï¸ ' + selectedAudio.name + ' (' + fileSize + 'MB)<br><small>ğŸ“ é€ä¿¡æ™‚ã«è‡ªå‹•çš„ã«æ–‡å­—èµ·ã“ã—ã•ã‚Œã¾ã™</small></div>';
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã‚‹å ´åˆã¯è­¦å‘Š
        if (selectedAudio.size > 10 * 1024 * 1024) { // 10MBä»¥ä¸Š
          audioPreview.innerHTML += '<div style="padding:8px; background:#fff3cd; border-radius:4px; color:#856404; margin-top:4px; font-size:12px;">âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„ãŸã‚ã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</div>';
        }
      }
    }
    
    // ã‚«ãƒ¡ãƒ©æ’®å½±æ©Ÿèƒ½
    async function takePhoto() {
      var modal = document.getElementById('photoModal');
      var video = document.getElementById('photoVideo');
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = stream;
        modal.classList.add('active');
        
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('confirmPhotoBtn').style.display = 'none';
        document.getElementById('photoPreview').style.display = 'none';
        video.style.display = 'block';
      } catch (err) {
        alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + err.message);
      }
    }
    
    function capturePhoto() {
      var video = document.getElementById('photoVideo');
      var canvas = document.getElementById('photoCanvas');
      var preview = document.getElementById('photoPreview');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
      preview.src = capturedImageData;
      
      video.style.display = 'none';
      preview.style.display = 'block';
      document.getElementById('captureBtn').style.display = 'none';
      document.getElementById('confirmPhotoBtn').style.display = 'block';
    }
    
    function confirmPhoto() {
      if (capturedImageData) {
        selectedImages.push(capturedImageData);
        updateImagePreview();
      }
      closePhotoModal();
    }
    
    function closePhotoModal() {
      var modal = document.getElementById('photoModal');
      modal.classList.remove('active');
      
      if (stream) {
        stream.getTracks().forEach(function(track) {
          track.stop();
        });
        stream = null;
      }
      
      capturedImageData = null;
      document.getElementById('photoVideo').style.display = 'none';
      document.getElementById('photoPreview').style.display = 'none';
    }
    
    // æ™‚é–“ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showTimeConfirmDialog(callback) {
      var dialog = document.getElementById('timeDialog');
      var startInput = document.getElementById('dialogStartTime');
      var endInput = document.getElementById('dialogEndTime');
      
      var now = new Date();
      var start = visitStartTime || now;
      
      startInput.value = toDateTimeLocal(start);
      endInput.value = toDateTimeLocal(now);
      
      timeConfirmCallback = callback;
      dialog.classList.add('active');
    }
    
    function confirmTime() {
      var startInput = document.getElementById('dialogStartTime');
      var endInput = document.getElementById('dialogEndTime');
      
      var startTime = startInput.value;
      var endTime = endInput.value;
      
      document.getElementById('timeDialog').classList.remove('active');
      
      if (timeConfirmCallback) {
        timeConfirmCallback(startTime, endTime);
      }
    }
    
    function cancelTime() {
      document.getElementById('timeDialog').classList.remove('active');
      
      var btn = document.getElementById('sendBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ“¤ é€ä¿¡";
    }
    
    function toDateTimeLocal(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      var hours = String(date.getHours()).padStart(2, '0');
      var minutes = String(date.getMinutes()).padStart(2, '0');
      
      return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
    }
    
    // è¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼
    function copyRecord(recordId) {
      var element = document.getElementById(recordId);
      if (!element) {
        alert('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // HTMLã‹ã‚‰æ”¹è¡Œã‚’ä¿æŒã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
      var html = element.innerHTML;
      var text = html
        .replace(/<br\s*\/?>/gi, '\n')  // <br>ã‚’æ”¹è¡Œã«å¤‰æ›
        .replace(/<[^>]+>/g, '')         // ãã®ä»–ã®HTMLã‚¿ã‚°ã‚’å‰Šé™¤
        .replace(/&nbsp;/g, ' ')         // &nbsp;ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«
        .replace(/&lt;/g, '<')           // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã‚’æˆ»ã™
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&')
        .trim();
      
      // æ‚£è€…åã‚’è¿½åŠ 
      var patientName = currentPatient ? currentPatient.name : 'æ‚£è€…åä¸æ˜';
      var textWithPatient = 'æ‚£è€…å: ' + patientName + '\n\n' + text;
      
      navigator.clipboard.writeText(textWithPatient).then(function() {
        var btn = event.target;
        var originalText = btn.textContent;
        btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
        btn.style.background = '#4caf50';
        
        setTimeout(function() {
          btn.textContent = originalText;
          btn.style.background = '#2196f3';
        }, 2000);
      }).catch(function(err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
      });
    }
    
    // ä¿®æ­£ä¾é ¼ãƒ¡ãƒ¼ãƒ«
    function sendCorrectionEmail() {
      var subject = "çµŒéã‚µãƒãƒªãƒ¼ã®ä¿®æ­£ä¾é ¼";
      var body = "æ‚£è€…ID: " + currentPatient.id + "\næ‚£è€…å: " + currentPatient.name + "\n\nä¿®æ­£å†…å®¹:\n";
      window.location.href = "mailto:ishihara.brain@gmail.com?subject=" + 
        encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);
    }
    
    function handleSendReport() {
      var reporterName = document.getElementById('reporterName').value.trim();
      var content = document.getElementById('reportInput').value.trim();
      var isUrgent = document.getElementById('urgentAlertCheckbox').checked;
      var reporterRole = document.querySelector('input[name="reporterRole"]:checked').value;
      
      if (!reporterName) {
        alert("è¨˜éŒ²è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        document.getElementById('reporterName').focus();
        return;
      }
      
      if (!content && !selectedAudio && selectedImages.length === 0) {
        alert("å ±å‘Šå†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€éŸ³å£°ã€ã¾ãŸã¯ç”»åƒï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      // åŒ»å¸«ã®å ´åˆã®ã¿å‡¦æ–¹ã›ã‚“å¤‰æ›´ã¨é€šé™¢/åœ¨å®…ç²¾ç¥ç™‚æ³•ã®ç¢ºèª
      if (reporterRole === 'doctor') {
        showMedicalConfirmDialog(function(prescriptionChange, psychiatryTherapy, visitType) {
          // æ™‚é–“ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
          showTimeConfirmDialog(function(startTime, endTime) {
            proceedWithSend(startTime, endTime, reporterName, reporterRole, content, isUrgent, prescriptionChange, psychiatryTherapy, visitType);
          });
        });
      } else {
        // çœ‹è­·å¸«ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ã®å ´åˆã¯ç›´æ¥æ™‚é–“ç¢ºèªã¸
        showTimeConfirmDialog(function(startTime, endTime) {
          proceedWithSend(startTime, endTime, reporterName, reporterRole, content, isUrgent, undefined, undefined, undefined);
        });
      }
    }
    
    // å‡¦æ–¹ã›ã‚“å¤‰æ›´ãƒ»é€šé™¢/åœ¨å®…ç²¾ç¥ç™‚æ³•ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showMedicalConfirmDialog(callback) {
      var dialog = document.createElement('div');
      dialog.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; justify-content:center; align-items:center;';
      
      var content = document.createElement('div');
      content.style.cssText = 'background:white; padding:30px; border-radius:12px; max-width:400px; width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3);';
      
      content.innerHTML = '<h3 style="margin:0 0 20px 0; font-size:18px; color:#333;">ğŸ“‹ ç¢ºèªäº‹é …</h3>' +
        '<div style="margin-bottom:20px;">' +
        '<div style="margin-bottom:15px; padding:12px; background:#e3f2fd; border-radius:8px;">' +
        '<div style="font-size:14px; color:#666; margin-bottom:8px;">è¨ºç™‚ç¨®åˆ¥</div>' +
        '<label style="display:flex; align-items:center; margin-bottom:6px; cursor:pointer;">' +
        '<input type="radio" name="visitType" value="è¨ªå•" checked style="margin-right:8px; width:18px; height:18px; cursor:pointer;">' +
        '<span style="font-size:15px;">è¨ªå•è¨ºç™‚</span>' +
        '</label>' +
        '<label style="display:flex; align-items:center; cursor:pointer;">' +
        '<input type="radio" name="visitType" value="å¤–æ¥" style="margin-right:8px; width:18px; height:18px; cursor:pointer;">' +
        '<span style="font-size:15px;">å¤–æ¥è¨ºç™‚</span>' +
        '</label>' +
        '</div>' +
        '<label style="display:flex; align-items:center; padding:12px; background:#f5f5f5; border-radius:8px; cursor:pointer; margin-bottom:10px;">' +
        '<input type="checkbox" id="prescriptionChange" style="margin-right:10px; width:20px; height:20px; cursor:pointer;">' +
        '<span style="font-size:15px;">å‡¦æ–¹ã›ã‚“ã®å¤‰æ›´ã‚ã‚Š</span>' +
        '</label>' +
        '<label style="display:flex; align-items:center; padding:12px; background:#f5f5f5; border-radius:8px; cursor:pointer;">' +
        '<input type="checkbox" id="psychiatryTherapy" style="margin-right:10px; width:20px; height:20px; cursor:pointer;">' +
        '<span style="font-size:15px;">é€šé™¢ï¼åœ¨å®…ç²¾ç¥ç™‚æ³•ã‚ã‚Š</span>' +
        '</label>' +
        '</div>' +
        '<div style="display:flex; gap:10px; justify-content:flex-end;">' +
        '<button id="confirmBtn" style="padding:12px 24px; background:#2196f3; color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:bold;">âœ“ ç¢ºèªã—ã¦æ¬¡ã¸</button>' +
        '</div>';
      
      dialog.appendChild(content);
      document.body.appendChild(dialog);
      
      document.getElementById('confirmBtn').onclick = function() {
        var visitType = document.querySelector('input[name="visitType"]:checked').value;
        var prescriptionChange = document.getElementById('prescriptionChange').checked;
        var psychiatryTherapy = document.getElementById('psychiatryTherapy').checked;
        
        document.body.removeChild(dialog);
        callback(prescriptionChange, psychiatryTherapy, visitType);
      };
    }
    
    function proceedWithSend(startTime, endTime, reporterName, reporterRole, content, isUrgent, prescriptionChange, psychiatryTherapy, visitType) {
      var btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.textContent = "ğŸ“¡ é€ä¿¡ä¸­...";
      
      // ç·Šæ€¥é€šçŸ¥/ãƒªãƒã‚¤ãƒ³ãƒ‰ã®é€ä¿¡
      if (isUrgent && content) {
        var reporter = currentTag + '_' + reporterName;
        if (reporterRole === 'nurse') {
          google.script.run
            .withSuccessHandler(function(res) {
              console.log("ğŸš€ ç·Šæ€¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†");
            })
            .withFailureHandler(function(err) {
              console.error("âŒ ç·Šæ€¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
            })
            .sendUrgentDoctorAlert(currentPatient.id, currentPatient.name, reporter, content);
        }
      }
      
      // é€šå¸¸ã®é€ä¿¡å‡¦ç†
      if (selectedAudio || selectedImages.length > 0) {
        uploadFilesAndSend(content, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
      } else {
        sendReportToServer(content, [], null, "", reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
      }
    }
    
    function uploadFilesAndSend(content, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType) {
      var uploadedImageUrls = [];
      var audioUrl = null;
      var audioTranscription = "";
      var ocrText = "";
      var performOCR = document.getElementById('ocrCheckbox').checked;
      var totalUploads = selectedImages.length + (selectedAudio ? 1 : 0);
      var completedUploads = 0;
      
      if (performOCR && selectedImages.length > 0) {
        document.getElementById('sendBtn').textContent = "ğŸ” æ–‡å­—èªè­˜ä¸­...";
      }
      
      selectedImages.forEach(function(imgData, index) {
        google.script.run
          .withSuccessHandler(function(res) {
            completedUploads++;
            if (res && res.success) {
              uploadedImageUrls.push(res.url);
            }
            
            if (completedUploads === totalUploads) {
              if (performOCR && selectedImages.length > 0) {
                performImageOCR(content, uploadedImageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
              } else {
                sendReportToServer(content, uploadedImageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
              }
            }
          })
          .withFailureHandler(function() {
            completedUploads++;
            if (completedUploads === totalUploads) {
              sendReportToServer(content, uploadedImageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
            }
          })
          .uploadImageToDrive(imgData, 'image_' + Date.now() + '_' + index + '.jpg');
      });
      
      // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨æ–‡å­—èµ·ã“ã—
      if (selectedAudio) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        var btn = document.getElementById('sendBtn');
        btn.textContent = "ğŸ¤ éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ä¸­...";
        
        var reader = new FileReader();
        reader.onload = function(e) {
          var base64Audio = e.target.result;
          google.script.run
            .withSuccessHandler(function(res) {
              completedUploads++;
              if (res && res.success) {
                audioUrl = res.url;
                
                // æ–‡å­—èµ·ã“ã—çµæœãŒã‚ã‚Œã°ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¿½åŠ 
                if (res.transcription) {
                  audioTranscription = res.transcription;
                  var reportInput = document.getElementById('reportInput');
                  var currentText = reportInput.value.trim();
                  
                  // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯æ–‡å­—èµ·ã“ã—çµæœã‚’è¨­å®š
                  if (!currentText) {
                    reportInput.value = audioTranscription;
                  } else {
                    // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯è¿½è¨˜
                    reportInput.value = currentText + "\n\nã€éŸ³å£°æ–‡å­—èµ·ã“ã—ã€‘\n" + audioTranscription;
                  }
                  
                  console.log("âœ… éŸ³å£°æ–‡å­—èµ·ã“ã—å®Œäº†: " + audioTranscription.substring(0, 50) + "...");
                }
              }
              
              if (completedUploads === totalUploads) {
                sendReportToServer(reportInput.value.trim(), uploadedImageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
              }
            })
            .withFailureHandler(function(err) {
              completedUploads++;
              console.log("éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", err);
              if (completedUploads === totalUploads) {
                sendReportToServer(content, uploadedImageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
              }
            })
            .uploadAudioToDrive(base64Audio, selectedAudio.name);
        };
        reader.readAsDataURL(selectedAudio);
      }
    }
    
    // æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    function uploadImagesAndSend(content) {
      uploadFilesAndSend(content);
    }
    
    function performImageOCR(content, imageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType) {
      console.log("ğŸ” ç”»åƒOCRé–‹å§‹: " + selectedImages.length + "æš");
      
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success && res.ocrText) {
            console.log("âœ… OCRæˆåŠŸ: " + res.ocrText.length + "æ–‡å­—");
            var fullContent = content;
            if (res.ocrText.trim()) {
              fullContent += (content ? "\n\n" : "") + "ã€ç”»åƒã‹ã‚‰èª­ã¿å–ã£ãŸãƒ†ã‚­ã‚¹ãƒˆã€‘\n" + res.ocrText;
            }
            sendReportToServer(fullContent, imageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
          } else {
            console.warn("âš ï¸ OCRå¤±æ•—ã€é€šå¸¸é€ä¿¡ã¸");
            sendReportToServer(content, imageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
          }
        })
        .withFailureHandler(function(error) {
          console.error("âŒ OCRã‚¨ãƒ©ãƒ¼:", error);
          alert("æ–‡å­—èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é€šå¸¸ã®é€ä¿¡ã‚’ç¶šè¡Œã—ã¾ã™ã€‚");
          sendReportToServer(content, imageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType);
        })
        .performOCROnImages(selectedImages);
    }
    
    function sendReportToServer(content, imageUrls, audioUrl, audioTranscription, reporterName, reporterRole, isUrgent, startTime, endTime, prescriptionChange, psychiatryTherapy, visitType) {
      var finalContent = content || "";
      
      if (audioTranscription && !finalContent) {
        finalContent = audioTranscription;
      }
      
      if (audioUrl && !finalContent) {
        finalContent = "ï¼ˆéŸ³å£°å ±å‘Šã®ã¿ï¼‰";
      }
      
      // ç¢ºèªäº‹é …ã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆåŒ»å¸«ã®å ´åˆã®ã¿ï¼‰
      var confirmInfo = "";
      if (prescriptionChange !== undefined && psychiatryTherapy !== undefined && visitType !== undefined) {
        confirmInfo += "ã€ç¢ºèªäº‹é …ã€‘\n";
        confirmInfo += "è¨ºç™‚ç¨®åˆ¥: " + visitType + "\n";
        confirmInfo += "å‡¦æ–¹ã›ã‚“å¤‰æ›´: " + (prescriptionChange ? "ã‚ã‚Š" : "ãªã—") + "\n";
        confirmInfo += "é€šé™¢ï¼åœ¨å®…ç²¾ç¥ç™‚æ³•: " + (psychiatryTherapy ? "ã‚ã‚Š" : "ãªã—") + "\n\n";
      }
      
      if (confirmInfo) {
        finalContent = confirmInfo + finalContent;
      }
      
      var reporter = currentTag + '_' + reporterName;
      
      google.script.run
        .withSuccessHandler(onSendSuccess)
        .withFailureHandler(onSendFailure)
        .sendReportWithAudio(
          currentPatient.id,
          currentPatient.name,
          currentTag,
          reporter,
          selectedScenario,
          finalContent,
          imageUrls,
          "",
          audioUrl,
          reporterRole || 'nurse',
          isUrgent || false,
          startTime,
          endTime
        );
    }
    
    function onSendSuccess(res) {
      var btn = document.getElementById('sendBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ“¤ é€ä¿¡";
      
      if (res && res.success) {
        // é€ä¿¡å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showQuickMessage('âœ… é€ä¿¡ã—ã¾ã—ãŸ');
        
        // 2ç§’å¾Œã«ç”»é¢é·ç§»
        setTimeout(function() {
          if (currentTag === "æ‚£è€…æœ¬äºº") {
            showPatientDetail(currentPatient.id);
          } else {
            backToPatientList();
          }
        }, 2000);
      } else {
        alert("ã‚¨ãƒ©ãƒ¼: " + (res.msg || "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      }
    }
    
    function showQuickMessage(message) {
      var msgDiv = document.createElement('div');
      msgDiv.className = 'quick-message';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      
      setTimeout(function() {
        if (msgDiv.parentNode) {
          document.body.removeChild(msgDiv);
        }
      }, 2000);
    }
    
    function onSendFailure(error) {
      var btn = document.getElementById('sendBtn');
      btn.disabled = false;
      btn.textContent = "ğŸ“¤ é€ä¿¡";
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (error.message || error));
    }
    
    function showError(msg) {
      var box = document.getElementById('errorBox');
      box.textContent = msg;
      box.style.display = 'block';
    }
    
    function hideError() {
      document.getElementById('errorBox').style.display = 'none';
    }
    
    // ä¿®æ­£è€…åã‚’å…¥åŠ›ã•ã›ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function promptEditorName(callback) {
      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¿ã‚°ã‚„ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼åã‹ã‚‰æ¨æ¸¬
      var defaultName = "";
      var reporterInput = document.getElementById('reporterName');
      if (reporterInput && reporterInput.value.trim()) {
        defaultName = reporterInput.value.trim();
      }
      
      var name = prompt('ä¿®æ­£è€…ã®ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', defaultName);
      if (name === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      if (!name.trim()) {
        alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      callback(name.trim());
    }
    
    // è¨˜éŒ²ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
    function editRecord(reportId, recordId) {
      var element = document.getElementById(recordId);
      if (!element) {
        alert('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      var currentText = element.textContent.trim();
      var parentDiv = element.parentElement;
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ç½®ãæ›ãˆ
      var textarea = document.createElement('textarea');
      textarea.id = 'edit_' + recordId;
      textarea.value = currentText;
      textarea.style.width = '100%';
      textarea.style.minHeight = '150px';
      textarea.style.padding = '8px';
      textarea.style.fontSize = '12px';
      textarea.style.fontFamily = 'inherit';
      textarea.style.border = '2px solid #ff9800';
      textarea.style.borderRadius = '4px';
      textarea.style.marginTop = '8px';
      textarea.style.boxSizing = 'border-box';
      
      element.style.display = 'none';
      parentDiv.appendChild(textarea);
      
      // ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      var btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '8px';
      btnContainer.style.display = 'flex';
      btnContainer.style.gap = '8px';
      
      var saveBtn = document.createElement('button');
      saveBtn.textContent = 'ğŸ’¾ ä¿å­˜';
      saveBtn.style.padding = '8px 16px';
      saveBtn.style.background = '#4caf50';
      saveBtn.style.color = 'white';
      saveBtn.style.border = 'none';
      saveBtn.style.borderRadius = '6px';
      saveBtn.style.cursor = 'pointer';
      saveBtn.style.fontWeight = 'bold';
      saveBtn.onclick = function() {
        promptEditorName(function(editorName) {
          saveEditedRecord(reportId, recordId, textarea.value, editorName);
        });
      };
      
      var cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelBtn.style.padding = '8px 16px';
      cancelBtn.style.background = '#f44336';
      cancelBtn.style.color = 'white';
      cancelBtn.style.border = 'none';
      cancelBtn.style.borderRadius = '6px';
      cancelBtn.style.cursor = 'pointer';
      cancelBtn.style.fontWeight = 'bold';
      cancelBtn.onclick = function() {
        cancelEdit(recordId);
      };
      
      btnContainer.appendChild(saveBtn);
      btnContainer.appendChild(cancelBtn);
      btnContainer.id = 'btns_' + recordId;
      
      parentDiv.appendChild(btnContainer);
    }
    
    // ç·¨é›†ã‚’ä¿å­˜ï¼ˆä¿®æ­£è€…åä»˜ãï¼‰
    function saveEditedRecord(reportId, recordId, editedText, editorName) {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success) {
            // è¡¨ç¤ºã‚’æ›´æ–°
            var element = document.getElementById(recordId);
            element.innerHTML = editedText.replace(/\n/g, '<br>');
            element.style.display = 'block';
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¨ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
            var textarea = document.getElementById('edit_' + recordId);
            var btns = document.getElementById('btns_' + recordId);
            if (textarea) textarea.remove();
            if (btns) btns.remove();
            
            showQuickMessage('âœ… ä¿®æ­£ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ' + editorName + 'ï¼‰');
          } else {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.msg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .updateManualSummary(reportId, editedText, editorName);
    }
    
    // è¿½è¨˜ãƒ¢ãƒ¼ãƒ‰
    function appendRecord(reportId, recordId) {
      var element = document.getElementById(recordId);
      if (!element) {
        alert('è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      var parentDiv = element.parentElement;
      
      // æ—¢ã«è¿½è¨˜ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
      var existingAppend = document.getElementById('append_' + recordId);
      if (existingAppend) {
        existingAppend.remove();
        var existingBtns = document.getElementById('appendbtns_' + recordId);
        if (existingBtns) existingBtns.remove();
        return;
      }
      
      // è¿½è¨˜ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
      var textarea = document.createElement('textarea');
      textarea.id = 'append_' + recordId;
      textarea.placeholder = 'è¿½è¨˜å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
      textarea.style.width = '100%';
      textarea.style.minHeight = '80px';
      textarea.style.padding = '8px';
      textarea.style.fontSize = '12px';
      textarea.style.fontFamily = 'inherit';
      textarea.style.border = '2px solid #00bcd4';
      textarea.style.borderRadius = '4px';
      textarea.style.marginTop = '8px';
      textarea.style.boxSizing = 'border-box';
      
      parentDiv.appendChild(textarea);
      
      // è¿½è¨˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      var btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '8px';
      btnContainer.style.display = 'flex';
      btnContainer.style.gap = '8px';
      btnContainer.id = 'appendbtns_' + recordId;
      
      var appendBtn = document.createElement('button');
      appendBtn.textContent = 'ğŸ“ è¿½è¨˜ã‚’ä¿å­˜';
      appendBtn.style.padding = '8px 16px';
      appendBtn.style.background = '#00bcd4';
      appendBtn.style.color = 'white';
      appendBtn.style.border = 'none';
      appendBtn.style.borderRadius = '6px';
      appendBtn.style.cursor = 'pointer';
      appendBtn.style.fontWeight = 'bold';
      appendBtn.onclick = function() {
        var appendText = textarea.value.trim();
        if (!appendText) {
          alert('è¿½è¨˜å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        promptEditorName(function(editorName) {
          saveAppendRecord(reportId, recordId, appendText, editorName);
        });
      };
      
      var cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelBtn.style.padding = '8px 16px';
      cancelBtn.style.background = '#f44336';
      cancelBtn.style.color = 'white';
      cancelBtn.style.border = 'none';
      cancelBtn.style.borderRadius = '6px';
      cancelBtn.style.cursor = 'pointer';
      cancelBtn.style.fontWeight = 'bold';
      cancelBtn.onclick = function() {
        textarea.remove();
        btnContainer.remove();
      };
      
      btnContainer.appendChild(appendBtn);
      btnContainer.appendChild(cancelBtn);
      parentDiv.appendChild(btnContainer);
      
      textarea.focus();
    }
    
    // è¿½è¨˜ã‚’ä¿å­˜
    function saveAppendRecord(reportId, recordId, appendText, editorName) {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success) {
            // è¡¨ç¤ºã‚’æ›´æ–°
            var element = document.getElementById(recordId);
            element.innerHTML = res.summary.replace(/\n/g, '<br>');
            
            // è¿½è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤
            var textarea = document.getElementById('append_' + recordId);
            var btns = document.getElementById('appendbtns_' + recordId);
            if (textarea) textarea.remove();
            if (btns) btns.remove();
            
            showQuickMessage('âœ… è¿½è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ' + editorName + 'ï¼‰');
          } else {
            alert('è¿½è¨˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.msg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .appendToSummary(reportId, appendText, editorName);
    }
    
    // ä¿®æ­£æ­´ã‚’è¡¨ç¤º
    function showEditHistory(reportId) {
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success) {
            var msg = 'ğŸ“œ ä¿®æ­£æ­´\n\n';
            
            if (!res.manualEdit && !res.editLog) {
              msg += 'ã“ã®è¨˜éŒ²ã¯ã¾ã ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
            } else {
              if (res.lastEditor) {
                msg += 'æœ€çµ‚ä¿®æ­£è€…: ' + res.lastEditor + '\n';
              }
              if (res.lastEditDate) {
                msg += 'æœ€çµ‚ä¿®æ­£æ—¥æ™‚: ' + res.lastEditDate + '\n';
              }
              msg += '\n--- ä¿®æ­£ãƒ­ã‚° ---\n';
              msg += res.editLog || 'ï¼ˆãƒ­ã‚°ãªã—ï¼‰';
            }
            
            alert(msg);
          } else {
            alert('ä¿®æ­£æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.msg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .getEditHistory(reportId);
    }
    
    // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit(recordId) {
      var element = document.getElementById(recordId);
      element.style.display = 'block';
      
      var textarea = document.getElementById('edit_' + recordId);
      var btns = document.getElementById('btns_' + recordId);
      if (textarea) textarea.remove();
      if (btns) btns.remove();
    }
    
    // ã‚µãƒãƒªãƒ¼ã‚’å†ç”Ÿæˆ
    function regenerateRecord(reportId, recordId) {
      if (!confirm('ä¿®æ­£å†…å®¹ã‚’è¸ã¾ãˆã¦ã€ã‚µãƒãƒªãƒ¼ã‚’å†ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      showQuickMessage('ğŸ”„ å†ç”Ÿæˆä¸­...');
      
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success) {
            // è¡¨ç¤ºã‚’æ›´æ–°
            var element = document.getElementById(recordId);
            element.innerHTML = res.summary.replace(/\n/g, '<br>');
            
            showQuickMessage('âœ… å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
          } else {
            alert('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (res.msg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .regenerateSummaryWithContext(reportId);
    }
  </script>
  
  <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="photo-modal">
    <video id="photoVideo" autoplay playsinline style="display:none;"></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>
    <img id="photoPreview" style="display:none;">
    
    <div class="photo-controls">
      <button id="captureBtn" onclick="capturePhoto()" style="display:none;">ğŸ“· æ’®å½±</button>
      <button id="confirmPhotoBtn" onclick="confirmPhoto()" style="display:none; background:#4caf50;">âœ“ ã“ã®å†™çœŸã‚’ä½¿ã†</button>
      <button onclick="closePhotoModal()" style="background:#f44336;">âœ• é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <!-- æ™‚é–“ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="timeDialog" class="time-dialog-overlay">
    <div class="time-dialog">
      <h3>â° è¨ªå•æ™‚é–“ã®ç¢ºèª</h3>
      
      <div class="time-input-group">
        <label>é–‹å§‹æ™‚åˆ»</label>
        <input type="datetime-local" id="dialogStartTime">
      </div>
      
      <div class="time-input-group">
        <label>çµ‚äº†æ™‚åˆ»</label>
        <input type="datetime-local" id="dialogEndTime">
      </div>
      
      <div class="time-dialog-buttons">
        <button class="btn-confirm" onclick="confirmTime()">âœ“ ã“ã®æ™‚åˆ»ã§é€ä¿¡</button>
        <button class="btn-cancel" onclick="cancelTime()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
</body>
</html>
