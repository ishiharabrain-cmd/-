<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š - ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .setting-group {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .setting-group:last-child {
            border-bottom: none;
        }

        h2 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 1.1em;
            color: #666;
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .button {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        .save-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .back-button {
            background: #f0f0f0;
            color: #333;
        }

        .success-message {
            display: none;
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">âš™ï¸ è¨­å®š</h1>
        
        <div class="success-message" id="successMessage">
            è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ!
        </div>

        <form id="settingsForm">
            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="setting-group">
                <h2>ğŸ‘¤ åŸºæœ¬æƒ…å ±</h2>
                <label>ãŠåå‰</label>
                <input type="text" id="userName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
                
                <label>è‡ªå®…ä½æ‰€ï¼ˆå®¶ã«å¸°ã‚‹æ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰</label>
                <input type="text" id="homeAddress" placeholder="ä¾‹ï¼šæ±äº¬éƒ½ã€‡ã€‡åŒºã€‡ã€‡1-2-3" autocomplete="street-address">
            </div>

            <!-- å®¶æ—é€£çµ¡å…ˆ -->
            <div class="setting-group">
                <h2>ğŸ“ å®¶æ—ã®é€£çµ¡å…ˆ</h2>
                <label>å®¶æ—1 - åå‰</label>
                <input type="text" id="family1Name" placeholder="ä¾‹ï¼šå±±ç”°èŠ±å­">
                
                <label>å®¶æ—1 - é›»è©±ç•ªå·</label>
                <input type="tel" id="family1Phone" placeholder="ä¾‹ï¼š090-1234-5678">
                
                <label>å®¶æ—2 - åå‰</label>
                <input type="text" id="family2Name" placeholder="ä¾‹ï¼šå±±ç”°æ¬¡éƒ">
                
                <label>å®¶æ—2 - é›»è©±ç•ªå·</label>
                <input type="tel" id="family2Phone" placeholder="ä¾‹ï¼š090-8765-4321">
                
                <label>å†™çœŸã®é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="familyEmail" placeholder="ä¾‹ï¼šfamily@example.com">
            </div>

            <!-- ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ± -->
            <div class="setting-group">
                <h2>ğŸ¥ ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±</h2>
                <label>ã‚¯ãƒªãƒ‹ãƒƒã‚¯å</label>
                <input type="text" id="clinicName" placeholder="ä¾‹ï¼šè„³ã¨ã“ã“ã‚ã®çŸ³åŸã‚¯ãƒªãƒ‹ãƒƒã‚¯" value="è„³ã¨ã“ã“ã‚ã®çŸ³åŸã‚¯ãƒªãƒ‹ãƒƒã‚¯">
                
                <label>ã‚¯ãƒªãƒ‹ãƒƒã‚¯é›»è©±ç•ªå·</label>
                <input type="tel" id="clinicPhone" placeholder="ä¾‹ï¼š022-123-4567">
            </div>

            <!-- æœè–¬æ™‚é–“ï¼ˆå›æ•°ãƒ»æ™‚é–“ãƒ»é£Ÿå‰/é£Ÿå¾Œï¼‰ -->
            <div class="setting-group">
                <h2>ğŸ’Š ãŠè–¬ã®æ™‚é–“</h2>
                <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">1æ—¥ä½•å›ã‹ã€ãã‚Œãã‚Œã®æ™‚é–“ã¨é£Ÿå‰ãƒ»é£Ÿå¾Œã‚’è¨­å®šã—ã¾ã™ã€‚</p>
                <label>1æ—¥ã®æœè–¬å›æ•°</label>
                <select id="medicineCount" style="margin-bottom: 15px;">
                    <option value="1">1å›</option>
                    <option value="2">2å›</option>
                    <option value="3">3å›</option>
                    <option value="4">4å›</option>
                    <option value="5">5å›</option>
                    <option value="6">6å›</option>
                </select>
                <div id="medicineDosesContainer"></div>
            </div>

            <!-- é€ä¿¡æ–¹æ³•ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ -->
            <div class="setting-group">
                <h2>ğŸ“¤ å†™çœŸã®é€ä¿¡æ–¹æ³•</h2>
                <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡æ–¹æ³•</label>
                <select id="defaultSendMethod">
                    <option value="ask">æ¯å›é¸æŠã™ã‚‹</option>
                    <option value="line">LINE</option>
                    <option value="email">ãƒ¡ãƒ¼ãƒ«</option>
                </select>
            </div>

            <!-- ã‚¢ãƒ—ãƒªã®æ›´æ–° -->
            <div class="setting-group" id="updateSection">
                <h2>ğŸ”„ ã‚¢ãƒ—ãƒªã®æ›´æ–°</h2>
                <p style="color: #666; margin-bottom: 10px;">ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <strong id="currentVersionDisplay">--</strong></p>
                <div id="updateButtonArea" style="display: none;">
                    <p style="color: #e65100; margin-bottom: 10px; font-size: 0.95em;">æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
                    <button type="button" class="button" id="reloadNewVersionBtn" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        ğŸ”„ æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§èª­ã¿è¾¼ã‚€
                    </button>
                </div>
                <p id="alreadyLatestMessage" style="color: #2e7d32; margin-top: 8px; font-size: 0.9em; display: none;">æœ€æ–°ç‰ˆã‚’ã”åˆ©ç”¨ä¸­ã§ã™ã€‚</p>
            </div>

            <button type="submit" class="button save-button">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <button type="button" class="button back-button" onclick="goBack()">ğŸ  ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹</button>
        </form>
    </div>

    <script>
        // é…å¸ƒä¸­ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆãƒªãƒªãƒ¼ã‚¹æ™‚ã«ã“ã®å€¤ã¨ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã® APP_VERSION ã‚’åˆã‚ã›ã‚‹ï¼‰
        const RELEASED_VERSION = '1.1.2';

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒï¼ˆreleased ã®æ–¹ãŒæ–°ã—ã‘ã‚Œã° trueï¼‰
        function isNewerVersion(released, current) {
            if (!current) return true;
            const r = released.split('.').map(Number);
            const c = current.split('.').map(Number);
            for (let i = 0; i < Math.max(r.length, c.length); i++) {
                const rn = r[i] || 0, cn = c[i] || 0;
                if (rn > cn) return true;
                if (rn < cn) return false;
            }
            return false;
        }

        // æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§èª­ã¿è¾¼ã‚€ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã—ã¦ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿ï¼‰
        function loadNewVersion() {
            const mainUrl = 'orientation-support-app.html?nocache=' + Date.now();
            if ('caches' in window) {
                caches.keys().then(function(keys) {
                    return Promise.all(keys.map(function(k) { return caches.delete(k); }));
                }).then(function() {
                    window.location.href = mainUrl;
                }).catch(function() {
                    window.location.href = mainUrl;
                });
            } else {
                window.location.href = mainUrl;
            }
        }

        // æœè–¬è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ—§å½¢å¼ã‹ã‚‰ç§»è¡Œç”¨ï¼‰
        function getDefaultDoses() {
            const raw = localStorage.getItem('medicineDoses');
            if (raw) {
                try {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr) && arr.length >= 1) return arr;
                } catch (e) {}
            }
            return [
                { key: 'dose0', label: '1å›ç›®', time: localStorage.getItem('medicineMorning') || '08:00', timing: 'other' },
                { key: 'dose1', label: '2å›ç›®', time: localStorage.getItem('medicineLunch') || '12:00', timing: 'other' },
                { key: 'dose2', label: '3å›ç›®', time: localStorage.getItem('medicineEvening') || '18:00', timing: 'other' },
                { key: 'dose3', label: '4å›ç›®', time: localStorage.getItem('medicineNight') || '21:00', timing: 'other' }
            ];
        }

        function renderMedicineDoses() {
            const count = parseInt(document.getElementById('medicineCount').value, 10);
            const container = document.getElementById('medicineDosesContainer');
            const current = getDefaultDoses();
            container.innerHTML = '';
            const labels = ['1å›ç›®', '2å›ç›®', '3å›ç›®', '4å›ç›®', '5å›ç›®', '6å›ç›®'];
            for (let i = 0; i < count; i++) {
                const d = current[i] || { key: 'dose' + i, label: labels[i], time: '08:00', timing: 'other' };
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 18px; padding: 12px; background: #f8f9fa; border-radius: 10px;';
                div.innerHTML = `
                    <label style="display:block; margin-bottom: 6px;">${labels[i]}</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="time" id="medicineTime_${i}" value="${d.time}" style="padding: 10px;">
                        <select id="medicineTiming_${i}" style="padding: 10px;">
                            <option value="before" ${d.timing === 'before' ? 'selected' : ''}>é£Ÿå‰</option>
                            <option value="after" ${d.timing === 'after' ? 'selected' : ''}>é£Ÿå¾Œ</option>
                            <option value="other" ${d.timing === 'other' ? 'selected' : ''}>ãã®ä»–</option>
                        </select>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function saveMedicineDoses() {
            const count = parseInt(document.getElementById('medicineCount').value, 10);
            const labels = ['1å›ç›®', '2å›ç›®', '3å›ç›®', '4å›ç›®', '5å›ç›®', '6å›ç›®'];
            const doses = [];
            for (let i = 0; i < count; i++) {
                const timeEl = document.getElementById('medicineTime_' + i);
                const timingEl = document.getElementById('medicineTiming_' + i);
                if (timeEl && timingEl) {
                    doses.push({
                        key: 'dose' + i,
                        label: labels[i],
                        time: timeEl.value,
                        timing: timingEl.value
                    });
                }
            }
            localStorage.setItem('medicineDoses', JSON.stringify(doses));
        }

        // è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadSettings() {
            const settings = {
                userName: localStorage.getItem('userName') || '',
                homeAddress: localStorage.getItem('homeAddress') || '',
                family1Name: localStorage.getItem('family1Name') || '',
                family1Phone: localStorage.getItem('family1Phone') || '',
                family2Name: localStorage.getItem('family2Name') || '',
                family2Phone: localStorage.getItem('family2Phone') || '',
                familyEmail: localStorage.getItem('familyEmail') || '',
                clinicName: localStorage.getItem('clinicName') || 'è„³ã¨ã“ã“ã‚ã®çŸ³åŸã‚¯ãƒªãƒ‹ãƒƒã‚¯',
                clinicPhone: localStorage.getItem('clinicPhone') || '',
                defaultSendMethod: localStorage.getItem('defaultSendMethod') || 'ask'
            };

            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = settings[key];
            });

            var doses = getDefaultDoses();
            var countEl = document.getElementById('medicineCount');
            if (countEl) {
                countEl.value = Math.min(6, Math.max(1, doses.length));
                countEl.addEventListener('change', renderMedicineDoses);
            }
            renderMedicineDoses();
        }

        // è¨­å®šã‚’ä¿å­˜
        document.getElementById('settingsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const fields = [
                'userName', 'homeAddress', 'family1Name', 'family1Phone',
                'family2Name', 'family2Phone', 'familyEmail', 'clinicName',
                'clinicPhone', 'defaultSendMethod'
            ];

            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) localStorage.setItem(field, el.value);
            });

            saveMedicineDoses();

            // åˆå›èµ·å‹•ã®å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã¸
            const isFirstTime = localStorage.getItem('firstTime');
            if (isFirstTime === 'true') {
                localStorage.removeItem('firstTime');
                alert('è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚');
                window.location.href = 'orientation-support-app.html';
                return;
            }

            // é€šå¸¸ã®ä¿å­˜ã®å ´åˆã‚‚ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹
            const message = document.getElementById('successMessage');
            message.style.display = 'block';
            
            setTimeout(() => {
                window.location.href = 'orientation-support-app.html';
            }, 1500);
        });

        function goBack() {
            window.location.href = 'orientation-support-app.html';
        }

        // åˆæœŸåŒ–
        loadSettings();

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã¨æ›´æ–°ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        (function() {
            var current = localStorage.getItem('appVersion') || '';
            var el = document.getElementById('currentVersionDisplay');
            if (el) el.textContent = current || 'ï¼ˆä¸æ˜ï¼‰';
            var area = document.getElementById('updateButtonArea');
            var latestMsg = document.getElementById('alreadyLatestMessage');
            if (isNewerVersion(RELEASED_VERSION, current)) {
                if (area) area.style.display = 'block';
                if (latestMsg) latestMsg.style.display = 'none';
            } else {
                if (area) area.style.display = 'none';
                if (latestMsg) latestMsg.style.display = 'block';
            }
            var btn = document.getElementById('reloadNewVersionBtn');
            if (btn) btn.addEventListener('click', loadNewVersion);
        })();
        
        // åˆå›èµ·å‹•ãƒã‚§ãƒƒã‚¯
        const isFirstTime = localStorage.getItem('firstTime');
        if (isFirstTime === 'true') {
            document.getElementById('pageTitle').textContent = 'ğŸš€ åˆæœŸè¨­å®š';
            document.querySelector('.back-button').style.display = 'none';
            
            // èª¬æ˜ã‚’è¿½åŠ 
            const intro = document.createElement('div');
            intro.style.cssText = 'background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;';
            intro.innerHTML = `
                <p style="font-size: 1.2em; color: #1976d2; margin-bottom: 10px;">
                    <strong>ã‚ˆã†ã“ãï¼</strong>
                </p>
                <p style="color: #666;">
                    ã‚¢ãƒ—ãƒªã‚’ä½¿ã†å‰ã«ã€åŸºæœ¬æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚<br>
                    å¾Œã‹ã‚‰å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                </p>
            `;
            document.querySelector('.container').insertBefore(intro, document.getElementById('settingsForm'));
        }
    </script>
</body>
</html>
