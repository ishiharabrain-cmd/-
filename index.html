<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ä¼´èµ°è€… v2.0 - çŸ³åŸå…ˆç”Ÿä»•æ§˜</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&family=M+PLUS+Rounded+1c:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== çŸ³åŸå…ˆç”Ÿã‹ã‚‰ã®è¦æœ›ã‚’åæ˜  ===== */
/* 1. å¹´å·è¡¨ç¤ºï¼ˆ2026å¹´ãªã©ï¼‰- ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ  */
/* 2. æ–‡å­—ã‚µã‚¤ã‚º5æ®µéšï¼ˆæ¥µå°ã€œæ¥µå¤§ï¼‰ */
/* 3. çŠ¶æ³åˆ¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆåœ¨å®…/å¤–å‡ºï¼‰ã§è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ */
/* 4. ã‚·ãƒ³ã‚°ãƒ«ã‚¿ã‚¹ã‚¯é‡è¦– */
/* 5. Googleå®Œå…¨é€£æºï¼ˆåŒæœŸå‰æï¼‰ */

:root {
  /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ”¹å–„ï¼šã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ– */
  --bg: #FEFCF6;
  --bg-card: #FFFFFF;
  --bg-soft: #F5F2E8;
  --bg-accent: #FFF5E0;
  --text: #2A2419; /* ã‚ˆã‚Šæ¿ƒã */
  --text-sub: #5A5248; /* ã‚ˆã‚Šæ¿ƒã */
  --text-quiet: #8A8270; /* ã‚ˆã‚Šæ¿ƒã */
  --green: #4A7549; /* ã‚ˆã‚Šæ¿ƒã */
  --green-soft: #E5F0E5;
  --amber: #A36830; /* ã‚ˆã‚Šæ¿ƒã */
  --amber-soft: #FFF0D8;
  --blue: #3D5F8A; /* ã‚ˆã‚Šæ¿ƒã */
  --blue-soft: #E5EDF8;
  --rose: #A04545; /* ã‚ˆã‚Šæ¿ƒã */
  --rose-soft: #FBE5E5;
  --border: #D8D0C0; /* ã‚ˆã‚Šæ¿ƒã */
  --shadow-sm: 0 1px 4px rgba(42,36,25,0.08);
  --shadow-md: 0 4px 20px rgba(42,36,25,0.12);
  --r: 18px;
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
}

.theme-night {
  --bg: #1C1B1F;
  --bg-card: #262529;
  --bg-soft: #2C2B30;
  --text: #E5E0D8;
  --text-sub: #9A9288;
  --border: #3A3832;
  /* ã‚ã„ã•ã¤ãƒ»ãŠã—ã‚ƒã¹ã‚Šãƒœã‚¿ãƒ³ç”¨ï¼šèƒŒæ™¯ã‚’æš—ãã—ã¦æ–‡å­—ã‚’è¦‹ã‚„ã™ã */
  --rose-soft: #4A3030;
  --rose: #D08080;
  --amber-soft: #4A4030;
  --amber: #D0A850;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { font-size: 16px; }

/* æ–‡å­—ã‚µã‚¤ã‚º5æ®µéšï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Fire TVãƒ¬ãƒ™ãƒ«ï¼‰å…¨ä½“çš„ã«4ptå¤§ãã */
.text-xs { font-size: 109%; }
.text-sm { font-size: 129%; }
.text-md { font-size: 154%; }
.text-lg { font-size: 184%; }
.text-xl { font-size: 224%; }

body {
  font-family: 'Zen Maru Gothic', 'M PLUS Rounded 1c', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.8s var(--ease), color 0.5s var(--ease);
  -webkit-user-select: none;
  user-select: none;
  overflow: hidden;
}

.app {
  display: grid;
  grid-template-rows: auto 1fr auto;
  height: 100vh;
  padding: 20px 24px;
  gap: 16px;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left { display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap; }

.clock {
  font-size: clamp(2.8rem, 7vw, 4.5rem);
  font-weight: 700;
  letter-spacing: -0.03em;
  line-height: 1;
  color: var(--text);
  font-variant-numeric: tabular-nums;
}

.clock-colon {
  opacity: 1;
  animation: pulse-colon 2s ease-in-out infinite;
}

@keyframes pulse-colon {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}

.date-area {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.greeting-text {
  font-size: clamp(0.85rem, 1.8vw, 1.1rem);
  color: var(--green);
  font-weight: 500;
}

.date-text {
  font-size: clamp(1rem, 2.2vw, 1.4rem);
  font-weight: 700;
  color: var(--text);
}

/* å¹´å·è¡¨ç¤ºï¼ˆä»¤å’Œã‚‚è¿½åŠ ï¼‰ */
.year-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.7em;
  font-weight: 700;
  background: var(--bg-accent);
  color: var(--amber);
  margin-left: 8px;
  line-height: 1.2;
}

.weekday-badge {
  display: inline-block;
  padding: 1px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 700;
  margin-left: 6px;
}

.wd-sun { background: #FDDEDE; color: #B84C4C; }
.wd-sat { background: #DDEAFB; color: #4C6EB8; }
.wd-week { background: var(--green-soft); color: var(--green); }

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆåœ¨å®…/å¤–å‡ºï¼‰ */
.mode-switch {
  display: flex;
  gap: 6px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 4px;
}

.mode-btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-sub);
  cursor: pointer;
  transition: all 0.2s var(--ease);
}

.mode-btn.active {
  background: var(--green);
  color: white;
}

/* å¤©æ°—ï¼‹æœè£…ã‚¢ãƒ‰ãƒã‚¤ã‚¹ */
.weather {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow-sm);
  min-width: 160px;
}

.weather-top {
  display: flex;
  align-items: center;
  gap: 10px;
}

.weather-emoji { font-size: 1.8rem; }

.weather-detail { flex: 1; }

.weather-temp {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text);
}

.weather-label {
  font-size: 0.75rem;
  color: var(--text-sub);
}

.weather-advice {
  font-size: 0.8rem;
  color: var(--amber);
  font-weight: 600;
  background: var(--amber-soft);
  padding: 4px 10px;
  border-radius: 8px;
  text-align: center;
}

.settings-dots {
  display: flex;
  gap: 6px;
}

.dot-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  font-size: 0.85rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s var(--ease);
  color: var(--text-sub);
  opacity: 0.6;
}

.dot-btn:hover, .dot-btn.active { opacity: 1; border-color: var(--green); }

/* ===== ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ ===== */
.main {
  display: grid;
  grid-template-columns: 1.2fr 1fr 1fr;
  gap: 16px;
  min-height: 0;
  transition: all 0.3s var(--ease);
}

/* å¤–å‡ºãƒ¢ãƒ¼ãƒ‰ã§ã¯2æ®µæ§‹æˆï¼ˆä¸Š:å®¶ã«å¸°ã‚‹ ä¸‹:3ã‚«ãƒ©ãƒ ï¼‰ */
.main.mode-out {
  grid-template-columns: 1fr;
  grid-template-rows: auto 1fr;
  gap: 12px;
}

@media (max-width: 1024px) {
  .main { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 768px) {
  .main { grid-template-columns: 1fr; }
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow-md);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: card-in 0.6s var(--ease) both;
  transition: all 0.5s var(--ease);
}

.card.hidden { display: none; }

@keyframes card-in {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

.card-head {
  padding: 18px 22px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.card-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--text-quiet);
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.card-badge {
  font-size: 0.72rem;
  padding: 2px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.badge-green { background: var(--green-soft); color: var(--green); }
.badge-amber { background: var(--amber-soft); color: var(--amber); }
.badge-blue { background: var(--blue-soft); color: var(--blue); }

.card-body {
  flex: 1;
  overflow-y: auto;
  padding: 6px 0;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

/* ===== å¤–å‡ºãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ¼ãƒ‰ ===== */
.go-home-card {
  display: none;
  background: linear-gradient(135deg, var(--green) 0%, #4E7C4D 100%);
  border: none;
  padding: 24px 30px;
  text-align: center;
  color: white;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
}

.go-home-card.show { display: flex; }

.go-home-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.go-home-icon {
  font-size: 3rem;
}

.go-home-text {
  text-align: left;
}

.go-home-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.go-home-desc {
  font-size: 0.9rem;
  opacity: 0.9;
}

.go-home-btn {
  padding: 16px 32px;
  font-size: 1.3rem;
  font-weight: 700;
  border: none;
  border-radius: 14px;
  background: white;
  color: var(--green);
  cursor: pointer;
  transition: all 0.2s var(--ease);
  white-space: nowrap;
}

.go-home-btn:active { transform: scale(0.96); }

/* å¤–å‡ºãƒ¢ãƒ¼ãƒ‰ã®ä¸‹éƒ¨ã‚°ãƒªãƒƒãƒ‰ */
.out-bottom-grid {
  display: none;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}

.out-bottom-grid.show { display: grid; }

@media (max-width: 1024px) {
  .out-bottom-grid { grid-template-columns: 1fr; }
  .go-home-card { flex-direction: column; text-align: center; }
  .go-home-left { flex-direction: column; }
  .go-home-text { text-align: center; }
}

/* ===== ãƒœãƒˆãƒ ãƒãƒ¼ ===== */
.bottom {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  padding: 4px 0;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 24px;
  border: 2px solid var(--border);
  border-radius: 14px;
  background: var(--bg-card);
  font-family: inherit;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  transition: all 0.25s var(--ease);
  box-shadow: var(--shadow-sm);
}

.action-btn:active { transform: scale(0.96); }
.action-btn:hover { border-color: var(--green); box-shadow: var(--shadow-md); }

.action-btn-icon { font-size: 1.3rem; }

.action-primary {
  background: var(--green);
  border-color: var(--green);
  color: white;
}

.action-primary:hover { background: #4E7C4D; }

/* ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(8px);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s var(--ease);
}

.overlay.open { opacity: 1; pointer-events: all; }

.overlay-card {
  background: var(--bg-card);
  border-radius: 24px;
  padding: 36px;
  max-width: 420px;
  width: 90%;
  text-align: center;
  box-shadow: 0 8px 40px rgba(0,0,0,0.2);
  transform: translateY(16px);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.overlay.open .overlay-card { transform: translateY(0); }

.ol-icon { font-size: 3rem; margin-bottom: 14px; }
.ol-title { font-size: 1.3rem; font-weight: 700; color: var(--text); margin-bottom: 8px; }
.ol-body { font-size: 0.95rem; color: var(--text-sub); line-height: 1.7; margin-bottom: 24px; }

.ol-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

.ol-btn {
  padding: 14px 24px;
  border-radius: 12px;
  border: none;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s var(--ease);
}

.ol-btn:active { transform: scale(0.96); }
.ol-btn-green { background: var(--green); color: white; }
.ol-btn-soft { background: var(--bg-soft); color: var(--text-sub); }

/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å†…ã®éŸ³å£°ãƒœã‚¿ãƒ³ */
.voice-inline-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: linear-gradient(135deg, var(--green) 0%, #4E7C4D 100%);
  color: white;
  border: none;
  border-radius: 24px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(74, 117, 73, 0.35);
  transition: transform 0.2s var(--ease), box-shadow 0.2s var(--ease);
}
.voice-inline-btn:active { transform: scale(0.96); }

/* ã‚«ãƒ¼ãƒ‰ä¸‹ã®ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ï¼ˆä»Šæ—¥ã®äºˆå®šãƒ»ã‚„ã‚‹ã“ã¨ãƒ»ä»Šæ—¥ã®è¨˜éŒ²ï¼‰ */
.card-plus-row {
  padding: 14px 22px;
  border-top: 1px dashed var(--border);
  display: flex;
  justify-content: center;
  align-items: center;
}
.card-plus-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 24px;
  border-radius: 24px;
  border: 2px dashed var(--green);
  background: var(--green-soft);
  color: var(--green);
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s var(--ease);
  min-width: 140px;
}
.card-plus-btn:hover {
  background: var(--green);
  color: white;
  border-style: solid;
  transform: scale(1.02);
}
.card-plus-btn:active { transform: scale(0.98); }
.card-plus-btn .plus-icon { font-size: 1.4rem; }

/* GPSé€šçŸ¥ãƒãƒŠãƒ¼ */
.gps-banner {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--amber);
  color: white;
  padding: 16px 24px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  font-weight: 600;
  font-size: 1rem;
  z-index: 99;
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.gps-banner.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* ===== éŸ³å£°ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ ===== */
.voice-fab {
  position: fixed;
  bottom: 140px;
  right: 30px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--green) 0%, #4E7C4D 100%);
  color: white;
  border: 4px solid var(--bg);
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  cursor: pointer;
  transition: all 0.3s var(--ease);
  z-index: 50;
}

.voice-fab:hover {
  transform: scale(1.1);
  box-shadow: 0 12px 40px rgba(91,140,90,0.3);
}

.voice-fab:active {
  transform: scale(0.95);
}

.voice-fab.listening {
  animation: pulse-voice 1.5s ease-in-out infinite;
  background: linear-gradient(135deg, var(--rose) 0%, #A04545 100%);
}

@keyframes pulse-voice {
  0%, 100% { transform: scale(1); box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
  50% { transform: scale(1.15); box-shadow: 0 12px 50px rgba(184,92,92,0.4); }
}

/* éŸ³å£°èªè­˜ä¸­ã®ãƒãƒŠãƒ¼ */
.voice-banner {
  position: fixed;
  bottom: 240px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg-card);
  border: 2px solid var(--green);
  padding: 16px 24px;
  border-radius: 16px;
  box-shadow: var(--shadow-md);
  font-size: 1rem;
  font-weight: 600;
  color: var(--text);
  z-index: 49;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s var(--ease);
  min-width: 200px;
  text-align: center;
}

.voice-banner.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.voice-banner-text {
  margin-top: 8px;
  font-size: 0.85rem;
  color: var(--text-sub);
}

/* æ•°å­—ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
.numpad {
  position: fixed;
  bottom: 140px;
  left: 30px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: var(--shadow-md);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px);
  transition: all 0.3s var(--ease);
}

.numpad.show {
  opacity: 1;
  pointer-events: all;
  transform: translateY(0);
}

.numpad-key {
  width: 50px;
  height: 50px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: var(--bg-soft);
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s var(--ease);
}

.numpad-key:hover {
  background: var(--green-soft);
  border-color: var(--green);
}

.numpad-key:active {
  transform: scale(0.9);
}

@media (max-width: 768px) {
  .voice-fab {
    bottom: 100px;
    right: 20px;
    width: 70px;
    height: 70px;
    font-size: 1.8rem;
  }
  .voice-banner { bottom: 190px; }
  .numpad { left: 20px; bottom: 100px; }
}

/* ===== æ•°å­—ã‚¬ã‚¤ãƒ‰ãƒãƒƒã‚¸ ===== */
.number-badge {
  position: absolute;
  top: -8px;
  left: -8px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--rose);
  color: white;
  font-size: 1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.number-badge.show {
  opacity: 1;
}

.number-badge.blink {
  animation: blink-badge 2s ease-in-out infinite;
}

@keyframes blink-badge {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.1); }
}

/* ç‚¹æ»…ã¯30ç§’å¾Œã«åœæ­¢ */
.number-badge.blink-stop {
  animation: none;
}
</style>
</head>
<body class="text-md">

<div class="app">

  <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
  <header class="header">
    <div class="header-left">
      <div class="clock" id="clock">--<span class="clock-colon">:</span>--</div>
      <div class="date-area">
        <div class="greeting-text" id="greeting">ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™</div>
        <div class="date-text" id="dateText">
          <span id="dateDisplay">--</span>
          <span class="year-badge" id="yearBadge">2026å¹´</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
      <div class="mode-switch">
        <button class="mode-btn active" onclick="switchMode('home')" id="btnHome">ğŸ  åœ¨å®…</button>
        <button class="mode-btn" onclick="switchMode('out')" id="btnOut">ğŸš¶ å¤–å‡º</button>
      </div>
      <!-- å¤©æ°—ï¼‹æœè£… -->
      <div class="weather">
        <div class="weather-top">
          <span class="weather-emoji">â˜€ï¸</span>
          <div class="weather-detail">
            <div class="weather-temp">8Â°</div>
            <div class="weather-label">ä»™å° ã¯ã‚Œ</div>
          </div>
        </div>
        <div class="weather-advice" id="clothAdvice">ã‚³ãƒ¼ãƒˆã‚’ç€ã¦ã­</div>
      </div>
      <!-- è¨­å®š -->
      <div class="settings-dots">
        <button class="dot-btn" onclick="cycleTextSize()" title="æ–‡å­—ã‚µã‚¤ã‚º" id="btnText">ã‚</button>
        <button class="dot-btn" onclick="toggleKana()" title="ã²ã‚‰ãŒãª" id="btnKana">ã²</button>
        <button class="dot-btn" onclick="toggleNight()" title="å¤œãƒ¢ãƒ¼ãƒ‰" id="btnNight">ğŸŒ™</button>
        <button class="dot-btn" onclick="openOverlay('settings')" title="è¨­å®š" id="btnSettings">âš™ï¸</button>
      </div>
    </div>
  </header>

  <!-- ===== ãƒ¡ã‚¤ãƒ³ ===== -->
  <main class="main" id="mainArea">
    
    <!-- åœ¨å®…ãƒ¢ãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ï¼ˆé€šå¸¸3ã‚«ãƒ©ãƒ ï¼‰ -->
    <div class="card" id="card1">
      <div class="card-head">
        <div class="card-label"><span>ğŸ“…</span> <span data-i18n="cal">ã•ã„ãã‚“ã® ã‚ˆã¦ã„</span></div>
        <button onclick="openOverlay('add-event')" style="background: var(--green); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--ease);" title="äºˆå®šã‚’è¿½åŠ ">â•</button>
      </div>
      <div class="card-body">
        <div style="padding: 32px 22px; text-align: center; color: var(--text-quiet);">
          èª­ã¿è¾¼ã¿ä¸­â€¦
        </div>
      </div>
    </div>

    <div class="card" id="card2">
      <div class="card-head">
        <div class="card-label"><span>âœ…</span> <span data-i18n="todo">ã‚„ã‚‹ã“ã¨</span></div>
        <button onclick="openOverlay('add-todo')" style="background: var(--green); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--ease);" title="Todoã‚’è¿½åŠ ">â•</button>
      </div>
      <div class="card-body">
        <div style="padding: 32px 22px; text-align: center; color: var(--text-quiet);">
          Google Todoã¨åŒæœŸã—ã¾ã™
        </div>
      </div>
    </div>

    <div class="card" id="card3">
      <div class="card-head">
        <div class="card-label"><span>ğŸ“</span> <span data-i18n="log">ãã‚‡ã†ã® ãã‚ã</span></div>
        <button onclick="openOverlay('log-history')" style="background: var(--amber); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--ease);" title="è¨˜éŒ²ã®å±¥æ­´ã‚’è¦‹ã‚‹">ğŸ“‹</button>
      </div>
      <div class="card-body">
        <div style="padding: 32px 22px; text-align: center; color: var(--text-quiet);">
          ä»Šæ—¥ã®è¨˜éŒ²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </div>
    </div>

    <!-- å¤–å‡ºãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ¼ãƒ‰ï¼ˆä¸Šéƒ¨ï¼šå®¶ã«å¸°ã‚‹ï¼‰ -->
    <div class="card go-home-card" id="cardGoHome">
      <div class="go-home-left">
        <div class="go-home-icon">ğŸ </div>
        <div class="go-home-text">
          <div class="go-home-title" data-i18n="gohome">ã„ãˆã« ã‹ãˆã‚‹</div>
          <div class="go-home-desc">ãŠã†ã¡ã¾ã§ã® ã¿ã¡</div>
        </div>
      </div>
      <button class="go-home-btn" onclick="openMap()">ğŸ—ºï¸ ã¿ã¡ã‚ã‚“ãªã„</button>
    </div>

    <!-- å¤–å‡ºãƒ¢ãƒ¼ãƒ‰ä¸‹éƒ¨ã‚°ãƒªãƒƒãƒ‰ï¼ˆè²·ã„ç‰©ãƒ»äºˆå®šï¼‰ -->
    <div class="out-bottom-grid" id="outBottomGrid">
      <!-- è²·ã„ç‰©ãƒªã‚¹ãƒˆ -->
      <div class="card">
        <div class="card-head">
          <div class="card-label"><span>ğŸ›’</span> <span data-i18n="shopping">ã‹ã„ã‚‚ã®ãƒªã‚¹ãƒˆ</span></div>
          <span class="card-badge badge-amber">Google Keep</span>
        </div>
        <div class="card-body" id="shoppingBody">
          <div style="padding: 16px 22px;">
            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 12px;">ä»Šæ—¥è²·ã†ã‚‚ã®</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-soft); border-radius: 10px; cursor: pointer;">
                <input type="checkbox" style="width: 20px; height: 20px;">
                <span style="font-size: 0.95rem;">ğŸ¥› ç‰›ä¹³</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-soft); border-radius: 10px; cursor: pointer;">
                <input type="checkbox" style="width: 20px; height: 20px;">
                <span style="font-size: 0.95rem;">ğŸ ãƒ‘ãƒ³</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-soft); border-radius: 10px; cursor: pointer;">
                <input type="checkbox" style="width: 20px; height: 20px;">
                <span style="font-size: 0.95rem;">ğŸ¥š ãŸã¾ã”</span>
              </label>
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
              <div style="font-size: 0.75rem; color: var(--text-quiet); margin-bottom: 8px;">å‰å›è²·ã£ãŸã‚‚ã®ï¼ˆ2/11ï¼‰</div>
              <div style="font-size: 0.85rem; color: var(--text-sub); line-height: 1.6;">ç‰›ä¹³ã€ãƒ‘ãƒ³ã€ãƒãƒŠãƒŠã€ãŸã¾ã”</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä»Šæ—¥ã®äºˆå®š -->
      <div class="card">
        <div class="card-head">
          <div class="card-label"><span>ğŸ“…</span> <span data-i18n="today">ãã‚‡ã†ã® ã‚ˆã¦ã„</span></div>
          <span class="card-badge badge-green">ä»Šæ—¥</span>
        </div>
        <div class="card-body">
          <div style="padding: 16px 22px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="font-size: 0.95rem; font-weight: 700; color: var(--text);">14:00</div>
              <div style="flex: 1;">
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text);">ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</div>
                <div style="font-size: 0.8rem; color: var(--text-sub);">ãŠè¿ãˆãŒæ¥ã¾ã™</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 0.95rem; font-weight: 700; color: var(--text);">18:30</div>
              <div style="flex: 1;">
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text);">å¤œã®æœè–¬</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ˜æ—¥ã®äºˆå®š -->
      <div class="card">
        <div class="card-head">
          <div class="card-label"><span>ğŸ“†</span> <span data-i18n="tomorrow">ã‚ã—ãŸã® ã‚ˆã¦ã„</span></div>
          <span class="card-badge badge-blue">æ˜æ—¥</span>
        </div>
        <div class="card-body">
          <div style="padding: 16px 22px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="font-size: 0.95rem; font-weight: 700; color: var(--text);">8:00</div>
              <div style="flex: 1;">
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text);">ã‚´ãƒŸå‡ºã—</div>
                <div style="font-size: 0.8rem; color: var(--text-sub);">ç‡ƒãˆã‚‹ã‚´ãƒŸ</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 0.95rem; font-weight: 700; color: var(--text);">10:00</div>
              <div style="flex: 1;">
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text);">çŸ³åŸã‚¯ãƒªãƒ‹ãƒƒã‚¯</div>
                <div style="font-size: 0.8rem; color: var(--text-sub);">è–¬ã‚’ã‚‚ã‚‰ã†</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- ===== ãƒœãƒˆãƒ  ===== -->
  <footer class="bottom" id="bottomBar">
    <button class="action-btn action-primary" onclick="openOverlay('log')" style="position: relative;">
      <span class="number-badge show blink" id="badge-2">2</span>
      <span class="action-btn-icon">ğŸ“</span>
      <span data-i18n="btn-log">è¨˜éŒ²ã™ã‚‹</span>
    </button>
    <!-- ã‚ã„ã•ã¤ãƒœã‚¿ãƒ³ï¼ˆè¿·å­æœ­ï¼‰ -->
    <button class="action-btn" onclick="openOverlay('idcard')" style="background: var(--rose-soft); border-color: var(--rose); position: relative;">
      <span class="number-badge show blink" id="badge-9">9</span>
      <span class="action-btn-icon">ğŸ†”</span>
      <span data-i18n="btn-idcard">ã‚ã„ã•ã¤</span>
    </button>
    <!-- éŸ³å£°ãƒœã‚¿ãƒ³ï¼ˆã‚ã„ã•ã¤ã®å³å´ã€å³åˆ©ãç”¨ï¼‰ -->
    <button class="action-btn" onclick="toggleVoice()" style="background: linear-gradient(135deg, var(--green) 0%, #4E7C4D 100%); border-color: var(--green); color: white; position: relative;">
      <span class="number-badge show blink" id="badge-voice" style="background: white; color: var(--green);">ğŸ¤</span>
      <span class="action-btn-icon">ğŸ¤</span>
      <span data-i18n="btn-voice">éŸ³å£°</span>
    </button>
    <button class="action-btn" onclick="openOverlay('call')" style="position: relative;">
      <span class="number-badge show blink" id="badge-4">4</span>
      <span class="action-btn-icon">ğŸ“</span>
      <span data-i18n="btn-call">é›»è©±</span>
    </button>
    <button class="action-btn" onclick="openOverlay('video')" style="position: relative;">
      <span class="number-badge show blink" id="badge-3">3</span>
      <span class="action-btn-icon">ğŸ“º</span>
      <span data-i18n="btn-video">å‹•ç”»</span>
    </button>
    <button class="action-btn" onclick="openOverlay('places')" style="position: relative;">
      <span class="number-badge show blink" id="badge-8">8</span>
      <span class="action-btn-icon">ğŸ—ºï¸</span>
      <span data-i18n="btn-places">å ´æ‰€</span>
    </button>
    <!-- ãŠã—ã‚ƒã¹ã‚Šãƒœã‚¿ãƒ³ï¼ˆä¸€ç•ªå³ã€æœ‰æ–™ãƒãƒ¼ã‚¯ï¼‰ -->
    <button class="action-btn" onclick="openOverlay('chat')" style="background: var(--amber-soft); border-color: var(--amber); position: relative;">
      <span class="number-badge show blink" id="badge-6">6</span>
      <span class="action-btn-icon">ğŸ’¬</span>
      <span data-i18n="btn-chat">ãŠã—ã‚ƒã¹ã‚Š</span>
      <span style="position: absolute; top: -6px; right: -6px; background: var(--amber); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; font-weight: 700;">â­æœ‰æ–™</span>
    </button>
    <!-- å¤–å‡ºãƒ¢ãƒ¼ãƒ‰ã§è¿½åŠ  -->
    <button class="action-btn" id="btnReceipt" style="display: none; position: relative;" onclick="openOverlay('receipt')">
      <span class="action-btn-icon">ğŸ“·</span>
      <span data-i18n="btn-receipt">ãƒ¬ã‚·ãƒ¼ãƒˆ</span>
    </button>
  </footer>

</div>

<!-- GPSé€šçŸ¥ãƒãƒŠãƒ¼ -->
<div class="gps-banner" id="gpsBanner">
  ğŸ“ ã‚¹ãƒ¼ãƒ‘ãƒ¼ã«ç€ãã¾ã—ãŸ<br>è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’è¦‹ã¾ã™ã‹ï¼Ÿ
</div>

<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ï¼‰ -->
<div class="overlay" id="overlay" onclick="closeOverlay(event)">
  <div class="overlay-card" id="olCard" onclick="event.stopPropagation()"></div>
</div>


<!-- éŸ³å£°èªè­˜ãƒãƒŠãƒ¼ -->
<div class="voice-banner" id="voiceBanner">
  <div>ğŸ¤ èã„ã¦ã„ã¾ã™...</div>
  <div class="voice-banner-text" id="voiceText">ä½•ã‹ãŠè©±ã—ãã ã•ã„</div>
</div>

<!-- æ•°å­—ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ -->
<div class="numpad" id="numpad">
  <button class="numpad-key" onclick="executeCommand(1)">1</button>
  <button class="numpad-key" onclick="executeCommand(2)">2</button>
  <button class="numpad-key" onclick="executeCommand(3)">3</button>
  <button class="numpad-key" onclick="executeCommand(4)">4</button>
  <button class="numpad-key" onclick="executeCommand(5)">5</button>
  <button class="numpad-key" onclick="executeCommand(6)">6</button>
  <button class="numpad-key" onclick="executeCommand(7)">7</button>
  <button class="numpad-key" onclick="executeCommand(8)">8</button>
  <button class="numpad-key" onclick="executeCommand(9)">9</button>
</div>

<script>
// ===== STATE =====
let currentMode = 'home'; // 'home' or 'out'
let kanaMode = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ¼¢å­—
let textLevel = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯mdï¼ˆFire TVãƒ¬ãƒ™ãƒ«ï¼š150%ï¼‰
let nightForced = false;
let isListening = false;
let recognition = null;
let synthesis = window.speechSynthesis;
let showNumberGuide = true; // æ•°å­—ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºï¼ˆè¨­å®šã§æ¶ˆã›ã‚‹ï¼‰
let currentVoiceOverlay = null; // å…¥åŠ›ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ï¼š'event' | 'todo' | 'log' | null

const textLevels = ['text-xs', 'text-sm', 'text-md', 'text-lg', 'text-xl'];

// ===== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ =====
let localEvents = []; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®š
let localTodos = []; // Todo
let localLogs = []; // è¨˜éŒ²ï¼ˆãƒ©ã‚¤ãƒ•ãƒ­ã‚°ï¼‰
let chatHistory = []; // ãƒãƒ£ãƒƒãƒˆå±¥æ­´

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
const STORAGE_KEYS = {
  EVENTS: 'banso_events',
  TODOS: 'banso_todos',
  LOGS: 'banso_logs',
  CHATS: 'banso_chats',
  SETTINGS: 'banso_settings',
  API_KEY: 'banso_api_key'
};

// éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
const VOICE_COMMANDS = {
  1: { keywords: ['ã„ã¡', '1', 'ãƒ¯ãƒ³', 'å®¶', 'ã„ãˆ', 'å¸°ã‚‹', 'ã‹ãˆã‚‹'], action: 'home', label: 'ğŸ  å®¶ã«å¸°ã‚‹' },
  2: { keywords: ['ã«', '2', 'ãƒ„ãƒ¼', 'è¨˜éŒ²', 'ãã‚ã', 'ã‚„ã£ãŸã“ã¨'], action: 'log', label: 'ğŸ“ è¨˜éŒ²ã™ã‚‹' },
  3: { keywords: ['ã•ã‚“', '3', 'ã‚¹ãƒªãƒ¼', 'å‹•ç”»', 'ã©ã†ãŒ', 'ãƒ“ãƒ‡ã‚ª'], action: 'video', label: 'ğŸ“º å‹•ç”»' },
  4: { keywords: ['ã‚ˆã‚“', '4', 'ãƒ•ã‚©ãƒ¼', 'é›»è©±', 'ã§ã‚“ã‚', 'ã‚³ãƒ¼ãƒ«'], action: 'call', label: 'ğŸ“ é›»è©±' },
  5: { keywords: ['ã”', '5', 'ãƒ•ã‚¡ã‚¤ãƒ–', 'ãƒ¡ãƒ¼ãƒ«', 'ã‚ãƒ¼ã‚‹'], action: 'mail', label: 'ğŸ“§ ãƒ¡ãƒ¼ãƒ«' },
  6: { keywords: ['ã‚ã', '6', 'ã‚·ãƒƒã‚¯ã‚¹', 'å£æ‰“ã¡', 'ã‹ã¹ã†ã¡', 'ç›¸è«‡', 'ãã†ã ã‚“'], action: 'chat', label: 'ğŸ’¬ å£æ‰“ã¡' },
  7: { keywords: ['ãªãª', 'ã—ã¡', '7', 'ã‚»ãƒ–ãƒ³', 'äºˆå®š', 'ã‚ˆã¦ã„', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«'], action: 'schedule', label: 'ğŸ“… äºˆå®š' },
  8: { keywords: ['ã¯ã¡', '8', 'ã‚¨ã‚¤ãƒˆ', 'å ´æ‰€', 'ã°ã—ã‚‡', 'åœ°å›³'], action: 'places', label: 'ğŸ—ºï¸ å ´æ‰€' },
  9: { keywords: ['ãã‚…ã†', 'ã', '9', 'ãƒŠã‚¤ãƒ³', 'ã‚ã„ã•ã¤', 'è¿·å­'], action: 'idcard', label: 'ğŸ†” ã‚ã„ã•ã¤' },
};

// ===== I18N =====
const I18N = {
  'cal': { h: 'ã•ã„ãã‚“ã® ã‚ˆã¦ã„', k: 'æœ€è¿‘ã®äºˆå®š' },
  'todo': { h: 'ã‚„ã‚‹ã“ã¨', k: 'ã‚„ã‚‹ã“ã¨' },
  'log': { h: 'ãã‚‡ã†ã® ãã‚ã', k: 'ä»Šæ—¥ã®è¨˜éŒ²' },
  'gohome': { h: 'ã„ãˆã« ã‹ãˆã‚‹', k: 'å®¶ã«å¸°ã‚‹' },
  'shopping': { h: 'ã‹ã„ã‚‚ã®ãƒªã‚¹ãƒˆ', k: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ' },
  'today': { h: 'ãã‚‡ã†ã® ã‚ˆã¦ã„', k: 'ä»Šæ—¥ã®äºˆå®š' },
  'tomorrow': { h: 'ã‚ã—ãŸã® ã‚ˆã¦ã„', k: 'æ˜æ—¥ã®äºˆå®š' },
  'btn-log': { h: 'ãã‚ãã™ã‚‹', k: 'è¨˜éŒ²ã™ã‚‹' },
  'btn-call': { h: 'ã§ã‚“ã‚', k: 'é›»è©±' },
  'btn-chat': { h: 'ãŠã—ã‚ƒã¹ã‚Š', k: 'ãŠã—ã‚ƒã¹ã‚Š' },
  'btn-video': { h: 'ã©ã†ãŒ', k: 'å‹•ç”»' },
  'btn-places': { h: 'ã°ã—ã‚‡', k: 'å ´æ‰€' },
  'btn-receipt': { h: 'ãƒ¬ã‚·ãƒ¼ãƒˆ', k: 'ãƒ¬ã‚·ãƒ¼ãƒˆ' },
  'btn-idcard': { h: 'ã‚ã„ã•ã¤', k: 'ã‚ã„ã•ã¤' },
  'btn-voice': { h: 'ãŠã‚“ã›ã„', k: 'éŸ³å£°' },
};

function applyI18N() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (I18N[key]) el.textContent = kanaMode ? I18N[key].h : I18N[key].k;
  });
}

// ===== ã‚¯ãƒ­ãƒƒã‚¯ =====
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  document.getElementById('clock').innerHTML = h + '<span class="clock-colon">:</span>' + m;

  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const y = now.getFullYear();
  const mo = now.getMonth() + 1;
  const d = now.getDate();
  const w = days[now.getDay()];
  const wClass = now.getDay() === 0 ? 'wd-sun' : now.getDay() === 6 ? 'wd-sat' : 'wd-week';

  document.getElementById('dateDisplay').textContent = mo + 'æœˆ' + d + 'æ—¥';
  const wb = '<span class="weekday-badge ' + wClass + '">' + w + (kanaMode ? 'ã‚ˆã†ã³' : 'æ›œæ—¥') + '</span>';
  document.getElementById('dateDisplay').innerHTML = mo + 'æœˆ' + d + 'æ—¥' + wb;
  
  // å¹´å·ï¼ˆä»¤å’Œã‚‚è¡¨ç¤ºï¼‰
  const reiwa = y - 2018; // 2019å¹´ãŒä»¤å’Œå…ƒå¹´
  document.getElementById('yearBadge').innerHTML = '<span style="font-size:0.85em;">ä»¤å’Œ' + reiwa + 'å¹´</span><span>' + y + 'å¹´</span>';

  const hour = now.getHours();
  let gr = 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™';
  if (hour >= 11 && hour < 17) gr = 'ã“ã‚“ã«ã¡ã¯';
  if (hour >= 17 && hour < 21) gr = 'ã“ã‚“ã°ã‚“ã¯';
  if (hour >= 21 || hour < 5) gr = kanaMode ? 'ãŠã‚„ã™ã¿ãªã•ã„' : 'ãŠã‚„ã™ã¿ãªã•ã„';
  document.getElementById('greeting').textContent = gr;

  // è‡ªå‹•ãƒ†ãƒ¼ãƒ
  if (!nightForced) {
    document.body.classList.remove('theme-night');
    if (hour >= 21 || hour < 6) document.body.classList.add('theme-night');
  }
}

// ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ =====
function switchMode(mode) {
  currentMode = mode;
  const main = document.getElementById('mainArea');
  const btnHome = document.getElementById('btnHome');
  const btnOut = document.getElementById('btnOut');
  const card1 = document.getElementById('card1');
  const card2 = document.getElementById('card2');
  const card3 = document.getElementById('card3');
  const cardGoHome = document.getElementById('cardGoHome');
  const outBottomGrid = document.getElementById('outBottomGrid');
  const bottomBar = document.getElementById('bottomBar');
  const btnReceipt = document.getElementById('btnReceipt');

  if (mode === 'out') {
    // å¤–å‡ºãƒ¢ãƒ¼ãƒ‰: ä¸Šã«ã€Œå®¶ã«å¸°ã‚‹ã€ã€ä¸‹ã«è²·ã„ç‰©ãƒ»äºˆå®š
    main.classList.add('mode-out');
    btnHome.classList.remove('active');
    btnOut.classList.add('active');
    card1.classList.add('hidden');
    card2.classList.add('hidden');
    card3.classList.add('hidden');
    cardGoHome.classList.add('show');
    outBottomGrid.classList.add('show');
    btnReceipt.style.display = 'flex';
  } else {
    // åœ¨å®…ãƒ¢ãƒ¼ãƒ‰: é€šå¸¸
    main.classList.remove('mode-out');
    btnHome.classList.add('active');
    btnOut.classList.remove('active');
    card1.classList.remove('hidden');
    card2.classList.remove('hidden');
    card3.classList.remove('hidden');
    cardGoHome.classList.remove('show');
    outBottomGrid.classList.remove('show');
    btnReceipt.style.display = 'none';
  }
}

// ===== è¨­å®š =====
function cycleTextSize() {
  textLevel = (textLevel + 1) % 5;
  document.body.classList.remove(...textLevels);
  document.body.classList.add(textLevels[textLevel]);
  document.getElementById('btnText').classList.toggle('active', textLevel !== 2);
}

function toggleKana() {
  kanaMode = !kanaMode;
  document.getElementById('btnKana').classList.toggle('active', !kanaMode);
  applyI18N();
}

function toggleNight() {
  nightForced = !nightForced;
  document.getElementById('btnNight').classList.toggle('active', nightForced);
  if (nightForced) {
    document.body.classList.add('theme-night');
  } else {
    document.body.classList.remove('theme-night');
    updateClock();
  }
}

// ===== GPSé€šçŸ¥ãƒ‡ãƒ¢ =====
function demoGPS() {
  setTimeout(() => {
    const banner = document.getElementById('gpsBanner');
    banner.classList.add('show');
    setTimeout(() => banner.classList.remove('show'), 5000);
  }, 8000);
}

// ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ =====
function openOverlay(type) {
  const card = document.getElementById('olCard');
  let html = '';

  if (type === 'log') {
    html = `
      <div class="ol-icon">ğŸ“</div>
      <div class="ol-title">${kanaMode ? 'ãã‚‡ã†ã® ãã‚ã' : 'ä»Šæ—¥ã®è¨˜éŒ²'}</div>
      <div class="ol-body" style="text-align: left;">
        <textarea id="logContent" placeholder="ä½•ã‚’ã—ã¾ã—ãŸã‹ï¼Ÿ&#10;ä¾‹ï¼šæ•£æ­©ã«è¡Œã£ãŸã€å‹é”ã«ä¼šã£ãŸã€æ˜ ç”»ã‚’è¦‹ãŸ" style="width: 100%; padding: 14px; font-size: 1rem; border: 2px solid var(--border); border-radius: 10px; min-height: 120px; resize: vertical; line-height: 1.6; background: var(--bg-card); color: var(--text);"></textarea>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="addQuickLog('æ•£æ­©ã—ãŸ')" style="padding: 8px 16px; background: var(--green-soft); border: 2px solid var(--green); border-radius: 20px; font-size: 0.9rem; cursor: pointer;">ğŸš¶ æ•£æ­©ã—ãŸ</button>
          <button onclick="addQuickLog('é£Ÿäº‹ã—ãŸ')" style="padding: 8px 16px; background: var(--green-soft); border: 2px solid var(--green); border-radius: 20px; font-size: 0.9rem; cursor: pointer;">ğŸ½ï¸ é£Ÿäº‹ã—ãŸ</button>
          <button onclick="addQuickLog('å‹é”ã«ä¼šã£ãŸ')" style="padding: 8px 16px; background: var(--green-soft); border: 2px solid var(--green); border-radius: 20px; font-size: 0.9rem; cursor: pointer;">ğŸ‘¥ å‹é”ã«ä¼šã£ãŸ</button>
          <button onclick="addQuickLog('è²·ã„ç‰©ã—ãŸ')" style="padding: 8px 16px; background: var(--green-soft); border: 2px solid var(--green); border-radius: 20px; font-size: 0.9rem; cursor: pointer;">ğŸ›’ è²·ã„ç‰©ã—ãŸ</button>
        </div>
        <div class="ol-voice-row" style="margin-top: 12px; display: flex; justify-content: center;">
          <button type="button" class="voice-inline-btn" onclick="startVoiceForOverlay('log')" title="éŸ³å£°ã§å…¥åŠ›">ğŸ¤ éŸ³å£°ã§å…¥åŠ›</button>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: var(--green-soft); border-radius: 8px; font-size: 0.8rem; color: var(--green); text-align: center;">
          ğŸ’¡ ã€Œè¨˜éŒ²ã—ã¦ï¼šä»Šæ—¥ã¯å…¬åœ’ã«è¡Œãã¾ã—ãŸã€ã¨è©±ã—ã¦ã‚‚è¨˜éŒ²ã§ãã¾ã™
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="saveLog()">âœ… ${kanaMode ? 'ãã‚ã' : 'è¨˜éŒ²ã™ã‚‹'}</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'call') {
    html = `
      <div class="ol-icon">ğŸ“</div>
      <div class="ol-title">${kanaMode ? 'ã ã‚Œã« ã§ã‚“ã‚ã™ã‚‹ï¼Ÿ' : 'èª°ã«é›»è©±ã™ã‚‹ï¼Ÿ'}</div>
      <div class="ol-body"></div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="closeOverlayDirect()">ğŸ‘¨ å¤ªéƒã•ã‚“</button>
        <button class="ol-btn ol-btn-green" onclick="closeOverlayDirect()">ğŸ‘© èŠ±å­ã•ã‚“</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã‚„ã‚ã‚‹' : 'ã‚„ã‚ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'places') {
    html = `
      <div class="ol-icon">ğŸ—ºï¸</div>
      <div class="ol-title">${kanaMode ? 'ã©ã“ã« ã„ãï¼Ÿ' : 'ã©ã“ã«è¡Œãï¼Ÿ'}</div>
      <div class="ol-body">${kanaMode ? 'ã‚ˆã ã„ã ã°ã—ã‚‡' : 'ã‚ˆãè¡Œãå ´æ‰€'}</div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="openPlaceMap('ã‚¹ãƒ¼ãƒ‘ãƒ¼')">ğŸª ã‚¹ãƒ¼ãƒ‘ãƒ¼</button>
        <button class="ol-btn ol-btn-green" onclick="openPlaceMap('ã‚¯ãƒªãƒ‹ãƒƒã‚¯')">ğŸ¥ ã‚¯ãƒªãƒ‹ãƒƒã‚¯</button>
        <button class="ol-btn ol-btn-green" onclick="openPlaceMap('å…¬åœ’')">ğŸŒ³ å…¬åœ’</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'receipt') {
    html = `
      <div class="ol-icon">ğŸ“·</div>
      <div class="ol-title">${kanaMode ? 'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ ã¨ã‚‹' : 'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®ã‚‹'}</div>
      <div class="ol-body">${kanaMode ? 'ã‹ã£ãŸ ã‚‚ã®ã‚’ ãŠã¼ãˆã¦ãŠãã¾ã™' : 'è²·ã£ãŸã‚‚ã®ã‚’è¦šãˆã¦ãŠãã¾ã™'}</div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="takeReceipt()">ğŸ“· ${kanaMode ? 'ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹' : 'å†™çœŸã‚’æ’®ã‚‹'}</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'idcard') {
    // è¿·å­æœ­ï¼šåå‰ã¨ä½æ‰€ã‚’å¤§ããè¡¨ç¤º
    html = `
      <div class="ol-icon">ğŸ†”</div>
      <div class="ol-title">${kanaMode ? 'ã‚ãŸã—ã® ã˜ã‚‡ã†ã»ã†' : 'ç§ã®æƒ…å ±'}</div>
      <div class="ol-body" style="text-align: left; background: var(--bg-soft); padding: 20px; border-radius: 12px; margin: 16px 0;">
        <div style="font-size: 0.85rem; color: var(--text-quiet); margin-bottom: 8px;">${kanaMode ? 'ãªã¾ãˆ' : 'åå‰'}</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 20px;">å±±ç”° å¤ªéƒ</div>
        <div style="font-size: 0.85rem; color: var(--text-quiet); margin-bottom: 8px;">${kanaMode ? 'ã˜ã‚…ã†ã—ã‚‡' : 'ä½æ‰€'}</div>
        <div style="font-size: 1.15rem; font-weight: 600; color: var(--text); line-height: 1.6;">
          ã€’980-0000<br>
          å®®åŸçœŒä»™å°å¸‚é’è‘‰åŒºã€‡ã€‡1-2-3
        </div>
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 0.85rem; color: var(--text-sub);">
          ${kanaMode ? 'ã“ã¾ã£ãŸã‚‰ ã“ã®ãŒã‚ã‚“ã‚’ ã ã‚Œã‹ã« ã¿ã›ã¦ãã ã•ã„' : 'å›°ã£ãŸã‚‰ ã“ã®ç”»é¢ã‚’èª°ã‹ã«è¦‹ã›ã¦ãã ã•ã„'}
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="callFamily()">ğŸ“ ${kanaMode ? 'ã‹ããã« ã§ã‚“ã‚' : 'å®¶æ—ã«é›»è©±'}</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'chat') {
    // AIãŠã—ã‚ƒã¹ã‚Šï¼ˆ3ç¨®é¡ï¼‰
    html = `
      <div class="ol-icon">ğŸ’¬</div>
      <div class="ol-title">${kanaMode ? 'ãŠã—ã‚ƒã¹ã‚Š' : 'ãŠã—ã‚ƒã¹ã‚Š'}</div>
      <div class="ol-body">${kanaMode ? 'ã©ã¡ã‚‰ã¨ ãŠã¯ãªã—ã—ã¾ã™ã‹ï¼Ÿ' : 'ã©ã¡ã‚‰ã¨ãŠè©±ã—ã—ã¾ã™ã‹ï¼Ÿ'}</div>
      <div class="ol-actions" style="flex-direction: column; width: 100%;">
        <button class="ol-btn ol-btn-green" onclick="openChat('wallbounce')" style="width: 100%; padding: 18px 24px; font-size: 1.05rem;">
          ğŸ¤” ${kanaMode ? 'ã‹ã¹ã†ã¡ãƒ»ãã†ã ã‚“' : 'å£æ‰“ã¡ãƒ»ç›¸è«‡'}
          <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.8; margin-top: 4px;">è€ƒãˆã‚’æ•´ç†ã—ãŸã„ã¨ã</div>
        </button>
        <button class="ol-btn ol-btn-green" onclick="openChat('gemini')" style="width: 100%; padding: 18px 24px; font-size: 1.05rem;">
          ğŸ’¬ ${kanaMode ? 'ã–ã¤ã ã‚“ãƒ»ã“ã“ã‚ã® ã‚µãƒãƒ¼ãƒˆ' : 'é›‘è«‡ãƒ»å¿ƒã®ã‚µãƒãƒ¼ãƒˆ'}
          <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.8; margin-top: 4px;">æƒ…å ±æä¾›ãƒ»æƒ…ç·’çš„å®‰å®š</div>
        </button>
        <button class="ol-btn ol-btn-green" onclick="openChat('ishihara')" style="width: 100%; padding: 18px 24px; font-size: 1.05rem;">
          ğŸ§  ${kanaMode ? 'ã«ã‚“ã¡ã—ã‚‡ã†ã® ãã†ã ã‚“' : 'èªçŸ¥ç—‡ã®ç›¸è«‡'}
          <div style="font-size: 0.7rem; font-weight: 400; opacity: 0.8; margin-top: 4px;">çŸ³åŸå…ˆç”Ÿã®èªçŸ¥ç—‡çŸ¥æµè¢‹</div>
        </button>
        <div style="margin-top: 12px; padding: 12px; background: var(--amber-soft); border-radius: 10px; font-size: 0.75rem; color: var(--amber); text-align: center;">
          â­ ã‚µãƒ–ã‚¹ã‚¯æ©Ÿèƒ½ï¼ˆAPIåˆ©ç”¨ï¼‰
        </div>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()" style="width: 100%; margin-top: 8px;">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'mail') {
    // ãƒ¡ãƒ¼ãƒ«ä¸€è¦§
    html = `
      <div class="ol-icon">ğŸ“§</div>
      <div class="ol-title">${kanaMode ? 'ãƒ¡ãƒ¼ãƒ«' : 'ãƒ¡ãƒ¼ãƒ«'}</div>
      <div class="ol-body" style="text-align: left;">
        <div style="padding: 16px; background: var(--bg-soft); border-radius: 12px; margin-bottom: 12px; cursor: pointer;" onclick="openMailDetail(0)">
          <div style="font-size: 0.85rem; font-weight: 700; color: var(--text); margin-bottom: 4px;">å¤ªéƒã•ã‚“</div>
          <div style="font-size: 0.95rem; color: var(--text);">é€±æœ«éŠã³ã«è¡Œãã­ï¼</div>
          <div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 4px;">ãŠæ¯ã•ã‚“ã€åœŸæ›œæ—¥ã®æ˜¼é ƒç€ãã‚ˆ...</div>
        </div>
        <div style="padding: 16px; background: var(--bg-soft); border-radius: 12px; cursor: pointer;" onclick="openMailDetail(1)">
          <div style="font-size: 0.85rem; font-weight: 700; color: var(--text); margin-bottom: 4px;">çŸ³åŸã‚¯ãƒªãƒ‹ãƒƒã‚¯</div>
          <div style="font-size: 0.95rem; color: var(--text);">æ¬¡å›äºˆç´„ã®ãŠçŸ¥ã‚‰ã›</div>
          <div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 4px;">2æœˆ18æ—¥ 10æ™‚ã«äºˆç´„ãŒ...</div>
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'mail-reply') {
    // ãƒ¡ãƒ¼ãƒ«è¿”ä¿¡ï¼ˆAIä¸‹æ›¸ãï¼‰
    html = `
      <div class="ol-icon">âœï¸</div>
      <div class="ol-title">${kanaMode ? 'ãƒ¡ãƒ¼ãƒ«ã¸ã‚“ã—ã‚“' : 'ãƒ¡ãƒ¼ãƒ«è¿”ä¿¡'}</div>
      <div class="ol-body" style="text-align: left;">
        <div style="padding: 16px; background: var(--bg-soft); border-radius: 12px; margin-bottom: 12px;">
          <div style="font-size: 0.8rem; color: var(--text-quiet); margin-bottom: 8px;">AIãŒä¸‹æ›¸ãã‚’è€ƒãˆã¾ã—ãŸ</div>
          <div style="font-size: 0.95rem; color: var(--text); line-height: 1.7;">
            å¤ªéƒã¸<br><br>
            ã‚ã‚ŠãŒã¨ã†ã€‚åœŸæ›œæ—¥æ¥½ã—ã¿ã«ã—ã¦ã‚‹ã‚ˆã€‚<br>
            é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã€ãŠå¯¿å¸ãŒã„ã„ãªã€‚<br><br>
            æ°—ã‚’ã¤ã‘ã¦æ¥ã¦ã­ã€‚
          </div>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: var(--amber-soft); border-radius: 10px; font-size: 0.75rem; color: var(--amber); text-align: center;">
          â­ AIæ©Ÿèƒ½ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="sendMail()">ğŸ“§ ${kanaMode ? 'ãŠãã‚‹' : 'é€ã‚‹'}</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã‚„ã‚ã‚‹' : 'ã‚„ã‚ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'video') {
    // å‹•ç”»ï¼ˆæš‡ã¤ã¶ã—ï¼‰
    html = `
      <div class="ol-icon">ğŸ“º</div>
      <div class="ol-title">${kanaMode ? 'ãªã«ã‚’ ã¿ã‚‹ï¼Ÿ' : 'ä½•ã‚’è¦‹ã‚‹ï¼Ÿ'}</div>
      <div class="ol-body"></div>
      <div class="ol-actions" style="flex-direction: column; width: 100%;">
        <button class="ol-btn ol-btn-green" onclick="openYT('ç™’ã—ã®éŸ³æ¥½')" style="width: 100%; justify-content: flex-start; padding: 14px 20px;">ğŸµ ${kanaMode ? 'ãŠã‚“ãŒã' : 'éŸ³æ¥½'}</button>
        <button class="ol-btn ol-btn-green" onclick="openYT('æ‡ã‹ã—ã„æ­Œ')" style="width: 100%; justify-content: flex-start; padding: 14px 20px;">ğŸ¤ ${kanaMode ? 'ãªã¤ã‹ã—ã„ ã†ãŸ' : 'æ‡ã‹ã—ã„æ­Œ'}</button>
        <button class="ol-btn ol-btn-green" onclick="openYT('çŒ«ã®å‹•ç”»')" style="width: 100%; justify-content: flex-start; padding: 14px 20px;">ğŸ± ${kanaMode ? 'ã­ã“' : 'çŒ«'}</button>
        <button class="ol-btn ol-btn-green" onclick="openYT('è‡ªç„¶ã®æ˜ åƒ')" style="width: 100%; justify-content: flex-start; padding: 14px 20px;">ğŸŒ¿ ${kanaMode ? 'ã—ãœã‚“' : 'è‡ªç„¶'}</button>
        <button class="ol-btn ol-btn-green" onclick="openYT('ä½“æ“')" style="width: 100%; justify-content: flex-start; padding: 14px 20px;">ğŸ¤¸ ${kanaMode ? 'ãŸã„ãã†' : 'ä½“æ“'}</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()" style="width: 100%; margin-top: 8px;">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'welcome') {
    // åˆå›èµ·å‹•ï¼šã‚ˆã†ã“ãç”»é¢ + ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åé›†
    html = `
      <div class="ol-icon" style="font-size: 3rem;">ğŸ‘‹</div>
      <div class="ol-title" style="font-size: 1.5rem;">ã‚ˆã†ã“ãï¼</div>
      <div class="ol-body" style="text-align: left; line-height: 1.8;">
        <p style="margin-bottom: 16px;">ã“ã®ã‚¢ãƒ—ãƒªã¯ã€èªçŸ¥ç—‡ã®æ–¹ã‚„é«˜é½¢ã®æ–¹ãŒ<br>å®‰å¿ƒã—ã¦æš®ã‚‰ã›ã‚‹ãŸã‚ã®<strong>ã‚„ã•ã—ã„ä¼´èµ°è€…</strong>ã§ã™ã€‚</p>
        <p style="margin-bottom: 16px;">âœ… éŸ³å£°ã§æ“ä½œã§ãã¾ã™<br>âœ… å¤§ããªæ–‡å­—ã§è¦‹ã‚„ã™ã„<br>âœ… å®¶æ—ã¨ã¤ãªãŒã‚‹</p>
        <p style="margin-bottom: 8px; font-weight: 700;">æ›´æ–°æƒ…å ±ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ</p>
        <input type="email" id="userEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰" style="width: 100%; padding: 14px; font-size: 1rem; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 8px;">
        <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 16px;">â€» æ–°æ©Ÿèƒ½ã®ãŠçŸ¥ã‚‰ã›ã‚„ã€å­¦ä¼šç™ºè¡¨ã®ã”æ¡ˆå†…ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚<br>å…¥åŠ›ã—ãªãã¦ã‚‚ã‚¢ãƒ—ãƒªã¯ä½¿ãˆã¾ã™ã€‚</div>
      </div>
      <div class="ol-actions" style="flex-direction: column; width: 100%;">
        <button class="ol-btn ol-btn-green" onclick="saveEmailAndStart()" style="width: 100%; padding: 16px 20px; font-size: 1.1rem;">
          âœ… å§‹ã‚ã‚‹
        </button>
        <button class="ol-btn ol-btn-soft" onclick="skipWelcome()" style="width: 100%; margin-top: 8px;">
          ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ¡ãƒ¼ãƒ«ãªã—ã§å§‹ã‚ã‚‹ï¼‰
        </button>
      </div>
    `;
  } else if (type === 'weather') {
    // å¤©æ°—äºˆå ±è©³ç´°
    html = `
      <div class="ol-icon">â˜€ï¸</div>
      <div class="ol-title">${kanaMode ? 'ã¦ã‚“ãã‚ˆã»ã†' : 'å¤©æ°—äºˆå ±'}</div>
      <div class="ol-body" style="text-align: left;">
        <div style="margin-bottom: 20px;">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 12px;">ä»Šæ—¥ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px;">
            ${Array.from({length: 8}, (_, i) => {
              const hour = 9 + i;
              const temps = [16, 17, 18, 19, 20, 19, 18, 17];
              const icons = ['â˜€ï¸', 'â˜€ï¸', 'â›…', 'â›…', 'â˜ï¸', 'â˜ï¸', 'ğŸŒ¤ï¸', 'ğŸŒ¤ï¸'];
              return `<div style="text-align: center; padding: 8px; background: var(--bg-soft); border-radius: 8px;">
                <div style="font-size: 0.75rem; color: var(--text-sub);">${hour}æ™‚</div>
                <div style="font-size: 1.5rem; margin: 4px 0;">${icons[i]}</div>
                <div style="font-size: 0.85rem; font-weight: 600;">${temps[i]}Â°</div>
              </div>`;
            }).join('')}
          </div>
        </div>
        <div>
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 12px;">é€±é–“å¤©æ°—</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${['æ˜æ—¥', 'æ˜å¾Œæ—¥', '3æ—¥å¾Œ', '4æ—¥å¾Œ', '5æ—¥å¾Œ', '6æ—¥å¾Œ', '7æ—¥å¾Œ'].map((day, i) => {
              const icons = ['ğŸŒ¤ï¸', 'â˜€ï¸', 'â›…', 'â˜ï¸', 'ğŸŒ§ï¸', 'â›…', 'â˜€ï¸'];
              const high = [20, 22, 21, 18, 16, 19, 21][i];
              const low = [12, 14, 13, 11, 10, 12, 13][i];
              return `<div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-soft); border-radius: 8px;">
                <div style="flex: 1; font-size: 0.9rem;">${day}</div>
                <div style="font-size: 1.5rem; margin: 0 12px;">${icons[i]}</div>
                <div style="font-size: 0.85rem; font-weight: 600;">
                  <span style="color: var(--rose);">${high}Â°</span> / <span style="color: var(--blue);">${low}Â°</span>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'calendar') {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ + æœ€è¿‘ã®äºˆå®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const todayStr = today.toISOString().split('T')[0];
    const weekLater = new Date(today);
    weekLater.setDate(weekLater.getDate() + 7);
    const weekLaterStr = weekLater.toISOString().split('T')[0];
    const recentForOverlay = localEvents
      .filter(e => e.date >= todayStr && e.date <= weekLaterStr)
      .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

    let recentHTML = '';
    if (recentForOverlay.length === 0) {
      recentHTML = '<div style="font-size: 0.9rem; color: var(--text-quiet); padding: 8px 0;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      let lastDate = '';
      recentForOverlay.forEach(event => {
        const dateLabel = formatScheduleDate(event.date);
        if (event.date !== lastDate) {
          lastDate = event.date;
          recentHTML += `<div style="font-size: 0.75rem; font-weight: 700; color: var(--green); margin-top: 10px; margin-bottom: 4px;">${dateLabel}</div>`;
        }
        recentHTML += `<div style="padding: 8px 12px; background: var(--bg-soft); border-radius: 8px; margin-bottom: 6px; font-size: 0.9rem;"><span style="font-weight: 700;">${event.time}</span> ${event.title}</div>`;
      });
    }

    html = `
      <div class="ol-icon">ğŸ“…</div>
      <div class="ol-title">${year}å¹´${month + 1}æœˆ</div>
      <div class="ol-body" style="text-align: left;">
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 16px;">
          ${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map((d, i) => 
            `<div style="text-align: center; font-size: 0.75rem; font-weight: 700; color: ${i === 0 ? 'var(--rose)' : i === 6 ? 'var(--blue)' : 'var(--text-sub)'}; padding: 4px;">${d}</div>`
          ).join('')}
          ${Array.from({length: firstDay}, () => '<div></div>').join('')}
          ${Array.from({length: daysInMonth}, (_, i) => {
            const day = i + 1;
            const isToday = day === today.getDate();
            return `<div style="text-align: center; padding: 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; ${isToday ? 'background: var(--green); color: white;' : 'background: var(--bg-soft); color: var(--text);'} cursor: pointer;" onclick="selectDate(${day})">${day}</div>`;
          }).join('')}
        </div>
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 8px;">æœ€è¿‘ã®äºˆå®š</div>
          ${recentHTML}
        </div>
      </div>
      <div class="ol-actions" style="flex-direction: column; width: 100%;">
        <button class="ol-btn ol-btn-green" onclick="addEvent()" style="width: 100%;">â• äºˆå®šã‚’è¿½åŠ </button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()" style="width: 100%; margin-top: 8px;">âœ• ${kanaMode ? 'ã¨ã˜ã‚‹' : 'é–‰ã˜ã‚‹'}</button>
      </div>
    `;
  } else if (type === 'add-event') {
    // äºˆå®šè¿½åŠ ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’æ¸¡ã•ã‚ŒãŸå ´åˆã¯ãã®æ—¥ã§åˆæœŸåŒ–ï¼‰
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const prefillDate = (typeof arguments[1] === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(arguments[1])) ? arguments[1] : todayStr;
    const currentTime = today.toTimeString().split(' ')[0].substring(0, 5);
    html = `
      <div class="ol-icon">â•</div>
      <div class="ol-title">äºˆå®šã‚’è¿½åŠ </div>
      <div class="ol-body" style="text-align: left;">
        <input type="text" id="eventTitle" placeholder="äºˆå®šã®ã‚¿ã‚¤ãƒˆãƒ«" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: var(--bg-card); color: var(--text);" autofocus>
        <label style="display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px;">æ—¥ä»˜</label>
        <input type="date" id="eventDate" value="${prefillDate}" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: var(--bg-card); color: var(--text);">
        <input type="text" id="eventDateText" placeholder="ã¾ãŸã¯ 2026-02-13 ã®ã‚ˆã†ã«å…¥åŠ›" style="width: 100%; padding: 10px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: var(--bg-card); color: var(--text);">
        <label style="display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px;">æ™‚é–“</label>
        <input type="time" id="eventTime" value="${currentTime}" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: var(--bg-card); color: var(--text);">
        <input type="text" id="eventTimeText" placeholder="ã¾ãŸã¯ 14:00 ã®ã‚ˆã†ã«å…¥åŠ›" style="width: 100%; padding: 10px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: var(--bg-card); color: var(--text);">
        <textarea id="eventNote" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; min-height: 80px; resize: vertical; background: var(--bg-card); color: var(--text);"></textarea>
        <div class="ol-voice-row" style="margin-top: 12px; display: flex; justify-content: center;">
          <button type="button" class="voice-inline-btn" onclick="startVoiceForOverlay('event')" title="éŸ³å£°ã§å…¥åŠ›">ğŸ¤ éŸ³å£°ã§å…¥åŠ›</button>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: var(--green-soft); border-radius: 8px; font-size: 0.8rem; color: var(--green); text-align: center;">
          ğŸ’¡ ã€Œäºˆå®šã‚’è¿½åŠ ã—ã¦ï¼šæ˜æ—¥ã®åˆå¾Œ2æ™‚ã«ç—…é™¢ã€ã¨è©±ã—ã¦ã‚‚è¿½åŠ ã§ãã¾ã™
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="saveEvent()">âœ… ä¿å­˜</button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
  } else if (type === 'add-todo') {
    // Todoè¿½åŠ 
    html = `
      <div class="ol-icon">ğŸ“</div>
      <div class="ol-title">Todoã‚’è¿½åŠ </div>
      <div class="ol-body" style="text-align: left;">
        <input type="text" id="todoTitle" placeholder="ã‚„ã‚‹ã“ã¨" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: var(--bg-card); color: var(--text);">
        <select id="todoPriority" style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: var(--bg-card); color: var(--text);">
          <option value="low">æ€¥ãŒãªã„</option>
          <option value="medium" selected>æ™®é€š</option>
          <option value="high">æ€¥ã</option>
        </select>
        <div class="ol-voice-row" style="margin-top: 12px; display: flex; justify-content: center;">
          <button type="button" class="voice-inline-btn" onclick="startVoiceForOverlay('todo')" title="éŸ³å£°ã§å…¥åŠ›">ğŸ¤ éŸ³å£°ã§å…¥åŠ›</button>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: var(--green-soft); border-radius: 8px; font-size: 0.8rem; color: var(--green); text-align: center;">
          ğŸ’¡ ã€ŒTodoã«è¿½åŠ ã—ã¦ï¼šç‰›ä¹³ã‚’è²·ã†ã€ã¨è©±ã—ã¦ã‚‚è¿½åŠ ã§ãã¾ã™
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="saveTodo()">âœ… è¿½åŠ </button>
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
  } else if (type === 'settings') {
    // è¨­å®šç”»é¢
    const currentAPIKey = getAPIKey();
    const maskedKey = currentAPIKey ? 'â—â—â—â—â—â—' + currentAPIKey.slice(-4) : 'æœªè¨­å®š';
    
    html = `
      <div class="ol-icon">âš™ï¸</div>
      <div class="ol-title">è¨­å®š</div>
      <div class="ol-body" style="text-align: left; max-height: 70vh; overflow-y: auto;">
        <div style="margin-bottom: 20px; padding: 16px; background: var(--amber-soft); border-radius: 10px;">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 8px;">ğŸ” Gemini APIã‚­ãƒ¼</div>
          <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 12px;">
            AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ã€Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™<br>
            ç¾åœ¨: ${maskedKey}
          </div>
          <button onclick="openOverlay('api-key-setup')" style="width: 100%; padding: 12px; background: var(--amber); color: white; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer;">
            ${currentAPIKey ? 'âœï¸ APIã‚­ãƒ¼ã‚’å¤‰æ›´' : 'â• APIã‚­ãƒ¼ã‚’è¨­å®š'}
          </button>
        </div>
        <div style="margin-bottom: 20px;">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 12px;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
          <button onclick="exportData()" style="width: 100%; padding: 14px; background: var(--green); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 8px;">
            ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          </button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">
          <button onclick="document.getElementById('importFile').click()" style="width: 100%; padding: 14px; background: var(--blue); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
            ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
          </button>
        </div>
        <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-soft); border-radius: 10px;">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 8px;">Googleé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>
          <div style="font-size: 0.85rem; color: var(--text-sub); margin-bottom: 12px;">è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸã—ãŸã„å ´åˆã®ã¿è¨­å®š</div>
          <button onclick="connectGoogleCalendar()" style="width: 100%; padding: 12px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; cursor: pointer; margin-bottom: 8px;">
            ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨é€£æº
          </button>
          <button onclick="connectGoogleTasks()" style="width: 100%; padding: 12px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; cursor: pointer;">
            âœ… Google Tasksã¨é€£æº
          </button>
        </div>
        <div style="font-size: 0.8rem; color: var(--text-quiet); text-align: center;">
          ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ã‚¹ãƒãƒ›ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™<br>
          Googleé€£æºã—ãªãã¦ã‚‚å…¨æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• é–‰ã˜ã‚‹</button>
      </div>
    `;
  } else if (type === 'api-key-setup') {
    // APIã‚­ãƒ¼è¨­å®šç”»é¢
    html = `
      <div class="ol-icon">ğŸ”</div>
      <div class="ol-title">Gemini APIã‚­ãƒ¼è¨­å®š</div>
      <div class="ol-body" style="text-align: left;">
        <div style="margin-bottom: 16px; padding: 12px; background: var(--blue-soft); border-radius: 8px; font-size: 0.85rem; color: var(--blue); line-height: 1.6;">
          <strong>APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•ï¼š</strong><br>
          1. <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--blue); text-decoration: underline;">Google AI Studio</a> ã«ã‚¢ã‚¯ã‚»ã‚¹<br>
          2. ã€ŒGet API keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
          3. APIã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼<br>
          4. ä¸‹è¨˜ã«è²¼ã‚Šä»˜ã‘
        </div>
        <input type="password" id="apiKeyInput" placeholder="AIza..." value="${getAPIKey()}" style="width: 100%; padding: 14px; font-size: 1rem; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 12px; font-family: monospace;">
        <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 16px;">
          âš ï¸ APIã‚­ãƒ¼ã¯ã“ã®ã‚¹ãƒãƒ›ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå®‰å…¨ï¼‰
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-green" onclick="saveAPIKey()">âœ… ä¿å­˜</button>
        <button class="ol-btn ol-btn-soft" onclick="openOverlay('settings')">â† æˆ»ã‚‹</button>
      </div>
    `;
  } else if (type === 'chat-window') {
    // ãƒãƒ£ãƒƒãƒˆç”»é¢
    const chatType = arguments[1] || 'gemini';
    const chatTitle = {
      'wallbounce': 'ğŸ¤” å£æ‰“ã¡ãƒ»ç›¸è«‡',
      'gemini': 'ğŸ’¬ é›‘è«‡ãƒ»å¿ƒã®ã‚µãƒãƒ¼ãƒˆ',
      'ishihara': 'ğŸ§  èªçŸ¥ç—‡ã®ç›¸è«‡'
    }[chatType];
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
    const history = chatHistory.filter(c => c.type === chatType).slice(-10);
    let historyHTML = '';
    history.forEach(msg => {
      const align = msg.role === 'user' ? 'right' : 'left';
      const bg = msg.role === 'user' ? 'var(--green-soft)' : 'var(--bg-soft)';
      historyHTML += `
        <div style="display: flex; justify-content: ${align === 'right' ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
          <div style="max-width: 75%; padding: 12px 16px; background: ${bg}; border-radius: 16px; font-size: 0.95rem; line-height: 1.6;">
            ${msg.content}
          </div>
        </div>
      `;
    });
    
    html = `
      <div class="ol-icon">${chatTitle.split(' ')[0]}</div>
      <div class="ol-title">${chatTitle}</div>
      <div class="ol-body" style="text-align: left;">
        <div id="chatMessages" style="max-height: 50vh; overflow-y: auto; padding: 16px; background: var(--bg); border-radius: 10px; margin-bottom: 12px;">
          ${historyHTML || '<div style="text-align: center; color: var(--text-quiet); padding: 20px;">ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</div>'}
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="flex: 1; padding: 12px; font-size: 1rem; border: 2px solid var(--border); border-radius: 10px;" onkeypress="if(event.key==='Enter') sendChatMessage('${chatType}')">
          <button onclick="sendChatMessage('${chatType}')" style="padding: 12px 20px; background: var(--green); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
            é€ä¿¡
          </button>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: var(--amber-soft); border-radius: 8px; font-size: 0.8rem; color: var(--amber); text-align: center;">
          â­ ${getAPIKey() ? 'APIåˆ©ç”¨ä¸­' : 'APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ï¼ˆè¨­å®šç”»é¢ã§ç™»éŒ²ï¼‰'}
        </div>
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• é–‰ã˜ã‚‹</button>
      </div>
    `;
  } else if (type === 'log-history') {
    // è¨˜éŒ²å±¥æ­´ã®è¡¨ç¤º
    const allLogs = localLogs.slice().reverse().slice(0, 20);
    let logsHTML = '';
    
    allLogs.forEach(log => {
      logsHTML += `
        <div style="margin-bottom: 12px; padding: 12px; background: var(--bg-soft); border-radius: 8px;">
          <div style="font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px;">${log.date} ${log.time}</div>
          <div style="font-size: 0.95rem; color: var(--text); line-height: 1.6;">${log.content}</div>
        </div>
      `;
    });
    
    html = `
      <div class="ol-icon">ğŸ“</div>
      <div class="ol-title">è¨˜éŒ²ã®å±¥æ­´</div>
      <div class="ol-body" style="text-align: left; max-height: 70vh; overflow-y: auto;">
        ${logsHTML || '<div style="text-align: center; color: var(--text-quiet); padding: 20px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
      </div>
      <div class="ol-actions">
        <button class="ol-btn ol-btn-soft" onclick="closeOverlayDirect()">âœ• é–‰ã˜ã‚‹</button>
      </div>
    `;
  }

  card.innerHTML = html;
  document.getElementById('overlay').classList.add('open');
}

function closeOverlay(e) {
  if (e.target.id === 'overlay') closeOverlayDirect();
}

function closeOverlayDirect() {
  document.getElementById('overlay').classList.remove('open');
}

function openMap() {
  // æœ¬ç•ª: Google Maps API ã§è‡ªå®…ã¾ã§ã®ãƒ«ãƒ¼ãƒˆ
  alert('Google Maps ã§è‡ªå®…ã¾ã§ã®é“æ¡ˆå†…ã‚’é–‹ãã¾ã™');
}

function openPlaceMap(place) {
  alert(place + 'ã¾ã§ã®é“æ¡ˆå†…ã‚’é–‹ãã¾ã™');
  closeOverlayDirect();
}

function takeReceipt() {
  // æœ¬ç•ª: ã‚«ãƒ¡ãƒ©APIã§ãƒ¬ã‚·ãƒ¼ãƒˆæ’®å½± â†’ OCR â†’ è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ 
  alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å†™çœŸã‚’æ’®ã‚Šã¾ã—ãŸã€‚\næ¬¡å›ã®è²·ã„ç‰©ã§å‚è€ƒã«ã—ã¾ã™ï¼ˆè²·ã„ã™ãé˜²æ­¢ï¼‰');
  closeOverlayDirect();
}

function callFamily() {
  // å®¶æ—ã«é›»è©±
  alert('å®¶æ—ã«é›»è©±ã—ã¾ã™');
  closeOverlayDirect();
}

function openChat(type) {
  // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã
  closeOverlayDirect();
  setTimeout(() => openOverlay('chat-window', type), 300);
}

function openMailDetail(index) {
  // ãƒ¡ãƒ¼ãƒ«è©³ç´°è¡¨ç¤ºï¼ˆå°†æ¥å®Ÿè£…ï¼‰
  speak('ãƒ¡ãƒ¼ãƒ«ã‚’èª­ã¿ä¸Šã’ã¾ã™');
  closeOverlayDirect();
}

function sendMail() {
  alert('ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
  closeOverlayDirect();
}

function openYT(query) {
  // YouTubeæ¤œç´¢
  window.open('https://www.youtube.com/results?search_query=' + encodeURIComponent(query), '_blank');
  closeOverlayDirect();
}

// ===== åˆå›èµ·å‹•ï¼šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åé›† =====
function checkFirstVisit() {
  const visited = localStorage.getItem('banso_visited');
  if (!visited) {
    // åˆå›è¨ªå•
    setTimeout(() => {
      openOverlay('welcome');
    }, 2000); // 2ç§’å¾Œã«è¡¨ç¤º
  }
}

function saveEmailAndStart() {
  const email = document.getElementById('userEmail').value.trim();
  if (email) {
    // ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼ã‚„Googleãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
    console.log('Email collected:', email);
    alert('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  }
  localStorage.setItem('banso_visited', 'true');
  closeOverlayDirect();
  speak('ã‚ˆã†ã“ãï¼éŸ³å£°ã§æ“ä½œã§ãã¾ã™ã€‚ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„');
}

function skipWelcome() {
  localStorage.setItem('banso_visited', 'true');
  closeOverlayDirect();
  speak('ã‚ˆã†ã“ãï¼éŸ³å£°ã§æ“ä½œã§ãã¾ã™ã€‚ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„');
}

// ===== æ•°å­—ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºåˆ‡æ›¿ =====
function toggleNumberGuide() {
  showNumberGuide = !showNumberGuide;
  const badges = document.querySelectorAll('.number-badge');
  badges.forEach(badge => {
    if (showNumberGuide) {
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  });
  document.getElementById('btnNum').classList.toggle('active');
  localStorage.setItem('showNumberGuide', showNumberGuide);
}

// ===== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† =====
function loadLocalData() {
  try {
    localEvents = JSON.parse(localStorage.getItem(STORAGE_KEYS.EVENTS) || '[]');
    localTodos = JSON.parse(localStorage.getItem(STORAGE_KEYS.TODOS) || '[]');
    localLogs = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOGS) || '[]');
    chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEYS.CHATS) || '[]');
  } catch (e) {
    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function saveLocalData() {
  try {
    localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(localEvents));
    localStorage.setItem(STORAGE_KEYS.TODOS, JSON.stringify(localTodos));
    localStorage.setItem(STORAGE_KEYS.LOGS, JSON.stringify(localLogs));
    localStorage.setItem(STORAGE_KEYS.CHATS, JSON.stringify(chatHistory));
  } catch (e) {
    console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

// APIã‚­ãƒ¼ã®ç®¡ç†
function getAPIKey() {
  return localStorage.getItem(STORAGE_KEYS.API_KEY) || '';
}

function setAPIKey(key) {
  localStorage.setItem(STORAGE_KEYS.API_KEY, key);
}

// ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ =====
function selectDate(day) {
  const today = new Date();
  const selectedDate = new Date(today.getFullYear(), today.getMonth(), day);
  const dateStr = selectedDate.toISOString().split('T')[0];
  
  const dayEvents = localEvents.filter(e => e.date === dateStr);
  
  if (dayEvents.length === 0) {
    // äºˆå®šãŒãªã„æ—¥ã¯ã€Œäºˆå®šã‚’è¿½åŠ ã€ã‚’é–‹ãã€ãã®æ—¥ä»˜ã‚’å…¥ã‚ŒãŸçŠ¶æ…‹ã«ã™ã‚‹
    closeOverlayDirect();
    setTimeout(function() { openOverlay('add-event', dateStr); }, 300);
  } else {
    let message = `${day}æ—¥ã®äºˆå®šï¼š\n\n`;
    dayEvents.forEach(e => {
      message += `${e.time} ${e.title}\n`;
      if (e.note) message += `  ${e.note}\n`;
    });
    alert(message);
  }
}

function addEvent() {
  closeOverlayDirect();
  setTimeout(() => openOverlay('add-event'), 300);
}

function saveEvent() {
  const title = document.getElementById('eventTitle').value.trim();
  const dateEl = document.getElementById('eventDate');
  const dateTextEl = document.getElementById('eventDateText');
  const timeEl = document.getElementById('eventTime');
  const timeTextEl = document.getElementById('eventTimeText');
  const date = (dateEl && dateEl.value) || (dateTextEl && dateTextEl.value.trim()) || '';
  const time = (timeEl && timeEl.value) || (timeTextEl && timeTextEl.value.trim()) || '';
  const note = document.getElementById('eventNote') ? document.getElementById('eventNote').value.trim() : '';
  
  if (!title || !date || !time) {
    alert('ã‚¿ã‚¤ãƒˆãƒ«ã€æ—¥ä»˜ã€æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
    alert('æ—¥ä»˜ã¯ 2026-02-13 ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  if (!/^\d{1,2}:\d{2}$/.test(time) && !/^\d{2}:\d{2}$/.test(time)) {
    alert('æ™‚é–“ã¯ 14:00 ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
  const newEvent = {
    id: Date.now(),
    title,
    date,
    time,
    note,
    createdAt: new Date().toISOString()
  };
  
  localEvents.push(newEvent);
  saveLocalData();
  
  speak(`äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚${title}`);
  alert(`äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸï¼š\n${title}\n${date} ${time}`);
  closeOverlayDirect();
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
  updateCalendarView();
}

function saveTodo() {
  const title = document.getElementById('todoTitle').value.trim();
  const priority = document.getElementById('todoPriority').value;
  
  if (!title) {
    alert('ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
  const newTodo = {
    id: Date.now(),
    title,
    priority,
    completed: false,
    createdAt: new Date().toISOString()
  };
  
  localTodos.push(newTodo);
  saveLocalData();
  
  speak(`Todoã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚${title}`);
  alert(`Todoã‚’è¿½åŠ ã—ã¾ã—ãŸï¼š\n${title}`);
  closeOverlayDirect();
  
  // Todoè¡¨ç¤ºã‚’æ›´æ–°
  updateTodoView();
}

function toggleTodo(id) {
  const todo = localTodos.find(t => t.id === id);
  if (todo) {
    todo.completed = !todo.completed;
    saveLocalData();
    updateTodoView();
  }
}

function deleteTodo(id) {
  if (confirm('ã“ã®Todoã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    localTodos = localTodos.filter(t => t.id !== id);
    saveLocalData();
    updateTodoView();
  }
}

// ===== è¨˜éŒ²ï¼ˆãƒ©ã‚¤ãƒ•ãƒ­ã‚°ï¼‰é–¢é€£ =====
function addQuickLog(text) {
  const textarea = document.getElementById('logContent');
  if (textarea) {
    textarea.value = text;
  }
}

function saveLog() {
  const content = document.getElementById('logContent').value.trim();
  
  if (!content) {
    alert('è¨˜éŒ²ã™ã‚‹å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const newLog = {
    id: Date.now(),
    content,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toTimeString().split(' ')[0].substring(0, 5),
    createdAt: new Date().toISOString()
  };
  
  localLogs.push(newLog);
  saveLocalData();
  
  speak('è¨˜éŒ²ã—ã¾ã—ãŸ');
  alert('è¨˜éŒ²ã—ã¾ã—ãŸï¼');
  closeOverlayDirect();
  
  // è¨˜éŒ²è¡¨ç¤ºã‚’æ›´æ–°
  updateLogView();
}

function updateLogView() {
  const today = new Date().toISOString().split('T')[0];
  const todayLogs = localLogs.filter(l => l.date === today).sort((a, b) => b.time.localeCompare(a.time));
  
  let html = '';
  if (todayLogs.length === 0) {
    html = '<div style="padding: 32px 22px; text-align: center; color: var(--text-quiet);">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    html = '<div style="padding: 16px 22px;">';
    todayLogs.forEach(log => {
      html += `
        <div style="margin-bottom: 12px; padding: 12px; background: var(--bg-soft); border-radius: 8px;">
          <div style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 4px;">${log.time}</div>
          <div style="font-size: 0.95rem; color: var(--text); line-height: 1.6;">${log.content}</div>
        </div>
      `;
    });
    html += '</div>';
  }
  html += '<div class="card-plus-row"><button type="button" class="card-plus-btn" onclick="openOverlay(\'log\')" title="è¨˜éŒ²ã‚’è¿½åŠ "><span class="plus-icon">â•</span> è¨˜éŒ²ã‚’è¿½åŠ </button></div>';

  const logCard = document.getElementById('card3');
  if (logCard) {
    const body = logCard.querySelector('.card-body');
    if (body) body.innerHTML = html;
  }
}

// ===== APIã‚­ãƒ¼è¨­å®š =====
function saveAPIKey() {
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  
  if (!apiKey) {
    alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (!apiKey.startsWith('AIza')) {
    if (!confirm('ã“ã®APIã‚­ãƒ¼ã¯æ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
  }
  
  setAPIKey(apiKey);
  alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  openOverlay('settings');
}

// ===== ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ =====
async function sendChatMessage(chatType) {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const apiKey = getAPIKey();
  if (!apiKey) {
    alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  chatHistory.push({
    type: chatType,
    role: 'user',
    content: message,
    timestamp: new Date().toISOString()
  });
  
  // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
  input.value = '';
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  displayChatMessage('user', message);
  
  // AIå¿œç­”ã‚’å–å¾—ï¼ˆãƒ‡ãƒ¢ï¼‰
  const response = await getChatResponse(message, chatType, apiKey);
  
  // AIå¿œç­”ã‚’è¿½åŠ 
  chatHistory.push({
    type: chatType,
    role: 'assistant',
    content: response,
    timestamp: new Date().toISOString()
  });
  
  saveLocalData();
  displayChatMessage('assistant', response);
}

function displayChatMessage(role, content) {
  const messagesDiv = document.getElementById('chatMessages');
  const align = role === 'user' ? 'right' : 'left';
  const bg = role === 'user' ? 'var(--green-soft)' : 'var(--bg-soft)';
  
  const messageHTML = `
    <div style="display: flex; justify-content: ${align === 'right' ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
      <div style="max-width: 75%; padding: 12px 16px; background: ${bg}; border-radius: 16px; font-size: 0.95rem; line-height: 1.6;">
        ${content}
      </div>
    </div>
  `;
  
  messagesDiv.insertAdjacentHTML('beforeend', messageHTML);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function getChatResponse(message, chatType, apiKey) {
  try {
    // Gemini APIå‘¼ã³å‡ºã—
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: message
          }]
        }]
      })
    });
    
    if (!response.ok) {
      throw new Error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼');
    }
    
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
    
  } catch (error) {
    console.error('Chat error:', error);
    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

// ===== ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ =====
function exportData() {
  const data = {
    events: localEvents,
    todos: localTodos,
    logs: localLogs,
    chats: chatHistory,
    exportedAt: new Date().toISOString()
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `banso-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');
}

function importData(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        localEvents = data.events || [];
        localTodos = data.todos || [];
        localLogs = data.logs || [];
        chatHistory = data.chats || [];
        saveLocalData();
        
        updateCalendarView();
        updateTodoView();
        updateLogView();
        
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
      }
    } catch (err) {
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };
  reader.readAsText(file);
}

function updateCalendarView() {
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šæœ€è¿‘ã®äºˆå®šï¼ˆä»Šæ—¥ã€œ7æ—¥å¾Œã¾ã§ï¼‰ã‚’æ—¥ä»˜é †ã§è¡¨ç¤º
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  const weekLater = new Date(today);
  weekLater.setDate(weekLater.getDate() + 7);
  const weekLaterStr = weekLater.toISOString().split('T')[0];

  const recentEvents = localEvents
    .filter(e => e.date >= todayStr && e.date <= weekLaterStr)
    .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

  let html = '';
  if (recentEvents.length === 0) {
    html = '<div style="padding: 24px 22px; text-align: center; color: var(--text-quiet);">';
    html += '<div style="margin-bottom: 12px;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    html += '</div>';
  } else {
    html = '<div style="padding: 12px 22px;">';
    let lastDate = '';
    recentEvents.forEach(event => {
      const dateLabel = formatScheduleDate(event.date);
      if (event.date !== lastDate) {
        lastDate = event.date;
        html += `<div style="font-size: 0.8rem; font-weight: 700; color: var(--green); margin: 12px 0 6px 0; padding-bottom: 4px;">${dateLabel}</div>`;
      }
      html += `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 10px; background: var(--bg-soft); border-radius: 8px;">
          <div style="font-size: 0.9rem; font-weight: 700; color: var(--text); min-width: 48px;">${event.time}</div>
          <div style="flex: 1;">
            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text);">${event.title}</div>
            ${event.note ? `<div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 2px;">${event.note}</div>` : ''}
          </div>
        </div>
      `;
    });
    html += '</div>';
  }
  html += '<div class="card-plus-row"><button type="button" class="card-plus-btn" onclick="openOverlay(\'add-event\')" title="äºˆå®šã‚’è¿½åŠ "><span class="plus-icon">â•</span> äºˆå®šã‚’è¿½åŠ </button></div>';

  const calCard = document.getElementById('card1');
  if (calCard) {
    const body = calCard.querySelector('.card-body');
    if (body) body.innerHTML = html;
  }
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºç”¨ã®æ—¥ä»˜ãƒ©ãƒ™ãƒ«ï¼ˆä»Šæ—¥ / æ˜æ—¥ / 2/15(é‡‘)ï¼‰
function formatScheduleDate(dateStr) {
  const today = new Date().toISOString().split('T')[0];
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];

  if (dateStr === today) return 'ä»Šæ—¥';
  if (dateStr === tomorrowStr) return 'æ˜æ—¥';

  const d = new Date(dateStr + 'T12:00:00');
  const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const month = d.getMonth() + 1;
  const date = d.getDate();
  const day = weekdays[d.getDay()];
  return `${month}/${date}(${day})`;
}

function updateTodoView() {
  const incompleteTodos = localTodos.filter(t => !t.completed).sort((a, b) => {
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    return priorityOrder[a.priority] - priorityOrder[b.priority];
  });
  
  let html = '';
  if (incompleteTodos.length === 0) {
    html = '<div style="padding: 32px 22px; text-align: center; color: var(--text-quiet);">ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    html = '<div style="padding: 16px 22px;">';
    incompleteTodos.forEach(todo => {
      const priorityLabels = {
        high: 'ğŸ”´',
        medium: 'ğŸŸ¡',
        low: 'ğŸŸ¢'
      };
      html += `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: var(--bg-soft); border-radius: 8px;">
          <input type="checkbox" onchange="toggleTodo(${todo.id})" style="width: 20px; height: 20px; cursor: pointer;">
          <span style="font-size: 1rem;">${priorityLabels[todo.priority]}</span>
          <div style="flex: 1; font-size: 0.95rem; font-weight: 500; color: var(--text);">${todo.title}</div>
        </div>
      `;
    });
    html += '</div>';
  }
  html += '<div class="card-plus-row"><button type="button" class="card-plus-btn" onclick="openOverlay(\'add-todo\')" title="ã‚„ã‚‹ã“ã¨è¿½åŠ "><span class="plus-icon">â•</span> ã‚„ã‚‹ã“ã¨è¿½åŠ </button></div>';

  const todoCard = document.getElementById('card2');
  if (todoCard) {
    const body = todoCard.querySelector('.card-body');
    if (body) body.innerHTML = html;
  }
}

// ===== éŸ³å£°èªè­˜ =====
function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.log('éŸ³å£°èªè­˜ã¯éå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = function() {
    isListening = true;
    document.getElementById('voiceFab').classList.add('listening');
    document.getElementById('voiceBanner').classList.add('show');
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    const banner = document.getElementById('voiceText');
    if (banner) banner.textContent = 'ã€Œ' + transcript + 'ã€';
    if (currentVoiceOverlay === 'event') {
      const el = document.getElementById('eventTitle');
      if (el) { el.value = transcript; el.focus(); }
      currentVoiceOverlay = null;
      return;
    }
    if (currentVoiceOverlay === 'todo') {
      const el = document.getElementById('todoTitle');
      if (el) { el.value = transcript; el.focus(); }
      currentVoiceOverlay = null;
      return;
    }
    if (currentVoiceOverlay === 'log') {
      const el = document.getElementById('logContent');
      if (el) { el.value = transcript; el.focus(); }
      currentVoiceOverlay = null;
      return;
    }
    processVoiceCommand(transcript);
  };

  recognition.onerror = function(event) {
    console.log('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
    stopVoice();
  };

  recognition.onend = function() {
    stopVoice();
  };
}

function toggleVoice() {
  const voiceBtn = document.querySelector('[data-i18n="btn-voice"]').closest('.action-btn');
  if (isListening) {
    stopVoice();
    voiceBtn.style.background = 'linear-gradient(135deg, var(--green) 0%, #4E7C4D 100%)';
  } else {
    startVoice();
    voiceBtn.style.background = 'linear-gradient(135deg, var(--rose) 0%, #A04545 100%)';
  }
}

function startVoice() {
  if (!recognition) {
    alert('éŸ³å£°èªè­˜ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚Chrome/Safari/Edgeã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
    return;
  }
  recognition.start();
}

function startVoiceForOverlay(type) {
  currentVoiceOverlay = type;
  startVoice();
}

function stopVoice() {
  isListening = false;
  document.getElementById('voiceFab').classList.remove('listening');
  setTimeout(() => {
    document.getElementById('voiceBanner').classList.remove('show');
  }, 1500);
}

function processVoiceCommand(text) {
  const normalized = text.toLowerCase().replace(/\s/g, '');
  
  // ã‚³ãƒãƒ³ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
  for (let num in VOICE_COMMANDS) {
    const cmd = VOICE_COMMANDS[num];
    for (let keyword of cmd.keywords) {
      if (normalized.includes(keyword)) {
        speak(cmd.label + 'ã‚’é–‹ãã¾ã™');
        executeCommand(parseInt(num));
        return;
      }
    }
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šãƒ¡ãƒ¼ãƒ«
  if (normalized.includes('ãƒ¡ãƒ¼ãƒ«') && (normalized.includes('èª­') || normalized.includes('ã‚ˆ'))) {
    speak('ãƒ¡ãƒ¼ãƒ«ã‚’èª­ã¿ä¸Šã’ã¾ã™');
    readMail();
    return;
  }

  if (normalized.includes('è¿”ä¿¡') || normalized.includes('ã¸ã‚“ã—ã‚“')) {
    speak('ãƒ¡ãƒ¼ãƒ«ã®è¿”ä¿¡ã‚’è€ƒãˆã¾ã™');
    openOverlay('mail-reply');
    return;
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šäºˆå®šè¿½åŠ 
  if ((normalized.includes('äºˆå®š') || normalized.includes('ã‚ˆã¦ã„')) && 
      (normalized.includes('è¿½åŠ ') || normalized.includes('ã¤ã„ã‹') || normalized.includes('ã¤ãã£'))) {
    speak('äºˆå®šã‚’è¿½åŠ ã—ã¾ã™');
    openOverlay('add-event');
    return;
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šTodoè¿½åŠ 
  if ((normalized.includes('todo') || normalized.includes('ã¨ã…ãƒ¼ã©ã…ãƒ¼') || normalized.includes('ã‚„ã‚‹ã“ã¨')) && 
      (normalized.includes('è¿½åŠ ') || normalized.includes('ã¤ã„ã‹'))) {
    speak('Todoã‚’è¿½åŠ ã—ã¾ã™');
    openOverlay('add-todo');
    return;
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šå¤©æ°—
  if (normalized.includes('å¤©æ°—') || normalized.includes('ã¦ã‚“ã')) {
    speak('å¤©æ°—äºˆå ±ã‚’è¡¨ç¤ºã—ã¾ã™');
    openOverlay('weather');
    return;
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  if (normalized.includes('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼') || normalized.includes('ã‹ã‚Œã‚“ã ãƒ¼')) {
    speak('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¾ã™');
    openOverlay('calendar');
    return;
  }

  // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼šè¨˜éŒ²
  if ((normalized.includes('è¨˜éŒ²') || normalized.includes('ãã‚ã')) && 
      (normalized.includes('ã—ã¦') || normalized.includes('ã—ãŸ'))) {
    const match = text.match(/è¨˜éŒ²[ï¼š:ã—ã¦]*(.+)/i);
    if (match && match[1]) {
      const logContent = match[1].trim();
      const newLog = {
        id: Date.now(),
        content: logContent,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0].substring(0, 5),
        createdAt: new Date().toISOString()
      };
      localLogs.push(newLog);
      saveLocalData();
      updateLogView();
      speak('è¨˜éŒ²ã—ã¾ã—ãŸ');
      return;
    }
  }

  // èãå–ã‚Œãªã‹ã£ãŸ
  speak('ã‚‚ã†ä¸€åº¦ã€ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„');
  setTimeout(() => startVoice(), 1500);
}

function executeCommand(num) {
  const cmd = VOICE_COMMANDS[num];
  if (!cmd) return;

  switch(cmd.action) {
    case 'home':
      if (currentMode === 'out') openMap();
      else speak('ä»Šã¯åœ¨å®…ãƒ¢ãƒ¼ãƒ‰ã§ã™');
      break;
    case 'log':
      openOverlay('log');
      break;
    case 'video':
      openOverlay('video');
      break;
    case 'call':
      openOverlay('call');
      break;
    case 'mail':
      readMail();
      break;
    case 'chat':
      openOverlay('chat');
      break;
    case 'schedule':
      readSchedule();
      break;
    case 'places':
      openOverlay('places');
      break;
    case 'idcard':
      openOverlay('idcard');
      break;
  }
}

function speak(text) {
  if (!synthesis) return;
  synthesis.cancel(); // æ—¢å­˜ã®ç™ºè©±ã‚’åœæ­¢
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'ja-JP';
  utterance.rate = 0.9; // ã‚†ã£ãã‚Š
  utterance.pitch = 1.1; // å°‘ã—é«˜ã‚ï¼ˆå„ªã—ã„å£°ï¼‰
  synthesis.speak(utterance);
}

function readMail() {
  // ãƒ‡ãƒ¢ï¼šæœ€æ–°ãƒ¡ãƒ¼ãƒ«ã‚’èª­ã¿ä¸Šã’
  speak('å¤ªéƒã•ã‚“ã‹ã‚‰ã€é€±æœ«éŠã³ã«è¡Œãã­ã€ã¨ã„ã†ãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚åœŸæ›œæ—¥ã®æ˜¼é ƒç€ãã‚ˆã€‚ä½•ã‹é£Ÿã¹ãŸã„ã‚‚ã®ã‚ã‚‹ï¼Ÿ');
}

function readSchedule() {
  // ãƒ‡ãƒ¢ï¼šä»Šæ—¥ã®äºˆå®šã‚’èª­ã¿ä¸Šã’
  speak('ä»Šæ—¥ã®äºˆå®šã§ã™ã€‚åˆå¾Œ2æ™‚ã€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã€‚ãŠè¿ãˆãŒæ¥ã¾ã™ã€‚åˆå¾Œ6æ™‚30åˆ†ã€å¤œã®æœè–¬ã§ã™ã€‚');
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œï¼ˆæ•°å­—ã‚­ãƒ¼ï¼‰
document.addEventListener('keydown', function(e) {
  const num = parseInt(e.key);
  if (num >= 1 && num <= 9) {
    executeCommand(num);
  }
});

// æ•°å­—ãƒ‘ãƒƒãƒ‰è¡¨ç¤ºåˆ‡æ›¿
function toggleNumpad() {
  document.getElementById('numpad').classList.toggle('show');
}

// ===== åˆæœŸåŒ– =====
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¤§ãã‚æ–‡å­—ï¼ˆFire TVãƒ¬ãƒ™ãƒ«ï¼‰ãƒ»æ¼¢å­—ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
document.body.classList.add(textLevels[textLevel]); // text-md (154%)
document.getElementById('btnText').classList.add('active'); // æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
document.getElementById('btnKana').classList.add('active'); // æ¼¢å­—ãƒ¢ãƒ¼ãƒ‰ï¼ˆã€Œã²ã€ã§åˆ‡æ›¿å¯èƒ½ï¼‰

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
loadLocalData();

// éŸ³å£°èªè­˜åˆæœŸåŒ–
initVoiceRecognition();

// åˆå›è¨ªå•ãƒã‚§ãƒƒã‚¯
checkFirstVisit();

// æ•°å­—ã‚¬ã‚¤ãƒ‰ã®è¨­å®šã‚’å¾©å…ƒ
const savedGuide = localStorage.getItem('showNumberGuide');
if (savedGuide !== null) {
  showNumberGuide = savedGuide === 'true';
  if (!showNumberGuide) {
    document.querySelectorAll('.number-badge').forEach(b => b.classList.remove('show'));
  }
}

// 30ç§’å¾Œã«ç‚¹æ»…ã‚’åœæ­¢
setTimeout(() => {
  document.querySelectorAll('.number-badge').forEach(badge => {
    badge.classList.remove('blink');
    badge.classList.add('blink-stop');
  });
}, 30000);

updateClock();
applyI18N();
setInterval(updateClock, 1000);
demoGPS();

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»Todoãƒ»è¨˜éŒ²ã®è¡¨ç¤ºã‚’æ›´æ–°
updateCalendarView();
updateTodoView();
updateLogView();
</script>

</body>
</html>
