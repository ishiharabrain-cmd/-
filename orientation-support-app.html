<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .info-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .time-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3.5em;
            font-weight: bold;
            color: #667eea;
            line-height: 1.2;
        }

        .current-date {
            font-size: 1.8em;
            color: #555;
            margin-top: 10px;
        }

        .location-display {
            text-align: center;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 15px;
            margin-top: 20px;
        }

        .location-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .location-text {
            font-size: 1.3em;
            color: #333;
            line-height: 1.6;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .action-button {
            background: white;
            border: none;
            border-radius: 15px;
            padding: 25px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .action-button .icon {
            font-size: 1.8em;
        }

        .home-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 1.8em;
            padding: 30px;
        }

        .video-button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .photo-button {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .medicine-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .find-button {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .call-button {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .loading {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            padding: 10px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-close {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.5em;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
        }

        .photo-preview {
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #sendPhotoBtn {
            background: #30cfd0;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.3em;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
        }

        .remember-section {
            background: white;
            border-radius: 15px;
            padding: 16px;
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .remember-section h3 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remember-list-preview {
            max-height: 7.5em;
            overflow-y: auto;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .remember-list-preview .remember-row {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }
        .remember-list-preview .remember-row:last-child { border-bottom: none; }
        .remember-list-preview .remember-row.in-progress {
            color: #c62828;
            font-weight: bold;
        }
        .remember-more {
            margin-top: 8px;
            text-align: center;
        }
        .remember-more button {
            background: none;
            border: none;
            color: #667eea;
            font-size: 0.9em;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ™‚é–“ãƒ»å ´æ‰€æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="info-panel">
            <div class="time-display">
                <div class="current-time" id="currentTime">--:--</div>
                <div class="current-date" id="currentDate">----å¹´--æœˆ--æ—¥</div>
                <div id="headerVersion" style="margin-top: 10px; font-size: 0.9em; color: #999;">Ver 1.1.1</div>
            </div>
            
            <div class="location-display">
                <div class="location-icon">ğŸ“</div>
                <div class="location-text" id="locationText">
                    <div class="loading">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                </div>
            </div>
            <div class="weather-display" id="weatherDisplay" style="text-align: center; padding: 12px; background: #f0f4ff; border-radius: 12px; margin-top: 12px; font-size: 0.95em;">
                <span style="color:#999;">â€”</span>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="button-grid">
            <button class="action-button home-button" onclick="goHome()">
                <span class="icon">ğŸ </span>
                <span>å®¶ã«å¸°ã‚‹</span>
            </button>

        <!-- è¦šãˆã¦ãŠãã“ã¨ï¼ˆå®¶ã«å¸°ã‚‹ã®ä¸‹ãƒ»ä¸€è¦§è¡¨ç¤ºï¼‰ -->
        <div class="remember-section">
            <h3>
                <span>ğŸ“ è¦šãˆã¦ãŠãã“ã¨</span>
                <button type="button" onclick="showRememberList()" style="background:#667eea;color:white;border:none;border-radius:8px;padding:6px 12px;font-size:0.85em;cursor:pointer;">ç·¨é›†</button>
            </h3>
            <div id="rememberListPreview" class="remember-list-preview">
                <!-- JSã§æç”» -->
            </div>
            <div id="rememberMoreArea" class="remember-more" style="display:none;">
                <button type="button" onclick="showRememberList()">5ä»¶ä»¥ä¸Šã‚ã‚Šã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã—ã¦å…¨ã¦è¦‹ã‚‹</button>
            </div>
        </div>

            <button class="action-button video-button" onclick="watchVideo()">
                <span class="icon">ğŸ“¹</span>
                <span>å‹•ç”»ã‚’è¦‹ã‚‹</span>
            </button>

            <button class="action-button photo-button" onclick="takePhoto()">
                <span class="icon">ğŸ“¸</span>
                <span>å†™çœŸã‚’æ’®ã£ã¦é€ã‚‹</span>
            </button>

            <button class="action-button medicine-button" onclick="showMedicine()">
                <span class="icon">ğŸ’Š</span>
                <span>è–¬ã®æ™‚é–“</span>
            </button>

            <button class="action-button find-button" onclick="findThings()">
                <span class="icon">ğŸ”</span>
                <span>ç‰©ã‚’æ¢ã™</span>
            </button>

            <button class="action-button call-button" onclick="callFamily()">
                <span class="icon">ğŸ“</span>
                <span>å®¶æ—ã«é›»è©±</span>
            </button>

            <button class="action-button" onclick="openSettings()" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color: #333;">
                <span class="icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </button>
        </div>

        <!-- QRã‚³ãƒ¼ãƒ‰ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± -->
        <div class="info-panel" style="margin-top: 20px; text-align: center; padding: 20px;">
            <button onclick="showQRCode()" style="background: white; border: 2px solid #667eea; color: #667eea; padding: 15px 30px; border-radius: 10px; font-size: 1.2em; cursor: pointer; width: 100%;">
                ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            </button>
            <p id="panelVersion" style="margin-top: 15px; color: white; font-size: 1.1em; font-weight: bold;">
                Version 1.1.1
            </p>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em;">
                2026-02-07
            </p>
            <p style="margin-top: 16px; font-size: 0.85em;">
                <a id="lineAiLink" href="#" target="_blank" rel="noopener" style="color: #667eea;">AIçŸ³åŸå…ˆç”Ÿã¸ã®Lineç›¸è«‡ã¯ã“ã¡ã‚‰</a>
            </p>
            <p style="margin-top: 4px; font-size: 0.7em; color: #888;">â€»AIã®ãŸã‚æ­£ç¢ºã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</p>

            <!-- ã‚¢ãƒ—ãƒªã®æ›´æ–°ï¼ˆQRã‚³ãƒ¼ãƒ‰ã®ä¸‹ï¼‰ -->
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.3);">
                <p style="font-size: 0.9em; margin-bottom: 8px;">ğŸ”„ ã‚¢ãƒ—ãƒªã®æ›´æ–°</p>
                <p style="font-size: 0.85em; margin-bottom: 8px;">ç¾åœ¨: <strong id="mainAppVersionDisplay">--</strong></p>
                <div id="mainUpdateButtonArea" style="display: none;">
                    <p style="font-size: 0.8em; color: #ffcc80; margin-bottom: 8px;">æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™</p>
                    <button type="button" onclick="loadNewVersion()" style="width: 100%; padding: 12px; font-size: 1em; border-radius: 10px; border: none; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; cursor: pointer;">ğŸ”„ æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§èª­ã¿è¾¼ã‚€</button>
                </div>
                <p id="mainAlreadyLatestMessage" style="font-size: 0.85em; color: #a5d6a7; display: none;">æœ€æ–°ç‰ˆã‚’ã”åˆ©ç”¨ä¸­ã§ã™</p>
            </div>
        </div>
    </div>

    <!-- å†™çœŸæ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="photoModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">å†™çœŸã‚’æ’®ã‚Šã¾ã™</h2>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="photoPreview" class="photo-preview" style="display: none;">
            <button id="captureBtn" onclick="capturePhoto()" style="background: #30cfd0; color: white; border: none; border-radius: 10px; padding: 15px; font-size: 1.3em; margin-top: 10px; cursor: pointer; width: 100%;">ğŸ“¸ æ’®å½±ã™ã‚‹</button>
            <button id="sendPhotoBtn" onclick="sendPhoto()" style="display: none;">å®¶æ—ã«é€ã‚‹</button>
            <button class="modal-close" onclick="closePhotoModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="generalModal">
        <div class="modal-content">
            <div id="modalBody"></div>
            <button class="modal-close" onclick="closeGeneralModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã“ã“ã ã‘å¤‰æ›´ã™ã‚Œã°OKï¼‰
        const APP_VERSION = '1.1.2';
        localStorage.setItem('appVersion', APP_VERSION);
        document.getElementById('headerVersion').textContent = 'Ver ' + APP_VERSION;
        document.getElementById('panelVersion').textContent = 'Version ' + APP_VERSION;

        // AIçŸ³åŸå…ˆç”Ÿã¸ã®Lineç›¸è«‡ã¯ã“ã¡ã‚‰ï¼ˆLINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆURLï¼‰
        const LINE_AI_CONSULT_URL = 'https://lin.ee/7zY8dMP';
        var lineAiEl = document.getElementById('lineAiLink');
        if (lineAiEl) lineAiEl.href = LINE_AI_CONSULT_URL;

        // ã‚¢ãƒ—ãƒªã®æ›´æ–°ï¼ˆé…å¸ƒä¸­ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼APP_VERSIONã¨åˆã‚ã›ã‚‹ï¼‰
        const RELEASED_VERSION = '1.1.2';
        function isNewerVersion(released, current) {
            if (!current) return true;
            var r = released.split('.').map(Number);
            var c = current.split('.').map(Number);
            for (var i = 0; i < Math.max(r.length, c.length); i++) {
                var rn = r[i] || 0, cn = c[i] || 0;
                if (rn > cn) return true;
                if (rn < cn) return false;
            }
            return false;
        }
        function loadNewVersion() {
            var mainUrl = 'orientation-support-app.html?nocache=' + Date.now();
            if ('caches' in window) {
                caches.keys().then(function(keys) {
                    return Promise.all(keys.map(function(k) { return caches.delete(k); }));
                }).then(function() { window.location.href = mainUrl; }).catch(function() { window.location.href = mainUrl; });
            } else {
                window.location.href = mainUrl;
            }
        }
        (function() {
            var current = localStorage.getItem('appVersion') || '';
            var el = document.getElementById('mainAppVersionDisplay');
            if (el) el.textContent = current || 'ï¼ˆä¸æ˜ï¼‰';
            var area = document.getElementById('mainUpdateButtonArea');
            var latestMsg = document.getElementById('mainAlreadyLatestMessage');
            if (isNewerVersion(RELEASED_VERSION, current)) {
                if (area) area.style.display = 'block';
                if (latestMsg) latestMsg.style.display = 'none';
            } else {
                if (area) area.style.display = 'none';
                if (latestMsg) latestMsg.style.display = 'block';
            }
        })();

        // æ™‚åˆ»æ›´æ–°
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // ä½ç½®æƒ…å ±å–å¾—
        function updateLocation() {
            if (navigator.geolocation) {
                // iPhone/Safariå¯¾å¿œ: ã‚ˆã‚Šç©æ¥µçš„ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // ä½ç½®æƒ…å ±ã‚’ä¿å­˜
                        window.currentLocation = { lat, lon };
                        
                        // ä½æ‰€ã‚’å–å¾—ï¼ˆOpenStreetMap Nominatim APIä½¿ç”¨ï¼‰
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ja`
                            );
                            const data = await response.json();
                            
                            let address = '';
                            if (data.address) {
                                const addr = data.address;
                                address = [
                                    addr.city || addr.town || addr.village || '',
                                    addr.suburb || addr.neighbourhood || '',
                                    addr.road || ''
                                ].filter(x => x).join('');
                            }
                            
                            document.getElementById('locationText').innerHTML = `
                                <strong>ç¾åœ¨åœ°</strong><br>
                                ${address || 'ä½æ‰€ã‚’å–å¾—ä¸­...'}<br>
                                <small style="color: #999;">ç·¯åº¦: ${lat.toFixed(4)}, çµŒåº¦: ${lon.toFixed(4)}</small><br>
                                <button onclick="openMapsApp()" style="margin-top: 10px; padding: 8px 15px; background: #4285F4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                    ğŸ—ºï¸ åœ°å›³ã§ç¢ºèª
                                </button>
                            `;
                        } catch (error) {
                            document.getElementById('locationText').innerHTML = `
                                <strong>ç¾åœ¨åœ°</strong><br>
                                ç·¯åº¦: ${lat.toFixed(4)}<br>
                                çµŒåº¦: ${lon.toFixed(4)}<br>
                                <button onclick="openMapsApp()" style="margin-top: 10px; padding: 8px 15px; background: #4285F4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                    ğŸ—ºï¸ åœ°å›³ã§ç¢ºèª
                                </button>
                            `;
                        }
                        updateWeather(lat, lon);
                    },
                    (error) => {
                        document.getElementById('locationText').innerHTML = `
                            <span style="color: #666;">ä½ç½®æƒ…å ±ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“</span><br>
                            <button onclick="openMapsApp()" style="margin-top: 10px; padding: 12px 20px; background: #4285F4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; width: 100%;">
                                ğŸ—ºï¸ åœ°å›³ã‚¢ãƒ—ãƒªã§ç¾åœ¨åœ°ã‚’ç¢ºèª
                            </button>
                        `;
                        document.getElementById('weatherDisplay').innerHTML = '<span style="color:#999;">â€”</span>';
                    },
                    options
                );
            }
        }

        // å¤©æ°—ãƒ»æ°—æ¸©ãƒ»æœè£…ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆOpen-Meteoï¼‰
        function weatherCodeToLabel(code) {
            if (code === 0) return 'æ™´ã‚Œ';
            if (code >= 1 && code <= 3) return 'æ›‡ã‚Š';
            if (code === 45 || code === 48) return 'éœ§';
            if (code >= 51 && code <= 67) return 'é›¨';
            if (code >= 71 && code <= 77) return 'é›ª';
            if (code >= 80 && code <= 82) return 'ã«ã‚ã‹é›¨';
            if (code >= 85 && code <= 86) return 'ã«ã‚ã‹é›ª';
            if (code === 95) return 'é›·é›¨';
            return 'â€”';
        }
        function getClothingAdvice(temp) {
            if (temp >= 28) return 'æš‘ã„ã®ã§è–„ç€ã§';
            if (temp >= 25) return 'åŠè¢–ã§OK';
            if (temp >= 20) return 'é•·è¢–ãŒå®‰å¿ƒ';
            if (temp >= 15) return 'ä¸Šç€ãŒã‚ã‚‹ã¨è‰¯ã„';
            if (temp >= 10) return 'æš–ã‹ãã—ã¦';
            if (temp >= 5) return 'ã‚³ãƒ¼ãƒˆæ¨å¥¨';
            return 'é˜²å¯’ã‚’';
        }
        async function updateWeather(lat, lon) {
            const el = document.getElementById('weatherDisplay');
            if (!el) return;
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=Asia/Tokyo`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.current) { el.innerHTML = '<span style="color:#999;">â€”</span>'; return; }
                const temp = Math.round(data.current.temperature_2m);
                const code = data.current.weather_code || 0;
                const weatherLabel = weatherCodeToLabel(code);
                const advice = getClothingAdvice(temp);
                el.innerHTML = '<strong>ğŸŒ¤ å¤©æ°—</strong> ' + weatherLabel + 'ã€€<strong>ğŸŒ¡ æ°—æ¸©</strong> ' + temp + 'Â°C<br><span style="color:#555;">ğŸ‘• ' + advice + '</span>';
            } catch (e) {
                el.innerHTML = '<span style="color:#999;">â€”</span>';
            }
        }

        // å®¶ã«å¸°ã‚‹
        function goHome() {
            const homeAddress = localStorage.getItem('homeAddress');
            
            if (!homeAddress) {
                alert('è‡ªå®…ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§è‡ªå®…ä½æ‰€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (window.currentLocation) {
                const { lat, lon } = window.currentLocation;
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${encodeURIComponent(homeAddress)}`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(homeAddress)}`, '_blank');
            }
        }

        // å‹•ç”»ã‚’è¦‹ã‚‹ï¼ˆè¨­å®šã§ç™»éŒ²ã—ãŸæ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’åˆ©ç”¨å¯èƒ½ï¼‰
        function watchVideo() {
            const fav = (localStorage.getItem('youtubeSearchKeyword') || '').trim();
            const message = `
                <h2 style="text-align: center;">ğŸ“¹ å‹•ç”»ã‚’è¦‹ã‚‹</h2>
                <p style="font-size: 1.1em; text-align: center; margin: 15px 0; color: #666;">è¦‹ãŸã„å‹•ç”»ã®ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ¤œç´¢</p>
                <input type="text" id="videoSearch" value="${fav ? fav.replace(/"/g, '&quot;') : ''}" placeholder="è¦‹ãŸã„å‹•ç”»ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; font-size: 1.2em; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 10px;">
                <button onclick="searchYouTube()" style="width: 100%; padding: 15px; font-size: 1.3em; border-radius: 10px; border: none; background: #fa709a; color: white; cursor: pointer; margin-bottom: 10px;">ğŸ” æ¤œç´¢ã™ã‚‹</button>
                ${fav ? '<button type="button" data-search="' + escapeAttr(fav) + '" onclick="playYouTube(this.getAttribute(\'data-search\'))" style="width: 100%; padding: 14px; font-size: 1.2em; border-radius: 10px; border: none; background: #e0c3fc; color: #333; cursor: pointer; margin-bottom: 15px;">â­ ãŠæ°—ã«å…¥ã‚Šã§æ¤œç´¢</button>' : ''}
                <div style="display: grid; gap: 10px;">
                    <button onclick="playYouTube(\'ç™’ã—ã®éŸ³æ¥½\')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸµ ç™’ã—ã®éŸ³æ¥½</button>
                    <button onclick="playYouTube(\'æ‡ã‹ã—ã„æ­Œ\')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ¤ æ‡ã‹ã—ã„æ­Œ</button>
                    <button onclick="playYouTube(\'è‡ªç„¶ã®æ˜ åƒ\')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸŒ¿ è‡ªç„¶ã®æ˜ åƒ</button>
                    <button onclick="playYouTube(\'çŒ«ã®å‹•ç”»\')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ± çŒ«ã®å‹•ç”»</button>
                </div>
            `;
            showGeneralModal(message);
        }

        function searchYouTube() {
            const query = document.getElementById('videoSearch').value;
            if (query) {
                playYouTube(query);
            }
        }

        function playYouTube(query) {
            if (!query) return;
            const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
            window.open(youtubeUrl, '_blank');
            closeGeneralModal();
        }

        // å†™çœŸæ’®å½±
        let stream = null;
        let capturedPhoto = null;

        async function takePhoto() {
            const modal = document.getElementById('photoModal');
            const video = document.getElementById('video');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                modal.classList.add('active');
                
                document.getElementById('captureBtn').style.display = 'block';
                document.getElementById('sendPhotoBtn').style.display = 'none';
                document.getElementById('photoPreview').style.display = 'none';
                video.style.display = 'block';
            } catch (err) {
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg');
            preview.src = capturedPhoto;
            
            video.style.display = 'none';
            preview.style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('sendPhotoBtn').style.display = 'block';
        }

        function sendPhoto() {
            const message = `
                <h2 style="text-align: center;">ğŸ“¸ å†™çœŸã‚’é€ã‚‹</h2>
                <img src="${capturedPhoto}" style="width: 100%; border-radius: 10px; margin: 20px 0;">
                <p style="font-size: 1.3em; text-align: center; margin-bottom: 20px;">
                    ã©ã“ã«é€ã‚Šã¾ã™ã‹ï¼Ÿ
                </p>
                <div style="display: grid; gap: 10px;">
                    <button onclick="sendViaLine()" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #06C755; color: white; cursor: pointer;">
                        ğŸ“± LINEã§é€ã‚‹
                    </button>
                    <button onclick="sendViaEmail()" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #4285F4; color: white; cursor: pointer;">
                        âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã§é€ã‚‹
                    </button>
                </div>
            `;
            
            closePhotoModal();
            showGeneralModal(message);
        }

        function sendViaLine() {
            // LINEã§å…±æœ‰ï¼ˆWebç‰ˆï¼‰
            // å®Ÿéš›ã«ã¯LINE Messaging APIã¾ãŸã¯LIFF SDKã‚’ä½¿ç”¨
            const text = 'å†™çœŸã‚’é€ã‚Šã¾ã™';
            const lineUrl = `https://line.me/R/share?text=${encodeURIComponent(text)}`;
            
            // ãƒ‡ãƒ¼ã‚¿URLã‚’Blobã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadPhoto();
            
            alert('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nLINEã‚’é–‹ã„ã¦å†™çœŸã‚’æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
            window.open(lineUrl, '_blank');
            closeGeneralModal();
        }

        function sendViaEmail() {
            // ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
            // å®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é€ä¿¡ã™ã‚‹ã‹ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
            downloadPhoto();
            
            const familyEmail = localStorage.getItem('familyEmail') || '';
            if (!familyEmail) {
                const email = prompt('å®¶æ—ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (email) {
                    localStorage.setItem('familyEmail', email);
                    sendEmailWithPhoto(email);
                }
            } else {
                sendEmailWithPhoto(familyEmail);
            }
        }

        function sendEmailWithPhoto(email) {
            const subject = 'å†™çœŸã‚’é€ã‚Šã¾ã™';
            const body = 'å†™çœŸã‚’æ·»ä»˜ã—ã¾ã—ãŸã€‚';
            
            alert('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦å†™çœŸã‚’æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            closeGeneralModal();
        }

        function downloadPhoto() {
            const link = document.createElement('a');
            link.download = `photo_${Date.now()}.jpg`;
            link.href = capturedPhoto;
            link.click();
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // è¨­å®šã‹ã‚‰æœè–¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—ï¼ˆæ—§å½¢å¼ã¯è‡ªå‹•ç§»è¡Œï¼‰
        function getMedicineDoses() {
            const raw = localStorage.getItem('medicineDoses');
            if (raw) {
                try {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr) && arr.length >= 1) return arr;
                } catch (e) {}
            }
            return [
                { key: 'morning', label: 'æœ', time: localStorage.getItem('medicineMorning') || '08:00', timing: 'other' },
                { key: 'lunch', label: 'æ˜¼', time: localStorage.getItem('medicineLunch') || '12:00', timing: 'other' },
                { key: 'evening', label: 'å¤•æ–¹', time: localStorage.getItem('medicineEvening') || '18:00', timing: 'other' },
                { key: 'night', label: 'å¤œ', time: localStorage.getItem('medicineNight') || '21:00', timing: 'other' }
            ];
        }

        function getTimingLabel(timing) {
            return timing === 'before' ? 'é£Ÿå‰' : timing === 'after' ? 'é£Ÿå¾Œ' : 'ãã®ä»–';
        }

        // è–¬ã®æ™‚é–“
        function showMedicine() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const doses = getMedicineDoses();
            const timeToMinutes = (timeStr) => {
                const [h, m] = (timeStr || '08:00').split(':').map(Number);
                return h * 60 + m;
            };
            const dateStr = now.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' });

            let message = '<h2 style="text-align: center;">ğŸ’Š ãŠè–¬ã®ç®¡ç†</h2>';
            message += `<p style="text-align: center; color: #666; margin-bottom: 20px;">${dateStr}</p>`;

            let currentDose = null;
            let doseLabel = '';
            for (let i = 0; i < doses.length; i++) {
                const d = doses[i];
                const min = timeToMinutes(d.time);
                if (Math.abs(currentTime - min) <= 30) {
                    currentDose = d.key;
                    doseLabel = d.label + (d.timing !== 'other' ? 'ï¼ˆ' + getTimingLabel(d.timing) + 'ï¼‰' : '');
                    break;
                }
            }

            if (currentDose) {
                const today = now.toISOString().split('T')[0];
                const recordKey = `medicine_${currentDose}_${today}`;
                const taken = localStorage.getItem(recordKey);
                if (taken) {
                    message += `<div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <p style="font-size: 1.5em; text-align: center; color: #155724;">âœ… ${doseLabel}ã®ãŠè–¬</p>
                        <p style="text-align: center; color: #155724; margin-top: 10px;">é£²ã¿ã¾ã—ãŸï¼ï¼ˆ${taken}ï¼‰</p>
                    </div>`;
                } else {
                    message += `<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <p style="font-size: 1.8em; text-align: center; color: #856404;">ğŸ’Š ${doseLabel}ã®ãŠè–¬</p>
                        <p style="font-size: 1.3em; text-align: center; color: #856404; margin-top: 10px;">é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ</p>
                    </div>`;
                    message += `<button onclick="recordMedicine('${currentDose}')" style="width: 100%; padding: 20px; font-size: 1.5em; background: #28a745; color: white; border: none; border-radius: 10px; margin-bottom: 10px; cursor: pointer;">
                        âœ… é£²ã¿ã¾ã—ãŸ
                    </button>`;
                }
            }

            message += '<div style="margin-top: 30px;"><h3 style="text-align: center; margin-bottom: 15px;">ä»Šæ—¥ã®è¨˜éŒ²</h3>';
            message += getMedicineRecordHTML();
            message += '</div>';

            message += '<div style="margin-top: 30px; padding: 15px; background: #f8f9ff; border-radius: 10px;">';
            message += '<h3 style="text-align: center; margin-bottom: 10px;">æœ¬æ—¥ã®äºˆå®š</h3>';
            doses.forEach(d => {
                const t = d.timing !== 'other' ? 'ãƒ»' + getTimingLabel(d.timing) : '';
                message += `<p style="text-align: center;">${d.label} ${d.time}${t}</p>`;
            });
            message += '</div>';

            showGeneralModal(message);
        }
        
        // æœè–¬è¨˜éŒ²
        function recordMedicine(doseKey) {
            const doses = getMedicineDoses();
            const d = doses.find(x => x.key === doseKey);
            const label = d ? d.label + (d.timing !== 'other' ? 'ï¼ˆ' + getTimingLabel(d.timing) + 'ï¼‰' : '') : doseKey;
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const recordKey = `medicine_${doseKey}_${today}`;
            localStorage.setItem(recordKey, timeStr);
            const confirmNotify = confirm(`${label}ã®ãŠè–¬ã‚’é£²ã‚“ã ã“ã¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\n\nã”å®¶æ—ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ`);
            
            if (confirmNotify) {
                notifyFamily(label, timeStr);
            } else {
                closeGeneralModal();
                showMedicine(); // ç”»é¢ã‚’æ›´æ–°
            }
        }
        
        // å®¶æ—ã¸ã®é€šçŸ¥
        function notifyFamily(dose, time) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const familyEmail = localStorage.getItem('familyEmail');
            const family1Phone = localStorage.getItem('family1Phone');
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { 
                year: 'numeric',
                month: 'long', 
                day: 'numeric'
            });
            
            const message = `
                <h2 style="text-align: center;">ğŸ“¤ å®¶æ—ã«é€šçŸ¥</h2>
                <p style="text-align: center; margin: 20px 0;">
                    ${userName}ã•ã‚“ãŒ<br>
                    ${dateStr}<br>
                    ${dose}ã®ãŠè–¬ã‚’${time}ã«é£²ã¿ã¾ã—ãŸ
                </p>
                <div style="display: grid; gap: 10px;">
                    ${familyEmail ? `<button onclick="sendMedicineEmail('${dose}', '${time}', '${dateStr}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #4285F4; color: white; cursor: pointer;">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã§é€ã‚‹</button>` : ''}
                    ${family1Phone ? `<button onclick="sendMedicineSMS('${dose}', '${time}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #06C755; color: white; cursor: pointer;">ğŸ“± LINEã§é€ã‚‹</button>` : ''}
                </div>
                <button onclick="closeGeneralModal(); showMedicine();" style="width: 100%; padding: 15px; font-size: 1.2em; background: #f0f0f0; color: #333; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer;">
                    é€šçŸ¥ã—ãªã„
                </button>
            `;
            
            showGeneralModal(message);
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã§æœè–¬é€šçŸ¥
        function sendMedicineEmail(dose, time, date) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const email = localStorage.getItem('familyEmail');
            const subject = `ã€æœè–¬è¨˜éŒ²ã€‘${userName}ã•ã‚“ãŒ${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸ`;
            const body = `${userName}ã•ã‚“ãŒã€${date} ${time}ã«${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸã€‚\n\nâ€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã€Œã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã€ã‚¢ãƒ—ãƒªã‹ã‚‰è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            closeGeneralModal();
        }
        
        // LINEã§æœè–¬é€šçŸ¥
        function sendMedicineSMS(dose, time) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const text = `${userName}ã•ã‚“ãŒ${time}ã«${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸğŸ’Š`;
            const lineUrl = `https://line.me/R/share?text=${encodeURIComponent(text)}`;
            
            window.open(lineUrl, '_blank');
            closeGeneralModal();
        }
        
        // ä»Šæ—¥ã®æœè–¬è¨˜éŒ²HTML
        function getMedicineRecordHTML() {
            const today = new Date().toISOString().split('T')[0];
            const doses = getMedicineDoses();
            let html = '<div style="display: grid; gap: 10px;">';
            doses.forEach(d => {
                const recordKey = `medicine_${d.key}_${today}`;
                const taken = localStorage.getItem(recordKey);
                const timingStr = d.timing !== 'other' ? 'ãƒ»' + getTimingLabel(d.timing) : '';
                if (taken) {
                    html += `<div style="background: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.2em;">âœ… ${d.label}ï¼ˆ${d.time}${timingStr}ï¼‰</span>
                        <span style="color: #155724; font-size: 0.9em;">${taken}</span>
                    </div>`;
                } else {
                    html += `<div style="background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.2em; color: #999;">â­• ${d.label}ï¼ˆ${d.time}${timingStr}ï¼‰</span>
                        <span style="color: #999; font-size: 0.9em;">æœªæœè–¬</span>
                    </div>`;
                }
            });
            html += '</div>';
            return html;
        }

        // ç‰©ã‚’æ¢ã™
        function findThings() {
            const message = `
                <h2 style="text-align: center;">ğŸ” ç‰©ã‚’æ¢ã™</h2>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">
                    ã‚ˆãæ¢ã™ç‰©ã‚’é¸ã‚“ã§ãã ã•ã„
                </p>
                <div style="display: grid; gap: 10px;">
                    <button onclick="findItem('éµ', 'ğŸ”‘')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ”‘ éµ</span>
                        <span id="key-last" style="font-size: 0.8em; color: #999;"></span>
                    </button>
                    <button onclick="findItem('è²¡å¸ƒ', 'ğŸ‘›')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ‘› è²¡å¸ƒ</span>
                        <span id="wallet-last" style="font-size: 0.8em; color: #999;"></span>
                    </button>
                    <button onclick="findItem('ã‚¹ãƒãƒ›', 'ğŸ“±')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ“± ã‚¹ãƒãƒ›</span>
                        <span id="phone-last" style="font-size: 0.8em; color: #999;"></span>
                    </button>
                    <button onclick="findItem('ãƒ¡ã‚¬ãƒ', 'ğŸ‘“')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ‘“ ãƒ¡ã‚¬ãƒ</span>
                        <span id="glasses-last" style="font-size: 0.8em; color: #999;"></span>
                    </button>
                </div>
                <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">
                    ğŸ’¡ è¦‹ã¤ã‘ãŸã‚‰ã€Œè¦‹ã¤ã‘ãŸã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>å ´æ‰€ã‚’è¨˜éŒ²ã§ãã¾ã™
                </p>
            `;
            showGeneralModal(message);
            
            // æœ€å¾Œã«è¦‹ã¤ã‘ãŸå ´æ‰€ã‚’è¡¨ç¤º
            updateLastFound();
        }

        // è¦šãˆã¦ãŠãã“ã¨ï¼ˆãƒ¡ãƒ¢ï¼‰remindAt: "YYYY-MM-DDTHH:mm", endAt: åŒæ§˜ï¼ˆçœç•¥æ™‚ã¯é–‹å§‹+1hï¼‰
        const REMEMBER_LIST_KEY = 'rememberList';
        const REMEMBER_REMINDED_KEY = 'rememberReminded';
        function getRememberList() {
            try {
                const raw = localStorage.getItem(REMEMBER_LIST_KEY);
                if (raw) {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) return arr.map(function(it) {
                        if (!it.remindAt && (it.remindDate || it.remindTime)) {
                            it.remindAt = (it.remindDate || '').trim() && (it.remindTime || '').trim() ? (it.remindDate + 'T' + it.remindTime) : null;
                        }
                        return it;
                    });
                }
            } catch (e) {}
            return [];
        }
        function saveRememberList(list) {
            localStorage.setItem(REMEMBER_LIST_KEY, JSON.stringify(list));
            renderRememberPreview();
        }
        function isRememberItemInProgress(item) {
            if (!item.remindAt) return false;
            var start = parseRememberDateTime(item.remindAt);
            if (!start || isNaN(start)) return false;
            var endMs = item.endAt ? (parseRememberDateTime(item.endAt) || 0) : (start + 60 * 60 * 1000);
            var now = Date.now();
            return now >= start && now < endMs;
        }
        function parseRememberDateTime(s) {
            if (!s || typeof s !== 'string') return NaN;
            var d = new Date(s.replace('T', ' '));
            return isNaN(d.getTime()) ? NaN : d.getTime();
        }
        function formatRememberDateTime(s) {
            if (!s) return '';
            var d = new Date(s.replace('T', ' '));
            if (isNaN(d.getTime())) return s;
            return d.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function renderRememberPreview() {
            var list = getRememberList();
            var el = document.getElementById('rememberListPreview');
            var moreEl = document.getElementById('rememberMoreArea');
            if (!el) return;
            if (list.length === 0) {
                el.innerHTML = '<p style="color:#999;margin:0;">ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ç·¨é›†ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚</p>';
                if (moreEl) moreEl.style.display = 'none';
                return;
            }
            var showCount = 5;
            var inProgress = list.filter(isRememberItemInProgress);
            var rows = [];
            list.slice(0, showCount).forEach(function(item) {
                var isProg = isRememberItemInProgress(item);
                var timeStr = item.remindAt ? ' <span style="color:#666;font-size:0.9em;">(' + formatRememberDateTime(item.remindAt) + ')</span>' : '';
                rows.push('<div class="remember-row' + (isProg ? ' in-progress' : '') + '">' + escapeHtml(item.text) + timeStr + '</div>');
            });
            el.innerHTML = rows.join('');
            if (moreEl) {
                moreEl.style.display = list.length > showCount ? 'block' : 'none';
            }
        }
        function showRememberList() {
            var list = getRememberList();
            var html = '<h2 style="text-align: center; margin-bottom: 15px;">ğŸ“ è¦šãˆã¦ãŠãã“ã¨</h2>';
            html += '<p style="text-align: center; color: #666; font-size: 0.95em; margin-bottom: 15px;">ãƒ¡ãƒ¢ã¨ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚ï¼ˆä»»æ„ï¼‰ã‚’è¿½åŠ ãƒ»ç·¨é›†ã§ãã¾ã™ã€‚30åˆ†å‰ã¨é–‹å§‹æ™‚ã«é€šçŸ¥ã—ã¾ã™ã€‚</p>';
            if (list.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 20px;">ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¿½åŠ ã€ã§ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚</p>';
            } else {
                html += '<div style="display: grid; gap: 10px; margin-bottom: 15px;">';
                list.forEach(function(item) {
                    var isProg = isRememberItemInProgress(item);
                    var timeStr = item.remindAt ? ' <span style="font-size:0.9em;color:#666;">' + formatRememberDateTime(item.remindAt) + '</span>' : '';
                    html += '<div style="background:' + (isProg ? '#ffebee' : '#f8f9fa') + '; border-radius: 10px; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; gap: 10px; border-left: 4px solid ' + (isProg ? '#c62828' : '#ddd') + ';">';
                    html += '<span style="flex: 1; word-break: break-all;">' + escapeHtml(item.text) + timeStr + '</span>';
                    html += '<span style="flex-shrink: 0;">';
                    html += '<button onclick="editRememberItem(\'' + escapeAttr(item.id) + '\')" style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">ç·¨é›†</button> ';
                    html += '<button onclick="deleteRememberItem(\'' + escapeAttr(item.id) + '\')" style="padding: 8px 14px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">å‰Šé™¤</button>';
                    html += '</span></div>';
                });
                html += '</div>';
            }
            html += '<button onclick="showAddRememberForm()" style="width: 100%; padding: 16px; font-size: 1.2em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer;">ï¼‹ è¿½åŠ </button>';
            showGeneralModal(html);
        }
        function escapeHtml(s) {
            if (s == null) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function escapeAttr(s) {
            if (s == null) return '';
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        function showAddRememberForm() {
            closeGeneralModal();
            var html = '<h2 style="text-align: center; margin-bottom: 15px;">ğŸ“ è¿½åŠ </h2>';
            html += '<label style="display:block; margin-bottom: 4px;">å†…å®¹</label>';
            html += '<input type="text" id="newRememberText" placeholder="è¦šãˆã¦ãŠãã“ã¨" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:2px solid #ddd; font-size:1em;">';
            html += '<label style="display:block; margin-bottom: 4px;">ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚ï¼ˆä»»æ„ï¼‰</label>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">';
            html += '<input type="date" id="newRememberDate" style="padding:10px; border-radius:8px; border:2px solid #ddd;">';
            html += '<input type="time" id="newRememberTime" style="padding:10px; border-radius:8px; border:2px solid #ddd;">';
            html += '</div>';
            html += '<p style="font-size:0.85em; color:#666; margin-bottom:15px;">30åˆ†å‰ã¨é–‹å§‹æ™‚ã«é€šçŸ¥ã—ã¾ã™ã€‚æœªå…¥åŠ›ã®å ´åˆã¯ãƒ¡ãƒ¢ã®ã¿ã§ã™ã€‚</p>';
            html += '<button onclick="submitAddRemember()" style="width:100%; padding:16px; background:#28a745; color:white; border:none; border-radius:10px; font-size:1.1em; cursor:pointer;">ç™»éŒ²</button>';
            html += '<button onclick="showRememberList()" style="width:100%; padding:12px; margin-top:8px; background:#f0f0f0; color:#333; border:none; border-radius:10px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
            showGeneralModal(html);
            var d = new Date();
            document.getElementById('newRememberDate').value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            document.getElementById('newRememberTime').value = '09:00';
        }
        function submitAddRemember() {
            var text = (document.getElementById('newRememberText') && document.getElementById('newRememberText').value || '').trim();
            if (!text) { alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            var date = (document.getElementById('newRememberDate') && document.getElementById('newRememberDate').value || '').trim();
            var time = (document.getElementById('newRememberTime') && document.getElementById('newRememberTime').value || '').trim();
            var remindAt = (date && time) ? (date + 'T' + time) : null;
            var list = getRememberList();
            list.push({ id: 'id_' + Date.now(), text: text, remindAt: remindAt });
            saveRememberList(list);
            showRememberList();
        }
        function addRememberItem() {
            showAddRememberForm();
        }
        function showEditRememberForm(id) {
            var list = getRememberList();
            var item = list.find(function(x) { return x.id === id; });
            if (!item) { showRememberList(); return; }
            var parts = (item.remindAt || '').split('T');
            var date = (parts[0] || '').trim();
            var time = (parts[1] || '').trim();
            closeGeneralModal();
            var html = '<h2 style="text-align: center; margin-bottom: 15px;">ğŸ“ ç·¨é›†</h2>';
            html += '<label style="display:block; margin-bottom: 4px;">å†…å®¹</label>';
            html += '<input type="text" id="editRememberText" value="' + escapeAttr(item.text) + '" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:2px solid #ddd; font-size:1em;">';
            html += '<label style="display:block; margin-bottom: 4px;">ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚ï¼ˆä»»æ„ï¼‰</label>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">';
            html += '<input type="date" id="editRememberDate" value="' + escapeAttr(date) + '" style="padding:10px; border-radius:8px; border:2px solid #ddd;">';
            html += '<input type="time" id="editRememberTime" value="' + escapeAttr(time) + '" style="padding:10px; border-radius:8px; border:2px solid #ddd;">';
            html += '</div>';
            html += '<button onclick="submitEditRemember(\'' + escapeAttr(id) + '\')" style="width:100%; padding:16px; background:#28a745; color:white; border:none; border-radius:10px; font-size:1.1em; cursor:pointer;">ä¿å­˜</button>';
            html += '<button onclick="showRememberList()" style="width:100%; padding:12px; margin-top:8px; background:#f0f0f0; color:#333; border:none; border-radius:10px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
            showGeneralModal(html);
        }
        function submitEditRemember(id) {
            var text = (document.getElementById('editRememberText') && document.getElementById('editRememberText').value || '').trim();
            if (!text) { alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            var date = (document.getElementById('editRememberDate') && document.getElementById('editRememberDate').value || '').trim();
            var time = (document.getElementById('editRememberTime') && document.getElementById('editRememberTime').value || '').trim();
            var remindAt = (date && time) ? (date + 'T' + time) : null;
            var list = getRememberList();
            var item = list.find(function(x) { return x.id === id; });
            if (!item) { showRememberList(); return; }
            item.text = text;
            item.remindAt = remindAt;
            saveRememberList(list);
            showRememberList();
        }
        function editRememberItem(id) {
            showEditRememberForm(id);
        }
        function deleteRememberItem(id) {
            if (!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            var list = getRememberList().filter(function(x) { return x.id !== id; });
            saveRememberList(list);
            showRememberList();
        }
        function checkRememberReminders() {
            var list = getRememberList();
            var now = Date.now();
            var key30 = localStorage.getItem(REMEMBER_REMINDED_KEY) || '{}';
            try { key30 = JSON.parse(key30); } catch (e) { key30 = {}; }
            list.forEach(function(item) {
                if (!item.remindAt) return;
                var start = parseRememberDateTime(item.remindAt);
                if (isNaN(start)) return;
                var endMs = item.endAt ? (parseRememberDateTime(item.endAt) || 0) : (start + 60 * 60 * 1000);
                var k = item.id + '_' + item.remindAt;
                if (now >= start - 30 * 60 * 1000 && now < start - 25 * 60 * 1000 && !key30[k + '_30']) {
                    key30[k + '_30'] = true;
                    alert('ã€30åˆ†å‰ã€‘\n' + item.text);
                }
                if (now >= start && now < start + 5 * 60 * 1000 && !key30[k + '_start']) {
                    key30[k + '_start'] = true;
                    alert('ã€é–‹å§‹ã€‘\n' + item.text);
                }
            });
            localStorage.setItem(REMEMBER_REMINDED_KEY, JSON.stringify(key30));
        }
        
        function updateLastFound() {
            const items = {
                'key': 'éµ',
                'wallet': 'è²¡å¸ƒ',
                'phone': 'ã‚¹ãƒãƒ›',
                'glasses': 'ãƒ¡ã‚¬ãƒ'
            };
            
            Object.keys(items).forEach(key => {
                const location = localStorage.getItem(`item_${key}_location`);
                const time = localStorage.getItem(`item_${key}_time`);
                const element = document.getElementById(`${key}-last`);
                
                if (element && location) {
                    element.textContent = `${location}`;
                }
            });
        }

        function findItem(item, emoji) {
            const itemKey = {
                'éµ': 'key',
                'è²¡å¸ƒ': 'wallet',
                'ã‚¹ãƒãƒ›': 'phone',
                'ãƒ¡ã‚¬ãƒ': 'glasses'
            }[item];
            
            const lastLocation = localStorage.getItem(`item_${itemKey}_location`);
            const lastTime = localStorage.getItem(`item_${itemKey}_time`);
            
            let message = `<h2 style="text-align: center;">${emoji} ${item}ã‚’æ¢ã™</h2>`;
            
            if (lastLocation) {
                message += `
                    <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <p style="font-size: 1.3em; text-align: center; color: #155724;">
                            <strong>å‰å›è¦‹ã¤ã‘ãŸå ´æ‰€</strong>
                        </p>
                        <p style="font-size: 1.5em; text-align: center; color: #155724; margin-top: 10px;">
                            ğŸ“ ${lastLocation}
                        </p>
                        <p style="text-align: center; color: #666; font-size: 0.9em; margin-top: 10px;">
                            ${lastTime}
                        </p>
                    </div>
                `;
            } else {
                message += `
                    <p style="text-align: center; color: #666; margin: 20px 0;">
                        ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                    </p>
                `;
            }
            
            message += `
                <div style="margin-top: 20px;">
                    <p style="text-align: center; color: #666; margin-bottom: 15px;">
                        ã‚ˆãã‚ã‚‹å ´æ‰€ã‚’ãƒã‚§ãƒƒã‚¯ï¼š
                    </p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="alert('ç„é–¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸšª ç„é–¢</button>
                        <button onclick="alert('ãƒªãƒ“ãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸ›‹ï¸ ãƒªãƒ“ãƒ³ã‚°</button>
                        <button onclick="alert('å¯å®¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸ›ï¸ å¯å®¤</button>
                        <button onclick="alert('æ´—é¢æ‰€ãƒ»ãŠé¢¨å‘‚ã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸš¿ æ´—é¢æ‰€</button>
                        <button onclick="alert('ã‚­ãƒƒãƒãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸ³ ã‚­ãƒƒãƒãƒ³</button>
                        <button onclick="alert('ã‚«ãƒãƒ³ã‚„ãƒã‚±ãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„')" style="padding: 15px; font-size: 1.2em; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">ğŸ‘œ ã‚«ãƒãƒ³ãƒ»ãƒã‚±ãƒƒãƒˆ</button>
                    </div>
                </div>
                
                <button onclick="recordItemFound('${item}', '${itemKey}', '${emoji}')" style="width: 100%; padding: 20px; font-size: 1.5em; background: #28a745; color: white; border: none; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                    âœ… è¦‹ã¤ã‘ãŸï¼å ´æ‰€ã‚’è¨˜éŒ²
                </button>
            `;
            
            showGeneralModal(message);
        }
        
        function recordItemFound(item, itemKey, emoji) {
            const location = prompt(`${emoji} ${item}ã‚’ã©ã“ã§è¦‹ã¤ã‘ã¾ã—ãŸã‹ï¼Ÿ\n\nä¾‹: ç„é–¢ã€ãƒªãƒ“ãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã€å¯å®¤`);
            
            if (location) {
                const now = new Date();
                const timeStr = now.toLocaleString('ja-JP', { 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                localStorage.setItem(`item_${itemKey}_location`, location);
                localStorage.setItem(`item_${itemKey}_time`, timeStr);
                
                alert(`âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼\n\n${emoji} ${item}\nğŸ“ ${location}\nğŸ• ${timeStr}`);
                closeGeneralModal();
            }
        }

        // å®¶æ—ã«é›»è©±
        function callFamily() {
            const family1Name = localStorage.getItem('family1Name') || 'å®¶æ—1';
            const family1Phone = localStorage.getItem('family1Phone') || '';
            const family2Name = localStorage.getItem('family2Name') || 'å®¶æ—2';
            const family2Phone = localStorage.getItem('family2Phone') || '';
            const clinicName = localStorage.getItem('clinicName') || 'ã‚¯ãƒªãƒ‹ãƒƒã‚¯';
            const clinicPhone = localStorage.getItem('clinicPhone') || '';
            
            const message = `
                <h2 style="text-align: center;">ğŸ“ é›»è©±ã‚’ã‹ã‘ã‚‹</h2>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">
                    èª°ã«é›»è©±ã—ã¾ã™ã‹ï¼Ÿ
                </p>
                <div style="display: grid; gap: 10px;">
                    ${family1Phone ? `<button onclick="makeCall('${family1Name}', '${family1Phone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ff9a9e; cursor: pointer;">ğŸ‘¨ ${family1Name}</button>` : ''}
                    ${family2Phone ? `<button onclick="makeCall('${family2Name}', '${family2Phone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ff9a9e; cursor: pointer;">ğŸ‘© ${family2Name}</button>` : ''}
                    ${clinicPhone ? `<button onclick="makeCall('${clinicName}', '${clinicPhone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #a8edea; cursor: pointer;">ğŸ¥ ${clinicName}</button>` : ''}
                </div>
                ${!family1Phone && !family2Phone && !clinicPhone ? '<p style="text-align: center; color: #999; margin-top: 20px;">é€£çµ¡å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>è¨­å®šç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>' : ''}
                <p style="text-align: center; margin-top: 20px; color: #999;">â€»é€£çµ¡å…ˆã¯è¨­å®šã§å¤‰æ›´ã§ãã¾ã™</p>
            `;
            showGeneralModal(message);
        }

        function makeCall(name, phone) {
            if (confirm(`${name}ã«é›»è©±ã‚’ã‹ã‘ã¾ã™ã‹ï¼Ÿ`)) {
                window.location.href = `tel:${phone}`;
            }
        }

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showGeneralModal(content) {
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('generalModal').classList.add('active');
        }

        function closeGeneralModal() {
            document.getElementById('generalModal').classList.remove('active');
        }

        // è¨­å®šç”»é¢ã‚’é–‹ã
        function openSettings() {
            window.location.href = 'settings.html';
        }

        // QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        function showQRCode() {
            const appUrl = window.location.origin + window.location.pathname;
            // QR Code APIã‚’ä½¿ç”¨ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(appUrl)}`;
            
            const message = `
                <h2 style="text-align: center;">ğŸ“± ã‚¢ãƒ—ãƒªã®QRã‚³ãƒ¼ãƒ‰</h2>
                <p style="text-align: center; color: #666; margin: 20px 0;">
                    ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ›ã§èª­ã¿å–ã‚‹ã¨<br>ã‚¢ãƒ—ãƒªã‚’é–‹ã‘ã¾ã™
                </p>
                <img src="${qrCodeUrl}" alt="QRã‚³ãƒ¼ãƒ‰" style="width: 300px; height: 300px; margin: 20px auto; display: block; border-radius: 10px; border: 2px solid #ddd;">
                <p style="text-align: center; font-size: 0.9em; color: #999; word-break: break-all;">
                    ${appUrl}
                </p>
                <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.95em;">
                    ğŸ’¡ ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã—ã¦<br>
                    ã”å®¶æ—ã«å…±æœ‰ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™
                </p>
            `;
            showGeneralModal(message);
        }

        // åœ°å›³ã‚¢ãƒ—ãƒªã‚’é–‹ã
        function openMapsApp() {
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (window.currentLocation) {
                // ä½ç½®æƒ…å ±ãŒã‚ã‚‹å ´åˆ
                const { lat, lon } = window.currentLocation;
                if (isIOS) {
                    // iPhoneã®å ´åˆ: Apple Maps
                    window.open(`maps://?q=${lat},${lon}`, '_blank');
                } else {
                    // Android/PCã®å ´åˆ: Google Maps
                    window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
                }
            } else {
                // ä½ç½®æƒ…å ±ãŒãªã„å ´åˆ: ç¾åœ¨åœ°ã‚’é–‹ã
                if (isIOS) {
                    window.open('maps://', '_blank');
                } else {
                    window.open('https://www.google.com/maps', '_blank');
                }
            }
        }

        // åˆæœŸåŒ–
        updateTime();
        updateLocation();
        setInterval(updateTime, 1000);
        setInterval(updateLocation, 60000); // 1åˆ†ã”ã¨ã«ä½ç½®æƒ…å ±æ›´æ–°

        renderRememberPreview();
        setInterval(renderRememberPreview, 60000); // 1åˆ†ã”ã¨ã«é€²è¡Œä¸­ï¼ˆèµ¤ï¼‰ã‚’æ›´æ–°
        checkRememberReminders();
        setInterval(checkRememberReminders, 60 * 1000); // 1åˆ†ã”ã¨ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ç¢ºèª

        // æœè–¬æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆèµ·å‹•æ™‚ã¨10åˆ†ã”ã¨ï¼‰
        checkMedicineTime();
        setInterval(checkMedicineTime, 10 * 60 * 1000); // 10åˆ†ã”ã¨

        // æœè–¬æ™‚é–“ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function checkMedicineTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const doses = getMedicineDoses();
            const timeToMinutes = (timeStr) => {
                const [h, m] = (timeStr || '08:00').split(':').map(Number);
                return h * 60 + m;
            };
            let currentDose = null;
            let doseLabel = '';
            for (let i = 0; i < doses.length; i++) {
                const d = doses[i];
                if (Math.abs(currentTime - timeToMinutes(d.time)) <= 30) {
                    currentDose = d.key;
                    doseLabel = d.label + (d.timing !== 'other' ? 'ï¼ˆ' + getTimingLabel(d.timing) + 'ï¼‰' : '');
                    break;
                }
            }
            if (currentDose) {
                const today = now.toISOString().split('T')[0];
                const recordKey = `medicine_${currentDose}_${today}`;
                const taken = localStorage.getItem(recordKey);
                const notifiedKey = `notified_${currentDose}_${today}`;
                const alreadyNotified = localStorage.getItem(notifiedKey);
                if (!taken && !alreadyNotified) {
                    localStorage.setItem(notifiedKey, 'true');
                    setTimeout(() => {
                        if (confirm(`ğŸ’Š ${doseLabel}ã®ãŠè–¬ã®æ™‚é–“ã§ã™ã€‚\n\nãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ`)) {
                            recordMedicine(currentDose);
                        }
                    }, 1000);
                }
            }
        }

        // PWAå¯¾å¿œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Workerç™»éŒ²ãªã—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã¯ç„¡åŠ¹ï¼‰');
            });
        }

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãªå ´åˆã¯é€šçŸ¥ï¼ˆåˆå›ã®ã¿ï¼‰
            if (!localStorage.getItem('installPromptShown')) {
                setTimeout(() => {
                    if (confirm('ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã„ã¤ã§ã‚‚ç°¡å˜ã«èµ·å‹•ã§ãã¾ã™ï¼‰')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            localStorage.setItem('installPromptShown', 'true');
                            deferredPrompt = null;
                        });
                    } else {
                        localStorage.setItem('installPromptShown', 'true');
                    }
                }, 3000);
            }
        });
    </script>
</body>
</html>
