<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .info-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .time-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3.5em;
            font-weight: bold;
            color: #667eea;
            line-height: 1.2;
        }

        .current-date {
            font-size: 1.8em;
            color: #555;
            margin-top: 10px;
        }

        .location-display {
            text-align: center;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 15px;
            margin-top: 20px;
        }

        .location-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .location-text {
            font-size: 1.3em;
            color: #333;
            line-height: 1.6;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .action-button {
            background: white;
            border: none;
            border-radius: 15px;
            padding: 25px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .action-button .icon {
            font-size: 1.8em;
        }

        .home-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 1.8em;
            padding: 30px;
        }

        .video-button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .photo-button {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .medicine-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .find-button {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .call-button {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .loading {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            padding: 10px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-close {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.5em;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
        }

        .photo-preview {
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #sendPhotoBtn {
            background: #30cfd0;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.3em;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ™‚é–“ãƒ»å ´æ‰€æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="info-panel">
            <div class="time-display">
                <div class="current-time" id="currentTime">--:--</div>
                <div class="current-date" id="currentDate">----å¹´--æœˆ--æ—¥</div>
            </div>
            
            <div class="location-display">
                <div class="location-icon">ğŸ“</div>
                <div class="location-text" id="locationText">
                    <div class="loading">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="button-grid">
            <button class="action-button home-button" onclick="goHome()">
                <span class="icon">ğŸ </span>
                <span>å®¶ã«å¸°ã‚‹</span>
            </button>

            <button class="action-button video-button" onclick="watchVideo()">
                <span class="icon">ğŸ“¹</span>
                <span>å‹•ç”»ã‚’è¦‹ã‚‹</span>
            </button>

            <button class="action-button photo-button" onclick="takePhoto()">
                <span class="icon">ğŸ“¸</span>
                <span>å†™çœŸã‚’æ’®ã£ã¦é€ã‚‹</span>
            </button>

            <button class="action-button medicine-button" onclick="showMedicine()">
                <span class="icon">ğŸ’Š</span>
                <span>è–¬ã®æ™‚é–“</span>
            </button>

            <button class="action-button find-button" onclick="findThings()">
                <span class="icon">ğŸ”</span>
                <span>ç‰©ã‚’æ¢ã™</span>
            </button>

            <button class="action-button call-button" onclick="callFamily()">
                <span class="icon">ğŸ“</span>
                <span>å®¶æ—ã«é›»è©±</span>
            </button>

            <button class="action-button" onclick="openSettings()" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color: #333;">
                <span class="icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </button>
        </div>

        <!-- QRã‚³ãƒ¼ãƒ‰ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± -->
        <div class="info-panel" style="margin-top: 20px; text-align: center; padding: 20px;">
            <button onclick="showQRCode()" style="background: white; border: 2px solid #667eea; color: #667eea; padding: 15px 30px; border-radius: 10px; font-size: 1.2em; cursor: pointer; width: 100%;">
                ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            </button>
            <p style="margin-top: 15px; color: white; font-size: 0.9em;">
                ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1.0.1 (2026-02-07)
            </p>
        </div>
    </div>

    <!-- å†™çœŸæ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="photoModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">å†™çœŸã‚’æ’®ã‚Šã¾ã™</h2>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="photoPreview" class="photo-preview" style="display: none;">
            <button id="captureBtn" onclick="capturePhoto()" style="background: #30cfd0; color: white; border: none; border-radius: 10px; padding: 15px; font-size: 1.3em; margin-top: 10px; cursor: pointer; width: 100%;">ğŸ“¸ æ’®å½±ã™ã‚‹</button>
            <button id="sendPhotoBtn" onclick="sendPhoto()" style="display: none;">å®¶æ—ã«é€ã‚‹</button>
            <button class="modal-close" onclick="closePhotoModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="generalModal">
        <div class="modal-content">
            <div id="modalBody"></div>
            <button class="modal-close" onclick="closeGeneralModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // æ™‚åˆ»æ›´æ–°
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // ä½ç½®æƒ…å ±å–å¾—
        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // ä½ç½®æƒ…å ±ã‚’ä¿å­˜
                        window.currentLocation = { lat, lon };
                        
                        // ä½æ‰€ã‚’å–å¾—ï¼ˆOpenStreetMap Nominatim APIä½¿ç”¨ï¼‰
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ja`
                            );
                            const data = await response.json();
                            
                            let address = '';
                            if (data.address) {
                                const addr = data.address;
                                address = [
                                    addr.city || addr.town || addr.village || '',
                                    addr.suburb || addr.neighbourhood || '',
                                    addr.road || ''
                                ].filter(x => x).join('');
                            }
                            
                            document.getElementById('locationText').innerHTML = `
                                <strong>ç¾åœ¨åœ°</strong><br>
                                ${address || 'ä½æ‰€ã‚’å–å¾—ä¸­...'}<br>
                                <small style="color: #999;">ç·¯åº¦: ${lat.toFixed(4)}, çµŒåº¦: ${lon.toFixed(4)}</small>
                            `;
                        } catch (error) {
                            document.getElementById('locationText').innerHTML = `
                                <strong>ç¾åœ¨åœ°</strong><br>
                                ç·¯åº¦: ${lat.toFixed(4)}<br>
                                çµŒåº¦: ${lon.toFixed(4)}<br>
                                <small style="color: #999;">â€»æ­£ç¢ºãªä½æ‰€ã¯ãƒãƒƒãƒ—ã§ç¢ºèªã§ãã¾ã™</small>
                            `;
                        }
                    },
                    (error) => {
                        document.getElementById('locationText').innerHTML = `
                            <strong>ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“</strong><br>
                            <small>è¨­å®šã§ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„</small>
                        `;
                    }
                );
            }
        }

        // å®¶ã«å¸°ã‚‹
        function goHome() {
            const homeAddress = localStorage.getItem('homeAddress');
            
            if (!homeAddress) {
                alert('è‡ªå®…ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§è‡ªå®…ä½æ‰€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (window.currentLocation) {
                const { lat, lon } = window.currentLocation;
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${encodeURIComponent(homeAddress)}`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(homeAddress)}`, '_blank');
            }
        }

        // å‹•ç”»ã‚’è¦‹ã‚‹
        function watchVideo() {
            const message = `
                <h2 style="text-align: center;">ğŸ“¹ å‹•ç”»ã‚’è¦‹ã‚‹</h2>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">
                    ã©ã‚“ãªå‹•ç”»ã‚’è¦‹ã¾ã™ã‹ï¼Ÿ
                </p>
                <input type="text" id="videoSearch" placeholder="è¦‹ãŸã„å‹•ç”»ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; font-size: 1.2em; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 10px;">
                <button onclick="searchYouTube()" style="width: 100%; padding: 15px; font-size: 1.3em; border-radius: 10px; border: none; background: #fa709a; color: white; cursor: pointer; margin-bottom: 20px;">ğŸ” æ¤œç´¢ã™ã‚‹</button>
                <div style="display: grid; gap: 10px;">
                    <button onclick="playYouTube('ç™’ã—ã®éŸ³æ¥½')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸµ ç™’ã—ã®éŸ³æ¥½</button>
                    <button onclick="playYouTube('æ‡ã‹ã—ã„æ­Œ')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ¤ æ‡ã‹ã—ã„æ­Œ</button>
                    <button onclick="playYouTube('è‡ªç„¶ã®æ˜ åƒ')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸŒ¿ è‡ªç„¶ã®æ˜ åƒ</button>
                    <button onclick="playYouTube('çŒ«ã®å‹•ç”»')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ± çŒ«ã®å‹•ç”»</button>
                </div>
            `;
            showGeneralModal(message);
        }

        function searchYouTube() {
            const query = document.getElementById('videoSearch').value;
            if (query) {
                playYouTube(query);
            }
        }

        function playYouTube(query) {
            const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
            window.open(youtubeUrl, '_blank');
            closeGeneralModal();
        }

        // å†™çœŸæ’®å½±
        let stream = null;
        let capturedPhoto = null;

        async function takePhoto() {
            const modal = document.getElementById('photoModal');
            const video = document.getElementById('video');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                modal.classList.add('active');
                
                document.getElementById('captureBtn').style.display = 'block';
                document.getElementById('sendPhotoBtn').style.display = 'none';
                document.getElementById('photoPreview').style.display = 'none';
                video.style.display = 'block';
            } catch (err) {
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg');
            preview.src = capturedPhoto;
            
            video.style.display = 'none';
            preview.style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('sendPhotoBtn').style.display = 'block';
        }

        function sendPhoto() {
            const message = `
                <h2 style="text-align: center;">ğŸ“¸ å†™çœŸã‚’é€ã‚‹</h2>
                <img src="${capturedPhoto}" style="width: 100%; border-radius: 10px; margin: 20px 0;">
                <p style="font-size: 1.3em; text-align: center; margin-bottom: 20px;">
                    ã©ã“ã«é€ã‚Šã¾ã™ã‹ï¼Ÿ
                </p>
                <div style="display: grid; gap: 10px;">
                    <button onclick="sendViaLine()" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #06C755; color: white; cursor: pointer;">
                        ğŸ“± LINEã§é€ã‚‹
                    </button>
                    <button onclick="sendViaEmail()" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #4285F4; color: white; cursor: pointer;">
                        âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã§é€ã‚‹
                    </button>
                </div>
            `;
            
            closePhotoModal();
            showGeneralModal(message);
        }

        function sendViaLine() {
            // LINEã§å…±æœ‰ï¼ˆWebç‰ˆï¼‰
            // å®Ÿéš›ã«ã¯LINE Messaging APIã¾ãŸã¯LIFF SDKã‚’ä½¿ç”¨
            const text = 'å†™çœŸã‚’é€ã‚Šã¾ã™';
            const lineUrl = `https://line.me/R/share?text=${encodeURIComponent(text)}`;
            
            // ãƒ‡ãƒ¼ã‚¿URLã‚’Blobã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadPhoto();
            
            alert('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nLINEã‚’é–‹ã„ã¦å†™çœŸã‚’æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
            window.open(lineUrl, '_blank');
            closeGeneralModal();
        }

        function sendViaEmail() {
            // ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
            // å®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é€ä¿¡ã™ã‚‹ã‹ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
            downloadPhoto();
            
            const familyEmail = localStorage.getItem('familyEmail') || '';
            if (!familyEmail) {
                const email = prompt('å®¶æ—ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
                if (email) {
                    localStorage.setItem('familyEmail', email);
                    sendEmailWithPhoto(email);
                }
            } else {
                sendEmailWithPhoto(familyEmail);
            }
        }

        function sendEmailWithPhoto(email) {
            const subject = 'å†™çœŸã‚’é€ã‚Šã¾ã™';
            const body = 'å†™çœŸã‚’æ·»ä»˜ã—ã¾ã—ãŸã€‚';
            
            alert('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦å†™çœŸã‚’æ·»ä»˜ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            closeGeneralModal();
        }

        function downloadPhoto() {
            const link = document.createElement('a');
            link.download = `photo_${Date.now()}.jpg`;
            link.href = capturedPhoto;
            link.click();
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // è–¬ã®æ™‚é–“
        function showMedicine() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            
            // è¨­å®šã‹ã‚‰æœè–¬æ™‚é–“ã‚’å–å¾—
            const times = {
                morning: localStorage.getItem('medicineMorning') || '08:00',
                lunch: localStorage.getItem('medicineLunch') || '12:00',
                evening: localStorage.getItem('medicineEvening') || '18:00',
                night: localStorage.getItem('medicineNight') || '21:00'
            };
            
            // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const timeToMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const morningMin = timeToMinutes(times.morning);
            const lunchMin = timeToMinutes(times.lunch);
            const eveningMin = timeToMinutes(times.evening);
            const nightMin = timeToMinutes(times.night);
            
            // æ—¥ä»˜è¡¨ç¤º
            const dateStr = now.toLocaleDateString('ja-JP', { 
                month: 'long', 
                day: 'numeric',
                weekday: 'short'
            });
            
            let message = '<h2 style="text-align: center;">ğŸ’Š ãŠè–¬ã®ç®¡ç†</h2>';
            message += `<p style="text-align: center; color: #666; margin-bottom: 20px;">${dateStr}</p>`;
            
            // ç¾åœ¨ã®æœè–¬ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¤å®šï¼ˆå‰å¾Œ30åˆ†ï¼‰
            let currentDose = null;
            let doseLabel = '';
            
            if (Math.abs(currentTime - morningMin) <= 30) {
                currentDose = 'morning';
                doseLabel = 'æœ';
            } else if (Math.abs(currentTime - lunchMin) <= 30) {
                currentDose = 'lunch';
                doseLabel = 'æ˜¼';
            } else if (Math.abs(currentTime - eveningMin) <= 30) {
                currentDose = 'evening';
                doseLabel = 'å¤•æ–¹';
            } else if (Math.abs(currentTime - nightMin) <= 30) {
                currentDose = 'night';
                doseLabel = 'å¤œ';
            }
            
            // æœè–¬æ™‚é–“ã®å‰å¾Œ30åˆ†ã®å ´åˆ
            if (currentDose) {
                const today = now.toISOString().split('T')[0];
                const recordKey = `medicine_${currentDose}_${today}`;
                const taken = localStorage.getItem(recordKey);
                
                if (taken) {
                    message += `<div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <p style="font-size: 1.5em; text-align: center; color: #155724;">âœ… ${doseLabel}ã®ãŠè–¬</p>
                        <p style="text-align: center; color: #155724; margin-top: 10px;">é£²ã¿ã¾ã—ãŸï¼ï¼ˆ${taken}ï¼‰</p>
                    </div>`;
                } else {
                    message += `<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <p style="font-size: 1.8em; text-align: center; color: #856404;">ğŸ’Š ${doseLabel}ã®ãŠè–¬</p>
                        <p style="font-size: 1.3em; text-align: center; color: #856404; margin-top: 10px;">é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ</p>
                    </div>`;
                    
                    message += `<button onclick="recordMedicine('${currentDose}', '${doseLabel}')" style="width: 100%; padding: 20px; font-size: 1.5em; background: #28a745; color: white; border: none; border-radius: 10px; margin-bottom: 10px; cursor: pointer;">
                        âœ… é£²ã¿ã¾ã—ãŸ
                    </button>`;
                }
            }
            
            // ä»Šæ—¥ã®æœè–¬è¨˜éŒ²ã‚’è¡¨ç¤º
            message += '<div style="margin-top: 30px;"><h3 style="text-align: center; margin-bottom: 15px;">ä»Šæ—¥ã®è¨˜éŒ²</h3>';
            message += getMedicineRecordHTML();
            message += '</div>';
            
            // æ¬¡ã®æœè–¬æ™‚é–“ã‚’è¡¨ç¤º
            message += '<div style="margin-top: 30px; padding: 15px; background: #f8f9ff; border-radius: 10px;">';
            message += '<h3 style="text-align: center; margin-bottom: 10px;">æœ¬æ—¥ã®äºˆå®š</h3>';
            message += `<p style="text-align: center;">æœ: ${times.morning}</p>`;
            message += `<p style="text-align: center;">æ˜¼: ${times.lunch}</p>`;
            message += `<p style="text-align: center;">å¤•æ–¹: ${times.evening}</p>`;
            message += `<p style="text-align: center;">å¤œ: ${times.night}</p>`;
            message += '</div>';
            
            showGeneralModal(message);
        }
        
        // æœè–¬è¨˜éŒ²
        function recordMedicine(dose, label) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const recordKey = `medicine_${dose}_${today}`;
            
            localStorage.setItem(recordKey, timeStr);
            
            // å®¶æ—ã«é€šçŸ¥ã™ã‚‹ã‹ç¢ºèª
            const confirmNotify = confirm(`${label}ã®ãŠè–¬ã‚’é£²ã‚“ã ã“ã¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\n\nã”å®¶æ—ã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ`);
            
            if (confirmNotify) {
                notifyFamily(label, timeStr);
            } else {
                closeGeneralModal();
                showMedicine(); // ç”»é¢ã‚’æ›´æ–°
            }
        }
        
        // å®¶æ—ã¸ã®é€šçŸ¥
        function notifyFamily(dose, time) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const familyEmail = localStorage.getItem('familyEmail');
            const family1Phone = localStorage.getItem('family1Phone');
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { 
                year: 'numeric',
                month: 'long', 
                day: 'numeric'
            });
            
            const message = `
                <h2 style="text-align: center;">ğŸ“¤ å®¶æ—ã«é€šçŸ¥</h2>
                <p style="text-align: center; margin: 20px 0;">
                    ${userName}ã•ã‚“ãŒ<br>
                    ${dateStr}<br>
                    ${dose}ã®ãŠè–¬ã‚’${time}ã«é£²ã¿ã¾ã—ãŸ
                </p>
                <div style="display: grid; gap: 10px;">
                    ${familyEmail ? `<button onclick="sendMedicineEmail('${dose}', '${time}', '${dateStr}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #4285F4; color: white; cursor: pointer;">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã§é€ã‚‹</button>` : ''}
                    ${family1Phone ? `<button onclick="sendMedicineSMS('${dose}', '${time}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #06C755; color: white; cursor: pointer;">ğŸ“± LINEã§é€ã‚‹</button>` : ''}
                </div>
                <button onclick="closeGeneralModal(); showMedicine();" style="width: 100%; padding: 15px; font-size: 1.2em; background: #f0f0f0; color: #333; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer;">
                    é€šçŸ¥ã—ãªã„
                </button>
            `;
            
            showGeneralModal(message);
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã§æœè–¬é€šçŸ¥
        function sendMedicineEmail(dose, time, date) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const email = localStorage.getItem('familyEmail');
            const subject = `ã€æœè–¬è¨˜éŒ²ã€‘${userName}ã•ã‚“ãŒ${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸ`;
            const body = `${userName}ã•ã‚“ãŒã€${date} ${time}ã«${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸã€‚\n\nâ€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã€Œã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã€ã‚¢ãƒ—ãƒªã‹ã‚‰è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            closeGeneralModal();
        }
        
        // LINEã§æœè–¬é€šçŸ¥
        function sendMedicineSMS(dose, time) {
            const userName = localStorage.getItem('userName') || 'ã”æœ¬äºº';
            const text = `${userName}ã•ã‚“ãŒ${time}ã«${dose}ã®ãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸğŸ’Š`;
            const lineUrl = `https://line.me/R/share?text=${encodeURIComponent(text)}`;
            
            window.open(lineUrl, '_blank');
            closeGeneralModal();
        }
        
        // ä»Šæ—¥ã®æœè–¬è¨˜éŒ²HTML
        function getMedicineRecordHTML() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            const doses = [
                { key: 'morning', label: 'æœ', time: localStorage.getItem('medicineMorning') || '08:00' },
                { key: 'lunch', label: 'æ˜¼', time: localStorage.getItem('medicineLunch') || '12:00' },
                { key: 'evening', label: 'å¤•æ–¹', time: localStorage.getItem('medicineEvening') || '18:00' },
                { key: 'night', label: 'å¤œ', time: localStorage.getItem('medicineNight') || '21:00' }
            ];
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            doses.forEach(dose => {
                const recordKey = `medicine_${dose.key}_${today}`;
                const taken = localStorage.getItem(recordKey);
                
                if (taken) {
                    html += `<div style="background: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.2em;">âœ… ${dose.label}ï¼ˆ${dose.time}ï¼‰</span>
                        <span style="color: #155724; font-size: 0.9em;">${taken}</span>
                    </div>`;
                } else {
                    html += `<div style="background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.2em; color: #999;">â­• ${dose.label}ï¼ˆ${dose.time}ï¼‰</span>
                        <span style="color: #999; font-size: 0.9em;">æœªæœè–¬</span>
                    </div>`;
                }
            });
            
            html += '</div>';
            return html;
        }

        // ç‰©ã‚’æ¢ã™
        function findThings() {
            const message = `
                <h2 style="text-align: center;">ğŸ” ç‰©ã‚’æ¢ã™</h2>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">
                    æ¢ã—ãŸã„ç‰©ã‚’é¸ã‚“ã§ãã ã•ã„
                </p>
                <div style="display: grid; gap: 10px;">
                    <button onclick="findItem('éµ')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ”‘ éµ</button>
                    <button onclick="findItem('è²¡å¸ƒ')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ‘› è²¡å¸ƒ</button>
                    <button onclick="findItem('ã‚¹ãƒãƒ›')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ“± ã‚¹ãƒãƒ›</button>
                    <button onclick="findItem('ãƒ¡ã‚¬ãƒ')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ffecd2; cursor: pointer;">ğŸ‘“ ãƒ¡ã‚¬ãƒ</button>
                </div>
            `;
            showGeneralModal(message);
        }

        function findItem(item) {
            alert(`${item}ã‚’æ¢ã—ã¾ã™\nï¼ˆå®Ÿè£…æ™‚ã«ã¯AirTagãªã©ã®ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºï¼‰`);
        }

        // å®¶æ—ã«é›»è©±
        function callFamily() {
            const family1Name = localStorage.getItem('family1Name') || 'å®¶æ—1';
            const family1Phone = localStorage.getItem('family1Phone') || '';
            const family2Name = localStorage.getItem('family2Name') || 'å®¶æ—2';
            const family2Phone = localStorage.getItem('family2Phone') || '';
            const clinicName = localStorage.getItem('clinicName') || 'ã‚¯ãƒªãƒ‹ãƒƒã‚¯';
            const clinicPhone = localStorage.getItem('clinicPhone') || '';
            
            const message = `
                <h2 style="text-align: center;">ğŸ“ é›»è©±ã‚’ã‹ã‘ã‚‹</h2>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">
                    èª°ã«é›»è©±ã—ã¾ã™ã‹ï¼Ÿ
                </p>
                <div style="display: grid; gap: 10px;">
                    ${family1Phone ? `<button onclick="makeCall('${family1Name}', '${family1Phone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ff9a9e; cursor: pointer;">ğŸ‘¨ ${family1Name}</button>` : ''}
                    ${family2Phone ? `<button onclick="makeCall('${family2Name}', '${family2Phone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #ff9a9e; cursor: pointer;">ğŸ‘© ${family2Name}</button>` : ''}
                    ${clinicPhone ? `<button onclick="makeCall('${clinicName}', '${clinicPhone}')" style="padding: 20px; font-size: 1.3em; border-radius: 10px; border: none; background: #a8edea; cursor: pointer;">ğŸ¥ ${clinicName}</button>` : ''}
                </div>
                ${!family1Phone && !family2Phone && !clinicPhone ? '<p style="text-align: center; color: #999; margin-top: 20px;">é€£çµ¡å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>è¨­å®šç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>' : ''}
                <p style="text-align: center; margin-top: 20px; color: #999;">â€»é€£çµ¡å…ˆã¯è¨­å®šã§å¤‰æ›´ã§ãã¾ã™</p>
            `;
            showGeneralModal(message);
        }

        function makeCall(name, phone) {
            if (confirm(`${name}ã«é›»è©±ã‚’ã‹ã‘ã¾ã™ã‹ï¼Ÿ`)) {
                window.location.href = `tel:${phone}`;
            }
        }

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showGeneralModal(content) {
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('generalModal').classList.add('active');
        }

        function closeGeneralModal() {
            document.getElementById('generalModal').classList.remove('active');
        }

        // è¨­å®šç”»é¢ã‚’é–‹ã
        function openSettings() {
            window.location.href = 'settings.html';
        }

        // QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        function showQRCode() {
            const appUrl = window.location.origin + window.location.pathname;
            // QR Code APIã‚’ä½¿ç”¨ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(appUrl)}`;
            
            const message = `
                <h2 style="text-align: center;">ğŸ“± ã‚¢ãƒ—ãƒªã®QRã‚³ãƒ¼ãƒ‰</h2>
                <p style="text-align: center; color: #666; margin: 20px 0;">
                    ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ›ã§èª­ã¿å–ã‚‹ã¨<br>ã‚¢ãƒ—ãƒªã‚’é–‹ã‘ã¾ã™
                </p>
                <img src="${qrCodeUrl}" alt="QRã‚³ãƒ¼ãƒ‰" style="width: 300px; height: 300px; margin: 20px auto; display: block; border-radius: 10px; border: 2px solid #ddd;">
                <p style="text-align: center; font-size: 0.9em; color: #999; word-break: break-all;">
                    ${appUrl}
                </p>
                <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.95em;">
                    ğŸ’¡ ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã—ã¦<br>
                    ã”å®¶æ—ã«å…±æœ‰ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™
                </p>
            `;
            showGeneralModal(message);
        }

        // åˆæœŸåŒ–
        updateTime();
        updateLocation();
        setInterval(updateTime, 1000);
        setInterval(updateLocation, 60000); // 1åˆ†ã”ã¨ã«ä½ç½®æƒ…å ±æ›´æ–°

        // æœè–¬æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆèµ·å‹•æ™‚ã¨10åˆ†ã”ã¨ï¼‰
        checkMedicineTime();
        setInterval(checkMedicineTime, 10 * 60 * 1000); // 10åˆ†ã”ã¨

        // æœè–¬æ™‚é–“ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function checkMedicineTime() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 60 + minute;
            
            // è¨­å®šã‹ã‚‰æœè–¬æ™‚é–“ã‚’å–å¾—
            const times = {
                morning: localStorage.getItem('medicineMorning') || '08:00',
                lunch: localStorage.getItem('medicineLunch') || '12:00',
                evening: localStorage.getItem('medicineEvening') || '18:00',
                night: localStorage.getItem('medicineNight') || '21:00'
            };
            
            const timeToMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const morningMin = timeToMinutes(times.morning);
            const lunchMin = timeToMinutes(times.lunch);
            const eveningMin = timeToMinutes(times.evening);
            const nightMin = timeToMinutes(times.night);
            
            let currentDose = null;
            let doseLabel = '';
            
            // å‰å¾Œ30åˆ†ä»¥å†…ã‹ãƒã‚§ãƒƒã‚¯
            if (Math.abs(currentTime - morningMin) <= 30) {
                currentDose = 'morning';
                doseLabel = 'æœ';
            } else if (Math.abs(currentTime - lunchMin) <= 30) {
                currentDose = 'lunch';
                doseLabel = 'æ˜¼';
            } else if (Math.abs(currentTime - eveningMin) <= 30) {
                currentDose = 'evening';
                doseLabel = 'å¤•æ–¹';
            } else if (Math.abs(currentTime - nightMin) <= 30) {
                currentDose = 'night';
                doseLabel = 'å¤œ';
            }
            
            // æœè–¬æ™‚é–“ã§ã€ã¾ã é£²ã‚“ã§ã„ãªã„å ´åˆ
            if (currentDose) {
                const today = now.toISOString().split('T')[0];
                const recordKey = `medicine_${currentDose}_${today}`;
                const taken = localStorage.getItem(recordKey);
                const notifiedKey = `notified_${currentDose}_${today}`;
                const alreadyNotified = localStorage.getItem(notifiedKey);
                
                if (!taken && !alreadyNotified) {
                    localStorage.setItem(notifiedKey, 'true');
                    
                    // é€šçŸ¥è¡¨ç¤º
                    setTimeout(() => {
                        if (confirm(`ğŸ’Š ${doseLabel}ã®ãŠè–¬ã®æ™‚é–“ã§ã™ã€‚\n\nãŠè–¬ã‚’é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ`)) {
                            recordMedicine(currentDose, doseLabel);
                        }
                    }, 1000);
                }
            }
        }

        // PWAå¯¾å¿œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service Workerç™»éŒ²ãªã—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã¯ç„¡åŠ¹ï¼‰');
            });
        }

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãªå ´åˆã¯é€šçŸ¥ï¼ˆåˆå›ã®ã¿ï¼‰
            if (!localStorage.getItem('installPromptShown')) {
                setTimeout(() => {
                    if (confirm('ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã„ã¤ã§ã‚‚ç°¡å˜ã«èµ·å‹•ã§ãã¾ã™ï¼‰')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            localStorage.setItem('installPromptShown', 'true');
                            deferredPrompt = null;
                        });
                    } else {
                        localStorage.setItem('installPromptShown', 'true');
                    }
                }, 3000);
            }
        });
    </script>
</body>
</html>
